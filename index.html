<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CQC – PIN Portal (DEBUG BUILD)</title>
<script src=https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js></script>
<style>
/* ---------- core look & feel ---------- */
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;text-align:center;padding:40px}
h1,h2{margin:0 0 20px}
input,button,select,textarea{font-size:1rem;padding:10px;border:none;border-radius:6px}
input[type=password],input[type=text]{background:#111;color:#fff;letter-spacing:8px;width:160px;text-align:center}
button{cursor:pointer;background:#1e8c1e;color:#fff}
#status{margin-top:15px;font-weight:bold}
#welcome{margin-top:10px;font-size:1.2rem;color:#1e8c1e}
 
/* keypad */
#keypad{margin:25px auto 10px;display:grid;grid-template-columns:repeat(3,60px);gap:8px;justify-content:center}
#keypad .key{background:#333;color:#fff;border-radius:6px;font-size:1.1rem;padding:12px 0;user-select:none}
#keypad .wide{grid-column:span 2}
 
/* debug toggle */
#debugToggle{position:fixed;bottom:20px;left:20px;background:#444;border-radius:50%;width:46px;height:46px;font-size:22px;line-height:46px}
#debug{position:fixed;bottom:80px;left:20px;width:300px;max-height:50vh;overflow:auto;background:#111;padding:10px;border:1px solid #555;border-radius:8px;font-family:Consolas,monospace;font-size:.75rem;display:none}
#debug pre{margin:0;white-space:pre-wrap}
 
/* pages */
.page{display:none}
.active{display:block}
 
#qrCodeWrapper,#auditMsgWrapper,#doneScreen,#outputPage{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh}
 
/* upload page elements */
#visibleBulkInput{background:#fff;color:#000;border-radius:6px;padding:14px;font-size:1.25rem;width:90%;max-width:500px;border:2px solid #444;text-align:left}
@keyframes glowEdge{from{box-shadow:0 0 6px #1e8c1e}to{box-shadow:0 0 20px #1e8c1e}}
.scanning{animation:glowEdge .5s ease-in-out infinite alternate;border:2px solid #1e8c1e!important}
#uploadAnim,#progressAnim{display:none;flex-direction:column;align-items:center;margin-top:20px}
.spinner{width:80px;height:80px;border:10px solid #1e8c1e;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#uploadText{margin-top:12px;font-size:1.2rem;color:#1e8c1e;font-weight:bold}
#progressAnim .spinner{border-top-color:#fff}
#progressText{margin-top:14px;font-size:1.4rem;color:#fff;font-weight:bold}
 
/* raw JSON box */
#resultTable{width:90%;max-width:600px;color:#000;background:#fff;border-radius:6px;overflow:auto;font-family:Arial,sans-serif;font-size:.9rem;padding:10px}
#confirmBtn{margin-top:20px;padding:12px 24px;background:#1e8c1e;color:#fff;border-radius:6px;font-size:1rem}
 
/* --- ADDED (exactly as before) : + button & modal styles --- */
button.danger{background:#b30000}
#plusBtn{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;font-size:28px;padding:6px 0}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center}
#box{background:#222;padding:20px;border-radius:8px;width:90%;max-width:380px}
#box select,#box input{width:100%;margin:6px 0}
</style>
</head>
<body>
 
<!-- Page 1 – PIN -->
<div id="page1" class="page active">
  <h1>Enter 4-Digit PIN</h1>
  <input id="pin" type="password" maxlength="4" placeholder="****">
  <br><button id="submit">Submit</button>
  <div id="keypad">
    <button class="key">1</button><button class="key">2</button><button class="key">3</button>
    <button class="key">4</button><button class="key">5</button><button class="key">6</button>
    <button class="key">7</button><button class="key">8</button><button class="key">9</button>
    <button class="key wide" data-act="clear">C</button>
    <button class="key">0</button><button class="key wide" data-act="del">←</button>
  </div>
  <div id="status"></div><div id="welcome"></div>
</div>
 
<!-- Page 2 – BEGIN -->
<div id="page2" class="page">
  <div id="qrCodeWrapper"><div>Scan to begin</div><div id="qrCode"></div></div>
  <input id="hiddenScanner2" class="scanner" type="text" autocomplete="off">
</div>
 
<!-- Page 3 – Audit -->
<div id="page3" class="page">
  <div id="auditMsgWrapper">
    <h2 id="auditMsg">Audit in progress</h2>
    <div id="auditVisual" class="spinner" style="border-top-color:#0000"></div>
    <div id="qrCodeAudit" style="margin-top:20px;"></div>
  </div>
  <input id="hiddenScanner3" class="scanner" type="text" autocomplete="off">
</div>
 
<!-- Page 4 – Upload -->
<div id="page4" class="page">
  <div id="doneScreen">
    <h2>Scan here to upload:</h2>
    <div id="uploadQr"></div>
    <input id="visibleBulkInput" autocomplete="off">
    <div id="scanCount">No scans captured yet.</div>
    <button id="confirmBtn">Confirm</button>
    <div id="uploadAnim"><div class="spinner"></div><div id="uploadText">Uploading…</div></div>
    <div id="progressAnim"><div class="spinner"></div><div id="progressText">Processing…</div></div>
  </div>
</div>
 
<!-- Page 5 – Results -->
<div id="page5" class="page">
  <div id="outputPage">
    <h2>Scanned Items</h2>
    <div id="resultTable"></div>
  </div>
</div>
 
<!-- --- ADDED (exactly as before) : + button & modal markup --- -->
<button id="plusBtn">+</button>
<div id="modal">
  <div id="box">
    <h2>Create PIN</h2>
    <select id="userSel"></select>
    <input id="pin1" type="password" maxlength="4" placeholder="New PIN" />
    <input id="pin2" type="password" maxlength="4" placeholder="Confirm PIN" />
    <button id="save">Save PIN</button>
    <button class="danger" id="cancel">Cancel</button>
    <div id="modalMsg"></div>
  </div>
</div>
 
<!-- Debug -->
<div id="debug"><pre id="debugLog"></pre></div>
 
<!-- ONLY SHOWING CHANGED PARTS AT THE TOP FOR CLARITY -->
<script>
/* ---------- constants ---------- */
const FLOW_VALIDATE = https://prod-89.westeurope.logic.azure.com:443/workflows/f1639be7e1a441a4a97130cb087ebe28/triggers/manual/paths/invoke?api-version=2016-06-01&sp=/triggers/manual/run&sv=1.0&sig=LX2eGuTosv-wKZinDs7z4TkpNTZ3POLUvMiiXftISOE;
const FLOW_BASE = FLOW_VALIDATE; // unified flow
 
const $=id=>document.getElementById(id);
 
/* ---------- state ---------- */
let capturedScans=new Set();
let itemsData=[];
let loggedInUser=""; // NEW: store the validated user's name
 
/* ---------- debug ---------- */
function dbg(...m){const log=$("debugLog");log.textContent+=m.join(" ")+"\n";log.parentElement.scrollTop=log.parentElement.scrollHeight;}
if ($("debugToggle")) $("debugToggle").onclick=()=>{$("debug").style.display=$("debug").style.display==="none"?"block":"none";};
 
/* ---------- helpers ---------- */
function callFlow(mode,payload={}) {
  return fetch(`${FLOW_BASE}&mode=${mode}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({mode,...payload})
  }).then(r=>r.json());
}
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  $(id).classList.add("active");
}
 
/* ---------- PIN keypad ---------- */
document.querySelectorAll("#keypad .key").forEach(btn=>btn.onclick=()=>{
  const act=btn.dataset.act;
  if(act==="clear") $("pin").value="";
  else if(act==="del") $("pin").value=$("pin").value.slice(0,-1);
  else if($("pin").value.length<4) $("pin").value+=btn.textContent;
});
$("submit").onclick=async()=>{
  const p=$("pin").value.trim();
  if(p.length!==4||isNaN(p)){ $("status").textContent="❌ PIN must be 4 digits"; return; }
  $("status").textContent="Checking…";
  try{
    const d=await fetch(FLOW_VALIDATE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"validatePin",pin:p})}).then(r=>r.json());
    if(d.status==="success"){
      loggedInUser = d.user?.Name || ""; // NEW: capture StaffName for later upload
      $("status").textContent="✅";
      $("welcome").textContent= loggedInUser ? "Welcome, "+loggedInUser : "";
      setTimeout(()=>{
        showPage("page2");
        $("qrCode").innerHTML="";
        new QRCode("qrCode",{text:"BEGIN",width:200,height:200});
      },1000);
    } else {
      $("status").textContent="❌ Invalid";
    }
  }catch{
    $("status").textContent="❌ Network error";
  }
};
 
/* ---------- BEGIN scan & fetch items ---------- */
$("hiddenScanner2").addEventListener("keydown", async e=>{
  if(e.key==="Enter" && e.target.value.trim().toUpperCase()==="BEGIN"){
    e.target.value="";
    try {
      const items = await callFlow("listItems");  // fetch CQC_Items table
      itemsData = Array.isArray(items)? items : [];
      dbg("Fetched items:", itemsData.length);
    } catch(err){
      dbg("Error fetching items:", err);
    }
    showPage("page3");
    $("qrCodeAudit").innerHTML="";
    setTimeout(()=>{
      new QRCode("qrCodeAudit",{text:"DONE",width:200,height:200});
    },9000);
  }
});
 
/* ---------- DONE scan ---------- */
$("hiddenScanner3").addEventListener("keydown", e=>{
  if(e.key==="Enter" && e.target.value.trim().toUpperCase()==="DONE"){
    e.target.value="";
    showUploadPage();
  }
});
 
/* ---------- upload page ---------- */
function showUploadPage(){
  showPage("page4");
  $("uploadQr").innerHTML="";
  new QRCode("uploadQr",{text:"^&032&^",width:240,height:240});
  $("visibleBulkInput").value="";
  capturedScans.clear();
  renderScanCount();
}
 
function renderScanCount(){
  $("scanCount").textContent = capturedScans.size
    ? `${capturedScans.size} scan${capturedScans.size===1?"":"s"} captured`
    : "No scans captured yet.";
}
 
/* capture scans offline */
$("visibleBulkInput").addEventListener("input", e=>{
  if(e.data?.includes("\n") || e.inputType==="insertLineBreak"){
    addMany(e.target.value);
    e.target.value="";
  }
});
$("visibleBulkInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addMany(e.target.value);
    e.target.value="";
  }
});
 
function addMany(text){
  (text.match(/\d{10}/g)||[]).forEach(c=>capturedScans.add(c));
  renderScanCount();
}
 
/* confirm button uploads IDs and shows table */
$("confirmBtn").onclick = async () => {
  if (!capturedScans.size) return;
  $("confirmBtn").disabled = true;
  $("uploadAnim").style.display = "flex";
 
  const checksPayload = [...capturedScans].map(scanId => {
    const match = itemsData.find(item => String(item.ItemID) === scanId) || {};
    return {
      ScanID: "SCAN-" + scanId,
      ItemID: scanId,
      ItemName: match.ItemName || "Unknown",
      Room: match.Room || "Unknown",
      CheckType: "Audit",
      CheckValue: "Checked"
    };
  });
 
  const payload = {
    SessionID: "SESSION-" + Date.now(),
    StaffName: "PIN User",
    SubmittedAt: new Date().toISOString(),
    Comment: "Scans submitted via portal",
    Checks: checksPayload
  };
 
  try {
    const res = await callFlow("submitScan", payload);
    if (res?.status === "success") {
      renderResultTable();
      showPage("page5");
    } else {
      dbg("Upload error:", res);
      alert("Error submitting scans.");
    }
  } catch (err) {
    dbg("Upload exception:", err);
    alert("Upload failed.");
  } finally {
    $("uploadAnim").style.display = "none";
    $("confirmBtn").disabled = false;
  }
};
 
function renderResultTable(){
  const rows = [...capturedScans].map(id=>{
    const item = itemsData.find(x=>String(x.ItemID)===id) || {};
    return `<tr><td>${id}</td><td>${item.Room||''}</td></tr>`;
  }).join("");
  const table = `
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr><th style="border:1px solid #444;padding:8px;background:#eee;color:#000">Item ID</th>
            <th style="border:1px solid #444;padding:8px;background:#eee;color:#000">Room</th></tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>`;
  $("resultTable").innerHTML = table;
}
 
/* ---------- focus keep ---------- */
setInterval(()=>{
  ["hiddenScanner2","hiddenScanner3","visibleBulkInput"].forEach(id=>{
    $(id)?.focus();
  });
},500);
 
/* --- ADDED (exactly as before) : + button & modal logic --- */
const FLOW = FLOW_VALIDATE; // alias to match original modal code
 
$("plusBtn").onclick = async () => {
  $("modalMsg").textContent = "";
  $("pin1").value = $("pin2").value = "";
  $("userSel").innerHTML = "<option>Loading…</option>";
  $("modal").style.display = "flex";
 
  try {
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "getUsersWithoutPins" })
    });
    const d = await r.json();
    $("userSel").innerHTML = d.status === "success"
      ? d.users.map(u => `<option>${u.Name}</option>`).join("")
      : "<option>❌ Couldn't load users</option>";
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};
 
$("cancel").onclick = () => $("modal").style.display = "none";
 
$("save").onclick = async () => {
  const name = $("userSel").value;
  const p1 = $("pin1").value.trim(), p2 = $("pin2").value.trim();
  if (p1 !== p2 || p1.length !== 4 || isNaN(p1)) {
    $("modalMsg").textContent = "Pins must match & be 4 digits";
    return;
  }
 
// Pre-check: is this PIN already in use?
$("modalMsg").textContent = "Checking…";
try {
  const chk = await fetch(FLOW, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "validatePin", pin: p1 })
  });
  const chkData = await chk.json();
 
  // If validatePin says success, that PIN already exists in the system
  if (chkData && chkData.status === "success") {
    $("modalMsg").textContent = "❌ That PIN is already taken.";
    return;
  }
 
  // Not taken — proceed to save
  $("modalMsg").textContent = "Saving…";
  const r = await fetch(FLOW, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "addPin", name, pin: p1 })
  });
  const d = await r.json();
 
  const taken =
    (d && d.error === "PinAlreadyExists") ||
    (d && d.message && /already\s*(taken|exists)/i.test(String(d.message)));
 
  if (d && d.status === "success") {
    $("modalMsg").textContent = "✅ Saved";
    setTimeout(() => { $("modal").style.display = "none"; }, 1000);
  } else if (taken || r.status === 409) {
    $("modalMsg").textContent = "❌ That PIN is already taken.";
  } else {
    $("modalMsg").textContent = "❌ Error";
  }
} catch (e) {
  $("modalMsg").textContent = "Network error";
}
 
};
</script>
 
 
</body>
</html>
