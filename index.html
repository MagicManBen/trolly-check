<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ClinicAssure — Sites, Rooms, Items, Staff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script>
  (function(){
    // Allow manual override with ?noipad in the URL
    if (new URLSearchParams(location.search).has('noipad')) return;

    // Detect iPad:
    // 1) Older iPads include "iPad" in the user agent
    // 2) iPadOS 13+ reports as "Mac" but has touch support
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIpadUA = /\biPad\b/i.test(ua);
    const isIpadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // If we're on an iPad and not already on the iPad page, redirect
    if ((isIpadUA || isIpadOS) && !/indexIpad\.html$/i.test(location.pathname)) {
      location.replace('indexipad.html');
    }
  })();
  </script>
  <style>
    :root{
      --bg:#0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444;
      --card:#111317; --line:#272a30; --btn:#2a2f36; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .app.sidebar-collapsed{grid-template-columns:56px 1fr}
    .sidebar{background:var(--panel);border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh}
    .sidebar.collapsed .brand,
    .sidebar.collapsed .status,
    .sidebar.collapsed .nav{display:none}
    .collapse-btn{position:absolute;top:10px;right:10px;min-width:32px;padding:6px 8px}
    .sidebar{position:sticky}
    .brand{font-weight:800;font-size:18px;margin-bottom:12px}
    .status{font-size:12px;color:var(--muted);margin-bottom:16px}
    .nav button{width:100%;text-align:left;background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;margin-bottom:8px;cursor:pointer}
    .nav button.active{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    /* Grouped nav menus */
    .menu-toggle{font-weight:700}
    .submenu{display:none;margin:6px 0 10px 0;padding-left:8px;border-left:1px solid var(--line)}
    .submenu.open{display:block}
    .nav .submenu button{width:100%;text-align:left;background:#14171c;border-color:var(--line);margin:6px 0 0 0}
    .nav .submenu button.active{background:var(--accent);color:#04130a}
    .main{padding:18px 18px 80px}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    .btn.warn{background:var(--warn);border-color:transparent;color:#111}
    .btn.danger{background:var(--danger);border-color:transparent}
    .btn.small{padding:6px 8px;border-radius:8px;font-size:12px}
    input, select, textarea{background:#0f1216;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    textarea{min-height:70px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);background:#121419;position:sticky;top:0}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:10px 0 14px 0;background:linear-gradient(to bottom, rgba(0,0,0,.3), transparent)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#1e232b;font-size:12px}
    .right{display:flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    /* Full-screen login screen */
    .login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:2000;padding:20px}
    .login-screen .card{width:min(720px,92vw)}
    /* --- Login visual --- */
    .login-card{max-width:520px;margin:auto;padding:24px 24px 18px 24px}
    .brand-small{font-size:14px;color:var(--muted);font-weight:700;margin-bottom:6px}
    .login-title{font-size:28px;font-weight:900;margin:0 0 14px 0}
    .login-stack{display:flex;flex-direction:column;gap:10px}
    .login-stack input,.login-stack select{height:44px;font-size:15px}
    .login-primary{height:44px;width:100%;font-weight:800}
    .login-actions{display:flex;gap:10px;margin-top:10px}
    .btn.ghost{background:transparent;border:1px solid var(--line)}
    .btn.ghost:hover{background:#1a1f26}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f1216;border:1px solid var(--line);padding:10px 14px;border-radius:10px}
    .danger-text{color:var(--danger)}
    .success-text{color:var(--accent)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .hr{border-top:1px solid var(--line);margin:12px 0}
    .table-wrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--card);max-height:60vh;overflow:auto}
    .chip{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b;cursor:pointer}
    .chip:hover{background:#222}
    .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi > div{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .big{font-size:24px;font-weight:800}
    .right input[type="text"]{width:220px}
    .danger-row{background:rgba(239,68,68,.08)}
    .ok-row{background:rgba(34,197,94,.08)}
    /* --- DASHBOARD --- */
    .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .dash-title{font-weight:800;letter-spacing:.2px}
    .stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;position:relative;overflow:hidden}
    .stat-card .label{color:var(--muted);font-size:12px}
    .stat-card .value{font-size:26px;font-weight:900}
    .stat-card.ok::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(34,197,94,.18), transparent)}
    .stat-card.warn::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(245,158,11,.18), transparent)}
    .stat-card.danger::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(239,68,68,.18), transparent)}
    .ring{--p:0; width:64px;height:64px;border-radius:50%;background:
      conic-gradient(var(--accent) calc(var(--p)*1%), #222 0);
      display:grid;place-items:center;border:1px solid var(--line)}
    .ring .inner{width:46px;height:46px;border-radius:50%;background:#0f1216;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
    .ring.small{width:42px;height:42px}.ring.small .inner{width:30px;height:30px;font-size:11px}
    .status-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--accent)}
    .dot.soon{background:var(--warn)}
    .dot.late{background:var(--danger)}
    .list-mini{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto}
    .mini{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--card)}
    .mini:hover{background:#111317}
    .mini .left{display:flex;flex-direction:column}
    .mini .title{font-weight:700}
    .mini .sub{color:var(--muted);font-size:12px}
    .mini .right{display:flex;align-items:center;gap:10px}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.85}50%{opacity:1}}
    .glow-red{box-shadow:0 0 0 0 rgba(239,68,68,.5);animation:glowRed 2s ease-in-out infinite}
    @keyframes glowRed{0%{box-shadow:0 0 0 0 rgba(239,68,68,.55)}70%{box-shadow:0 0 24px 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .glow-amber{box-shadow:0 0 0 0 rgba(245,158,11,.5);animation:glowAmber 2s ease-in-out infinite}
    @keyframes glowAmber{0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}70%{box-shadow:0 0 24px 12px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}

    /* Standard amend→save affordances */
    .save-glow{box-shadow:0 0 0 0 rgba(34,197,94,.55);animation:glowGreen 2s ease-in-out infinite}
    @keyframes glowGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.55)}70%{box-shadow:0 0 24px 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .edit-pulse{border-color:var(--accent)!important;box-shadow:0 0 0 0 rgba(34,197,94,.45);animation:pulseGreen 1.8s ease-in-out infinite}
    @keyframes pulseGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}70%{box-shadow:0 0 20px 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}

    /* Desktop-friendly dashboard grid + extras */
    .hero-grid{display:grid;grid-template-columns:2fr 3fr;gap:12px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}
    .ring.lg{width:120px;height:120px}
    .ring.lg .inner{width:92px;height:92px;font-size:18px}
    .empty{color:var(--muted);padding:6px 0}
    .fade-in{animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @media (max-width:1100px){
      .hero-grid{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:repeat(2,1fr)}
    }

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:960px;width:min(960px,90vw);max-height:85vh;overflow:auto;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-full{width:min(1400px,96vw);height:92vh;display:flex;flex-direction:column}
    .modal-body{flex:1;overflow:auto;padding:8px 2px}
    .modal-header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding-bottom:10px;z-index:2}
    .title-lg{font-size:22px;font-weight:800}
    .title-lg.green{color:#39ff14}
    .modal-header.center-title{justify-content:center;text-align:center}
    .modal-header.center-title .right{position:absolute;right:20px;top:20px}
    .code-chip{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#0f1216}
    .modal .grid.cols-2{grid-template-columns:1.2fr 1fr}
    .modal input,.modal select,.modal textarea{font-size:16px}
    .modal .table-wrap{max-height:48vh}
    .modal .tools .btn.small{font-size:12px;padding:6px 8px}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="panel-login" class="login-screen">
    <div class="card login-card" id="panel-login-inner">
      <div class="brand-small">ClinicAssure</div>
      <h1 class="login-title" id="loginTitle">Sign in</h1>
      <div id="loginStack" class="login-stack">
        <input id="loginEmail" type="text" placeholder="email@example.com">
        <input id="loginPass" type="password" placeholder="Password">
        <button class="btn primary login-primary" id="doLogin">Sign in</button>
        <!-- Primary action for the two‑step "join existing" flow (shown only during join) -->
        <button class="btn primary login-primary hidden" id="joinPrimary">Continue</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:10px; min-height:20px"></div>
      <!-- extra fields shown only in Sign-up mode -->
      <div id="signupRow" class="login-stack hidden" style="margin-top:10px">
        <input id="signupName" type="text" placeholder="Your full name">
        <input id="signupSiteName" type="text" placeholder="Surgery name (creates a new site)">
        <button class="btn primary login-primary" id="doSignup">Create site & account</button>
      </div>
      <div id="signupConfirm" class="hidden" style="margin-top:12px">
        <div id="signupConfirmText" class="muted"></div>
        <div style="margin-top:10px">
          <button class="btn primary login-primary" id="gotoLogin">Sign in</button>
        </div>
      </div>
      <div id="loginActions" class="login-actions">
        <button class="btn ghost" id="toggleAuth">Register your surgery</button>
        <button class="btn ghost" id="forgotLink">Forgot password?</button>
        <button class="btn ghost" id="doSignupInvited">Create account (join existing)</button>
      </div>
    </div>
  </div>
  <div id="appRoot" class="app hidden">
    <aside class="sidebar">
      <button id="toggleSidebar" class="btn small collapse-btn" title="Collapse sidebar">⟨</button>
      <div class="brand">ClinicAssure</div>
      <div class="status">
        <div id="who">Not signed in</div>
        <div id="site" class="muted">—</div>
      </div>
      <div class="nav" id="sidebar">
        <button data-tab="tab-dashboard" onclick="showSection('dashboard')">Dashboard</button>

        <button class="menu-toggle" onclick="toggleSubmenu('surgery-setup-submenu')">Surgery Set Up</button>
        <div id="surgery-setup-submenu" class="submenu">
          <button data-tab="tab-rooms" onclick="showSection('rooms')">Rooms</button>
          <button data-tab="tab-types" onclick="showSection('check-types')">Check Types</button>
          <button data-tab="tab-items" onclick="showSection('items')">Items</button>
        </div>

        <button class="menu-toggle" onclick="toggleSubmenu('team-setup-submenu')">Team Set Up</button>
        <div id="team-setup-submenu" class="submenu">
          <button data-tab="tab-staff" onclick="showSection('staff')">Staff</button>
          <button data-tab="tab-teams" onclick="showSection('teams')">Teams</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <!-- MAIN APP PANEL -->
      <div id="panel-app">
        <div class="topbar">
          <div class="pill">Admin</div>
          <div class="right">
            <input id="globalSearch" type="text" placeholder="Global search…">
            <button class="btn" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="tab-dashboard">
          <div class="dash-header">
            <div class="dash-title">Overview</div>
          </div>

          <div class="hero-grid">
            <div class="card">
              <div class="row" style="gap:18px;align-items:center">
                <div class="ring lg" id="ringProgress"><div class="inner" id="ringInner">0%</div></div>
                <div>
                  <div class="muted">Scheduled checks</div>
                  <div class="dash-big" style="font-size:22px;font-weight:800;margin-top:4px" id="dashProgressText">—</div>
                  <div class="muted" style="font-size:12px;margin-top:6px">*of all scheduled items currently within their required window</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="stat-grid">
                <div class="stat-card ok fade-in">
                  <div class="label">OK</div>
                  <div class="value" id="statOk">—</div>
                </div>
                <div class="stat-card warn fade-in">
                  <div class="label">Due soon</div>
                  <div class="value" id="statSoon">—</div>
                </div>
                <div class="stat-card danger fade-in">
                  <div class="label">Overdue</div>
                  <div class="value" id="statLate">—</div>
                </div>
                <div class="stat-card fade-in">
                  <div class="label">Unscheduled</div>
                  <div class="value" id="statUnsch">—</div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div class="card">
              <div class="row" style="justify-content:space-between;align-items:center">
                <h3>Overdue</h3>
                <div class="status-badges" id="dashBadges"></div>
              </div>
              <div class="list-mini" id="dashOverdueBody"></div>
            </div>

            <div class="card">
              <h3>Due soon (next 7 days)</h3>
              <div class="list-mini" id="dashSoonBody"></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Due today</h3>
            <div class="list-mini" id="dashTodayBody"></div>
          </div>
        </section>

        <!-- ROOMS -->
        <section id="tab-rooms" class="hidden">
          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h3>Rooms</h3>
              <button class="btn small" id="openAddRoomModal" title="Add room">＋</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Owner</th><th>Actions</th></tr></thead>
                <tbody id="roomsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CHECK TYPES -->
        <section id="tab-types" class="hidden">
          <div class="card">
            <h3>Add check type</h3>
            <div class="grid cols-2">
              <input id="typeName" type="text" placeholder="Name (e.g., Date Check)">
              <button class="btn primary" id="addType">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Check types</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Team</th><th>Active</th><th>Actions</th></tr></thead>
                <tbody id="typesBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ITEMS CONFIGURATOR -->
        <section id="tab-items" class="hidden">
          <!-- ITEM PICKER FULL WIDTH -->
          <div class="card">
            <h3>Find & select an item</h3>
            <div class="row" style="margin-bottom:10px">
              <input id="itemSearch" type="text" placeholder="Search by code, name, room…">
              <button class="btn" id="refreshItems">Refresh</button>
            </div>
            <div class="table-wrap" style="max-height:42vh">
              <table>
                <thead><tr><th style="width:140px">Code</th><th>Name</th><th>Room</th><th></th></tr></thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Configuration Modal -->
          <div id="cfgModal" class="modal-overlay hidden">
            <div class="modal modal-full" role="document">
              <div class="modal-header center-title">
                <div>
                  <div class="title-lg green" id="cfgName">—</div>
                </div>
                <div class="right">
                  <button class="btn" id="cfgClose">Close</button>
                </div>
              </div>
              <div class="modal-body">
                <div id="itemConfig">
                  <div class="card" style="margin:0 0 10px 0">
                    <h3>Details</h3>
                    <div class="grid cols-2">
                      <div>
                        <div class="muted">Item ID (code)</div>
                        <div class="row" style="gap:8px">
                          <input id="cfgCodeInput" type="text" readonly>
                          <button class="btn small" id="cfgEnableEditCode">Change</button>
                        </div>
                      </div>
                      <div>
                        <div class="muted">Room</div>
                        <select id="cfgRoom"></select>
                      </div>
                      <div>
                        <div class="muted">Owner (team)</div>
                        <select id="cfgOwnerRole"></select>
                      </div>
                    </div>
                    <div class="row" style="margin-top:10px;justify-content:flex-start">
                      <button class="btn primary" id="cfgSaveDetails">Save details</button>
                      <span class="muted">Owner will be stored until we add first‑class support.</span>
                    </div>
                  </div>

                  <!-- Right column content replacing Check plan -->
                  <div class="grid cols-2" style="margin:0; gap:12px">
                    <div class="card">
                      <h3>Recent checks</h3>
                      <div id="recentChecks" class="list-mini"></div>
                    </div>
                    <div class="card">
                      <h3>Actions</h3>
                      <div class="grid cols-2">
                        <button class="btn" id="itemActionRename">Rename item</button>
                        <button class="btn warn" id="itemActionMove">Move to room…</button>
                        <button class="btn" id="itemActionToggleActive">Deactivate / Activate</button>
                        <button class="btn danger" id="itemActionDelete">Delete item</button>
                      </div>
                      <div class="muted" style="margin-top:8px">Deleting removes this item and its schedules/logs from your site.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OPTIONAL: legacy add/update + CSV import remain below for now -->
        </section>

        <!-- TEAMS -->
        <section id="tab-teams" class="hidden">
          <div class="card" id="inviteCard">
            <h3>Invite team member</h3>
            <div class="grid cols-3">
              <input id="inviteEmail" type="email" placeholder="name@nhs.net">
              <select id="inviteRole">
                <option value="member" selected>member</option>
                <option value="admin">admin</option>
              </select>
              <button class="btn primary" id="sendInvite">Send invite</button>
            </div>
            <div id="inviteMsg" class="muted" style="margin-top:6px"></div>
          </div>
          <div class="card">
            <h3>Add team</h3>
            <div class="row">
              <input id="teamName" type="text" placeholder="Team name (e.g., Nurses)">
              <button class="btn primary" id="addTeam">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Teams</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Name</th><th>Members</th><th>Add member</th><th>Actions</th></tr>
                </thead>
                <tbody id="teamsBody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- STAFF -->
        <section id="tab-staff" class="hidden">
          <div class="card">
            <h3>Add staff</h3>
            <div class="grid cols-3">
              <input id="staffName" type="text" placeholder="Full name">
              <select id="staffRole">
                <option value="staff">staff</option>
                <option value="admin">admin</option>
              </select>
              <button class="btn primary" id="addStaff">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Staff</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Role</th><th>Teams</th><th>PIN</th><th>Actions</th></tr></thead>
                <tbody id="staffBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AUDITS -->
        <section id="tab-audits" class="hidden">
          <div class="card">
            <h3>Audit log</h3>
            <div class="tools" style="margin-bottom:8px">
              <input id="auditSearch" type="text" placeholder="Search (name, item, code, type)">
              <button class="btn" id="refreshAudits">Refresh</button>
              <button class="btn" id="exportAudits">Export CSV</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>When</th><th>Staff</th><th>Code</th><th>Item</th><th>Room</th><th>Type</th><th>Value</th>
                  </tr>
                </thead>
                <tbody id="auditsBody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Room Items Modal -->
  <div id="roomItemsModal" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="title-lg" id="roomItemsTitle">Items in room</div>
        <div class="right"><button class="btn" id="roomItemsClose">Close</button></div>
      </div>
      <div class="modal-body">
        <div id="roomItemsList" class="list-mini"></div>
      </div>
    </div>
  </div>

  <!-- Add Room Modal -->
  <div id="addRoomModal" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="title-lg">Add room</div>
        <div class="right"><button class="btn" id="addRoomCancel">Close</button></div>
      </div>
      <div class="modal-body">
        <div class="grid cols-2">
          <div>
            <div class="muted">Room name</div>
            <input id="addRoomName" type="text" placeholder="e.g., Treatment Room 1">
          </div>
          <div>
            <div class="muted">Owner (staff, optional)</div>
            <select id="addRoomOwner"></select>
          </div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <button class="btn primary" id="addRoomSave">Add room</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    const INVITE_ENDPOINT = "/api/invite"; // Vercel serverless function path

    // ====== STATE ======
    const S = {
      user: null, profile: null, siteId: null,
      rooms: [], types: [], typesByCat: {}, items: [], staff: [], audits: [],
      dashStatus: [], dashSummary: [],
      teams: [], teamMembers: [], checkTypeTeams: [],
      typeTeamById: {}, typeTeamByName: {}
    };
    S.selectedItem = null;

    // ====== HELPERS ======
    function $(id){ return document.getElementById(id); }
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
    function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(_){ return s; } }
    function setActiveTab(id){
      document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $(id)?.classList.remove('hidden');
    }
    function updateKPIs(){
      $('kpiRooms').textContent = S.rooms.length;
      $('kpiTypes').textContent = S.types.length;
      $('kpiItems').textContent = S.items.length;
      $('kpiStaff').textContent = S.staff.length;
    }
    function buildTypesByCat(){
      S.typesByCat = {};
      for (const t of S.types.filter(x=>x.active !== false)){
        if (!S.typesByCat[t.category]) S.typesByCat[t.category] = [];
        S.typesByCat[t.category].push(t);
      }
      for(const k in S.typesByCat){ S.typesByCat[k].sort((a,b)=>a.name.localeCompare(b.name)); }
    }
    function fillItemPickers(){
      // Legacy form removed — safely bail if controls don't exist
      const rSel = $('itemRoom');
      const tSel = $('itemType');
      const catEl = $('itemCategory');
      if(!rSel || !tSel || !catEl) return;
      // Rooms
      rSel.innerHTML = '';
      const rOpt = (id, name)=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; rSel.appendChild(o); };
      const sortedRooms = [...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sortedRooms.length===0){ rOpt('', '(no rooms yet)'); } else { sortedRooms.forEach(r=>rOpt(r.id, r.name)); }
      // Types (by selected category)
      const cat = catEl.value || 'general';
      tSel.innerHTML = '';
      const types = S.typesByCat[cat] || S.typesByCat['general'] || [];
      if(types.length===0){
        const o=document.createElement('option'); o.value=''; o.textContent='(no types for '+cat+')'; tSel.appendChild(o);
      }else{
        for(const t of types){ const o=document.createElement('option'); o.value=t.name; o.textContent=t.name; tSel.appendChild(o); }
      }
    }
    function filterTextMatch(hay, needle){
      const n = (needle||'').trim().toLowerCase();
      if(!n) return true;
      return (hay||'').toString().toLowerCase().includes(n);
    }
    function download(filename, text){
      const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click();
    }

    function applyRoleGating(){
      const role = S.profile?.role || 'member';
      const isAdminish = role === 'owner' || role === 'admin';
      S.isAdminish = isAdminish;
      const pill = document.querySelector('.pill');
      if(pill) pill.textContent = isAdminish ? 'Admin' : 'Member';
      if(S.siteId){
        const siteEl = $('site');
        if(siteEl) siteEl.textContent = `Site ${S.siteId} • ${role}`;
      }
      const adminOnlyTabs = ['tab-rooms','tab-types','tab-items','tab-staff','tab-teams'];
      document.querySelectorAll('.nav button[data-tab]').forEach(b=>{
        const t = b.dataset.tab;
        if(adminOnlyTabs.includes(t)) b.classList.toggle('hidden', !isAdminish);
      });
      // Guard obvious add/export buttons
      ['addRoom','addType','addTeam','addStaff','exportAudits'].forEach(id=>{
        const el=$(id); if(el) el.classList.toggle('hidden', !isAdminish);
      });
      // Hide Invite card for non-admins
      const inv = $('inviteCard'); if(inv) inv.classList.toggle('hidden', !isAdminish);
    }

    async function ensureOwnerSiteBootstrap(){
      // If the user has no profile row yet, try to create a site from cached values
      const pendingSite = localStorage.getItem('pendingSiteName');
      const pendingName = localStorage.getItem('pendingFullName');
      if(!pendingSite) return false;
      try{
        const { data: siteRow, error: e1 } = await sb.from('sites')
          .insert({ name: pendingSite })
          .select('id')
          .single();
        if(e1) throw e1;
        await sb.from('profiles').insert({ user_id: S.user.id, site_id: siteRow.id, role: 'owner', full_name: pendingName||null });
        localStorage.removeItem('pendingSiteName');
        localStorage.removeItem('pendingFullName');
        S.siteId = siteRow.id; S.profile = { site_id: siteRow.id, role: 'owner', full_name: pendingName||null };
        applyRoleGating();
        return true;
      }catch(err){
        console.error(err);
        toast(err.message || 'Could not create site');
        return false;
      }
    }

    async function maybeAcceptInvite(){
      try{
        const { data: authData } = await sb.auth.getUser();
        const user = authData?.user;
        const email = (user?.email || '').toLowerCase();
        if(!user || !email) return false;

        // Do we already have a profile?
        const { data: prof } = await sb.from('profiles')
          .select('site_id, role, full_name')
          .eq('user_id', user.id)
          .maybeSingle();
        if(prof){
          S.profile = prof; S.siteId = prof.site_id;
          applyRoleGating();
          return true;
        }

        // Look up approval via RPC (bypasses RLS safely)
        const { data: invData, error: rpcErr } = await sb.rpc('check_site_invite', { p_email: email });
        if(rpcErr){ console.error(rpcErr); return false; }
        const invRow = Array.isArray(invData) ? invData[0] : invData;
        if(!invRow) return false;

        const siteId = invRow.site_id;
        const role = invRow.role || 'member';

        // Insert profile (requires profiles_self_insert_if_invited policy)
        const { error: insErr } = await sb.from('profiles').insert({
          user_id: user.id, site_id: siteId, role
        });
        if(insErr){
          console.error('insert profile failed', insErr);
          toast(insErr.message || 'Could not link your account to the surgery.');
          return false;
        }

        // Best-effort: mark invite accepted (ignore any policy errors)
        try{
          await sb.from('site_invites')
            .update({ status: 'accepted', accepted_at: new Date().toISOString() })
            .eq('site_id', siteId)
            .eq('email', email);
        }catch(_e){ /* ignore */ }

        S.profile = { site_id: siteId, role, full_name: null };
        S.siteId = siteId;
        applyRoleGating();
        return true;
      }catch(e){
        console.error(e);
        return false;
      }
    }

    function isPinSet(v){
      // Treat PIN as set when the plain pin column has a non-empty value
      // and is not the placeholder string 'EMPTY'.
      return typeof v === 'string' && v.trim() !== '' && v.trim().toUpperCase() !== 'EMPTY';
    }

    function openCfgModal(){ const m=$('cfgModal'); if(m) m.classList.remove('hidden'); }
    function closeCfgModal(){ const m=$('cfgModal'); if(m) m.classList.add('hidden'); }

    // Room items modal helpers
    function openRoomItemsModal(title, items){
      const m = $('roomItemsModal');
      const titleEl = $('roomItemsTitle');
      const list = $('roomItemsList');
      if(titleEl) titleEl.textContent = title || 'Items';
      if(list){
        if(!items || items.length===0){
          list.innerHTML = '<div class="empty">No items in this room</div>';
        }else{
          list.innerHTML = items.map(n => `<div class="mini"><div class="left"><div class="title">${n}</div></div></div>`).join('');
        }
      }
      if(m) m.classList.remove('hidden');
    }
    function closeRoomItemsModal(){ const m=$('roomItemsModal'); if(m) m.classList.add('hidden'); }

    // Sidebar collapse/expand
    function applySidebarState(){
      const collapsed = localStorage.getItem('sidebarCollapsed') === '1';
      const app = document.querySelector('.app');
      const side = document.querySelector('.sidebar');
      const btn = document.getElementById('toggleSidebar');
      if(app) app.classList.toggle('sidebar-collapsed', collapsed);
      if(side) side.classList.toggle('collapsed', collapsed);
      if(btn) btn.textContent = collapsed ? '⟩' : '⟨';
      if(btn) btn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar';
    }
    function toggleSidebar(){
      const collapsed = localStorage.getItem('sidebarCollapsed') === '1';
      localStorage.setItem('sidebarCollapsed', collapsed ? '0' : '1');
      applySidebarState();
    }
    document.getElementById('toggleSidebar')?.addEventListener('click', toggleSidebar);
    applySidebarState();

    // ====== INIT & AUTH ======
    async function init(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session){
        // Show separate login screen, hide the app completely
        $('panel-login')?.classList.remove('hidden');
        $('appRoot')?.classList.add('hidden');
        $('who').textContent = 'Not signed in';
        $('site').textContent = '—';
        return;
      }
      // Logged in → hide login, show app
      S.user = session.user;
      $('panel-login')?.classList.add('hidden');
      $('appRoot')?.classList.remove('hidden');
      $('who').textContent = S.user.email || 'Signed in';

      // Get profile -> site
      const { data: prof, error } = await sb.from('profiles').select('site_id, full_name, role').eq('user_id', S.user.id).limit(1);
      if(!prof || !prof.length){
        // Attempt to bootstrap a new owner/site if this was an owner registration
        const created = await ensureOwnerSiteBootstrap();
        if(!created){
          // If the user was invited, auto-attach them to the site
          const joined = await maybeAcceptInvite();
          if(!joined){
            $('site').textContent = 'No site profile';
            toast('No site linked to this user. If you were invited, create an account with that email and sign in.');
            return;
          }
        }
      } else {
        S.profile = prof[0];
        S.siteId = S.profile.site_id;
      }
      applyRoleGating();
      await refreshAll();
    }

    // Keep UI in sync with auth state and persist session across reloads
    sb.auth.onAuthStateChange((_event, _session) => {
      // Re-run init whenever auth state changes (sign in/out, token refresh)
      init();
    });

    async function refreshAll(){
      await Promise.all([
        loadRooms(), loadTypes(), loadItems(), loadStaff(), loadAudits(),
        loadCheckStatus(), loadCheckSummary(),
        loadTeams(), loadTeamMembers(), loadCheckTypeTeams()
      ]);
      buildTypesByCat();
      buildTypeTeamMap();
      fillItemPickers();
      renderRooms(); renderTypes(); renderItems(); renderStaff(); renderTeams(); renderAudits(); renderDashboard();
      updateKPIs();
    }
    async function loadCheckStatus(){
      const { data, error } = await sb.from('v_item_check_status')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashStatus = data||[]; else toast(error.message);
    }
    async function loadCheckSummary(){
      const { data, error } = await sb.from('v_item_check_summary')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashSummary = data||[]; else toast(error.message);
    }
    function relTime(toIso){
      const t = new Date(toIso).getTime();
      const now = Date.now();
      const diff = Math.round((t - now)/1000); // seconds
      const abs = Math.abs(diff);
      const d = Math.floor(abs/86400), h = Math.floor((abs%86400)/3600), m = Math.floor((abs%3600)/60);
      const base = d ? `${d}d ${h}h` : h ? `${h}h ${m}m` : `${m}m`;
      return diff >= 0 ? `in ${base}` : `${base} ago`;
    }
    function setRing(percent){
      const p = Math.max(0, Math.min(100, Math.round(percent)));
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      if(ring) ring.style.setProperty('--p', p);
      if(inner) inner.textContent = p + '%';
    }

    function animateNumber(el, to){
      if(!el) return;
      const from = parseInt(el.getAttribute('data-prev')||el.textContent||'0',10) || 0;
      const start = performance.now(), dur = 450;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const val = Math.round(from + (to-from)*t);
        el.textContent = val;
        if(t < 1) requestAnimationFrame(step); else el.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function setRingAnimated(percent){
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      const from = parseInt(inner?.getAttribute('data-prev')||'0',10) || 0;
      const to = Math.max(0, Math.min(100, Math.round(percent)));
      const start = performance.now(), dur = 650;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const p = Math.round(from + (to-from)*t);
        if(ring) ring.style.setProperty('--p', p);
        if(inner) inner.textContent = p + '%';
        if(t < 1) requestAnimationFrame(step); else inner?.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function renderDashboard(){
      // summary badges
      const byStatus = Object.fromEntries(S.dashSummary.map(r => [r.status, r.count]));
      const ok = byStatus.ok||0, soon = byStatus.due_soon||0, late = byStatus.overdue||0, uns = byStatus.unscheduled||0;
      // progress ring considers only scheduled items
      const scheduled = ok + soon + late;
      const pct = scheduled ? Math.round((ok / scheduled) * 100) : 0;
      setRingAnimated(pct);
      const progText = document.getElementById('dashProgressText');
      if(progText) progText.textContent = `${ok}/${scheduled} within window`;

      const badgeWrap = document.getElementById('dashBadges');
      if(badgeWrap){
        badgeWrap.innerHTML = `
          <span class="badge"><span class="dot ok"></span> OK ${ok}</span>
          <span class="badge"><span class="dot soon"></span> Due soon ${soon}</span>
          <span class="badge"><span class="dot late"></span> Overdue ${late}</span>
          <span class="badge"><span class="dot"></span> Unscheduled ${uns}</span>`;
      }
      animateNumber($('statOk'), ok);
      animateNumber($('statSoon'), soon);
      animateNumber($('statLate'), late);
      animateNumber($('statUnsch'), uns);

      // partition lists
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);

      const overdue = S.dashStatus.filter(x => x.status === 'overdue')
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));
      const dueSoon = S.dashStatus.filter(x => x.status === 'due_soon' && new Date(x.next_due_at) > todayEnd)
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at))
        .filter(x => (new Date(x.next_due_at) - todayEnd) <= 7*86400000); // next 7 days
      const dueToday = S.dashStatus.filter(x => {
        const d = new Date(x.next_due_at);
        return d >= todayStart && d <= todayEnd && (x.status === 'due_soon' || x.status === 'overdue');
      }).sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));

      function rowHTML(x, cls){
        const due = new Date(x.next_due_at);
        const ownerTeam = x.effective_team_name || S.typeTeamByName[x.check_type]?.name || '';
        const title = `${x.item_name} • ${x.check_type}`;
        const sub = `${x.room_name||''} • due ${due.toLocaleString()} • ${relTime(x.next_due_at)}`;
        const manageBtn = S.isAdminish ? `<button class="btn small" data-act="manageItem" data-code="${x.item_code}">Manage</button>` : '';
        return `<div class="mini ${cls}">
          <div class="left">
            <div class="title">${title}</div>
            <div class="sub">${sub}</div>
          </div>
          <div class="right">
            ${ownerTeam ? `<span class="tag" title="owner team">${ownerTeam}</span>` : ''}
            <div class="ring small" style="--p:0"><div class="inner" title="frequency">${x.frequency}</div></div>
            ${manageBtn}
          </div>
        </div>`;
      }

      const od = $('dashOverdueBody'); if(od) od.innerHTML = overdue.map(x => rowHTML(x, 'glow-red')).join('') || '<div class="empty">Nothing overdue 🎉</div>';
      const ds = $('dashSoonBody'); if(ds) ds.innerHTML = dueSoon.map(x => rowHTML(x, 'glow-amber')).join('') || '<div class="empty">Nothing due soon</div>';
      const td = $('dashTodayBody'); if(td) td.innerHTML = dueToday.map(x => rowHTML(x, 'pulse')).join('') || '<div class="empty">Nothing due today</div>';
    }

    // ====== LOADERS ======
    async function loadRooms(){
      const { data, error } = await sb.from('rooms').select('id,name,occupied_by').eq('site_id', S.siteId).order('name');
      if(!error) S.rooms = data||[]; else toast(error.message);
    }
    async function loadTypes(){
      const { data, error } = await sb.from('check_types').select('id,name,category,active').eq('site_id', S.siteId).order('name');
      if(!error) S.types = data||[]; else toast(error.message);
    }
    async function loadItems(){
      const { data, error } = await sb.from('v_items_admin')
        .select('id,site_id,item_id,item_name,category,active,room_id,room_name,default_check_type_id,default_check_type_name,comments')
        .eq('site_id', S.siteId).order('item_name');
      if(!error) S.items = data||[]; else toast(error.message);
    }
    async function loadStaff(){
      const { data, error } = await sb.from('kiosk_users').select('id,full_name,role,pin').eq('site_id', S.siteId).order('full_name');
      if(!error) S.staff = data||[]; else toast(error.message);
    }
    async function loadAudits(){
      const { data, error } = await sb.from('v_submission_detail')
        .select('*').eq('site_id', S.siteId).order('submitted_at', { ascending:false }).limit(200);
      if(!error) S.audits = data||[]; else toast(error.message);
    }

    async function loadTeams(){
      const { data, error } = await sb.from('teams')
        .select('id,name').eq('site_id', S.siteId).order('name');
      if(!error) S.teams = data||[]; else toast(error.message);
    }
    async function loadTeamMembers(){
      const { data, error } = await sb.from('team_members')
        .select('team_id,user_id').eq('site_id', S.siteId);
      if(!error) S.teamMembers = data||[]; else toast(error.message);
    }
    async function loadCheckTypeTeams(){
      const { data, error } = await sb.from('check_type_teams')
        .select('check_type_id,team_id').eq('site_id', S.siteId);
      if(!error) S.checkTypeTeams = data||[]; else toast(error.message);
      buildTypeTeamMap();
    }

    function buildTypeTeamMap(){
      S.typeTeamById = {}; S.typeTeamByName = {};
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t]));
      for(const m of (S.checkTypeTeams||[])){
        const team = teamById[m.team_id];
        if(team) S.typeTeamById[m.check_type_id] = team;
      }
      for(const t of (S.types||[])){
        const team = S.typeTeamById[t.id];
        if(team) S.typeTeamByName[t.name] = team;
      }
    }

    // ====== RENDERERS ======
    function renderRooms(){
      const tb=$('roomsBody'); tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      const staffOptions = ['<option value="">(none)</option>']
        .concat((S.staff||[]).map(s=>`<option value="${s.id}">${s.full_name}</option>`))
        .join('');

      for(const r of S.rooms){
        const ownerName = r.occupied_by ? (staffById[r.occupied_by] || '') : '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td data-cell="owner">
            <span class="owner-text">${ownerName || ''}</span>
            <select class="owner-select hidden">${staffOptions}</select>
          </td>
          <td class="tools">
            <button class="btn small" data-act="viewItems" data-id="${r.id}" data-room-name="${r.name}">View items</button>
            <button class="btn small" data-act="editOwner" data-id="${r.id}" data-mode="edit">Edit owner</button>
            <button class="btn small hidden" data-act="cancelOwner" data-id="${r.id}">Cancel</button>
            <button class="btn small" data-act="rename" data-id="${r.id}">Rename</button>
            <button class="btn small danger" data-act="del" data-id="${r.id}">Delete</button>
          </td>`;
        const sel = tr.querySelector('select.owner-select');
        if(sel) sel.value = r.occupied_by || '';
        tb.appendChild(tr);
      }
    }

    function renderTypes(){
      const tb=$('typesBody'); tb.innerHTML='';
      const teamOpts = ['<option value="">(none)</option>']
        .concat((S.teams||[]).map(t=>`<option value="${t.id}">${t.name}</option>`))
        .join('');
      for(const t of S.types){
        const selectedTeam = S.typeTeamById[t.id]?.id || '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>
            <select class="type-team-select" data-act="typeTeam" data-id="${t.id}">
              ${teamOpts}
            </select>
          </td>
          <td>${t.active===false?'<span class="danger-text">no</span>':'yes'}</td>
          <td class="tools">
            <button class="btn small" data-act="toggleType" data-id="${t.id}">${t.active===false?'Activate':'Deactivate'}</button>
            <button class="btn small" data-act="renameType" data-id="${t.id}">Rename</button>
            <button class="btn small danger" data-act="delType" data-id="${t.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
        const sel = tr.querySelector('select.type-team-select');
        if(sel) sel.value = selectedTeam;
      }
    }

    function renderTeams(){
      const tb=$('teamsBody'); if(!tb) return; tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      for(const team of (S.teams||[])){
        const members = (S.teamMembers||[]).filter(m=>m.team_id===team.id).map(m=>({ id:m.user_id, name:staffById[m.user_id]||'?' }));
        const memberChips = members.length
          ? members.map(m=>`<span class="chip" data-act="removeMember" data-team="${team.id}" data-user="${m.id}">${m.name} ✕</span>`).join(' ')
          : '<span class="muted">(no members)</span>';
        const nonMembers = (S.staff||[]).filter(s=>!members.some(m=>m.id===s.id));
        const addOpts = ['<option value="">Select staff…</option>']
          .concat(nonMembers.map(s=>`<option value="${s.id}">${s.full_name}</option>`)).join('');
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${team.name}</td>
          <td>${memberChips}</td>
          <td class="row" style="gap:8px">
            <select class="team-add-member" data-team="${team.id}">${addOpts}</select>
            <button class="btn small" data-act="addMember" data-team="${team.id}">Add</button>
          </td>
          <td class="tools">
            <button class="btn small" data-act="renameTeam" data-id="${team.id}">Rename</button>
            <button class="btn small danger" data-act="delTeam" data-id="${team.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderItems(){
      const q = $('itemSearch')?.value || $('globalSearch')?.value || '';
      const tb=$('itemsBody'); if(!tb) return; tb.innerHTML='';
      const rows = S.items.filter(r =>
        filterTextMatch(r.item_id, q) || filterTextMatch(r.item_name, q) || filterTextMatch(r.room_name, q)
      );
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.item_id}</td>
          <td>${r.item_name}</td>
          <td>${r.room_name||'<span class="muted">(none)</span>'}</td>
          <td class="tools">
            <button class="btn small" data-act="cfg" data-code="${r.item_id}">Configure</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    // Loader for single item's plan
    async function loadItemPlan(itemCode){
      // resolve item pk
      const it = S.items.find(x=>x.item_id===itemCode);
      if(!it){ S.selectedItemPlan=[]; return; }
      const { data, error } = await sb
        .from('item_allowed_types')
        .select('id, site_id, item_id, check_type_id, frequency, warn_before, required, active, check_types!inner(name)')
        .eq('site_id', S.siteId)
        .eq('item_id', it.id);
      if(error){ toast(error.message); S.selectedItemPlan=[]; return; }
      // map shape
      S.selectedItemPlan = (data||[]).map(d=>({
        id: d.id, check_type_id: d.check_type_id, check_type_name: d.check_types.name,
        frequency: d.frequency, warn_before: d.warn_before, required: d.required, active: d.active
      }));
    }
    // Configurator helpers/renderers
    function fillOwnerRoles(){
      // Now shows TEAMS instead of roles
      const sel=$('cfgOwnerRole'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); };
      mk('','(none)');
      const sortedTeams = [...(S.teams||[])].sort((a,b)=>a.name.localeCompare(b.name));
      sortedTeams.forEach(t=>mk(t.name, t.name));
    }
    function fillCfgRooms(){
      const sel=$('cfgRoom'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); };
      const sorted=[...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sorted.length===0) mk('', '(no rooms yet)'); else sorted.forEach(r=>mk(r.id,r.name));
    }

    function renderStaff(){
      const tb=$('staffBody'); tb.innerHTML='';
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t.name]));
      const teamsForUser = (uid)=> (S.teamMembers||[]).filter(m=>m.user_id===uid).map(m=>teamById[m.team_id]).filter(Boolean);
      for(const s of S.staff){
        const tnames = teamsForUser(s.id);
        const teamHtml = tnames.length ? tnames.map(n=>`<span class=\"tag\">${n}</span>`).join(' ') : '<span class=\"muted\">(none)</span>';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${s.full_name}</td>
          <td>${s.role}</td>
          <td>${teamHtml}</td>
          <td>${isPinSet(s.pin) ? 'set' : '<span class=\"muted\">not set</span>'}</td>
          <td class=\"tools\">
            <button class=\"btn small\" data-act=\"setPin\" data-id=\"${s.id}\">Set PIN</button>
            <button class=\"btn small\" data-act=\"renameStaff\" data-id=\"${s.id}\">Rename</button>
            <button class=\"btn small\" data-act=\"roleStaff\" data-id=\"${s.id}\">Change role</button>
            <button class=\"btn small danger\" data-act=\"delStaff\" data-id=\"${s.id}\">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderAudits(){
      const q=$('auditSearch').value||'';
      const tb=$('auditsBody'); tb.innerHTML='';
      const rows = S.audits.filter(r =>
        filterTextMatch(r.staff_name,q) || filterTextMatch(r.item_name,q) || filterTextMatch(r.scanned_code,q) || filterTextMatch(r.check_type,q)
      );
      for(const a of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(a.submitted_at)}</td>
          <td>${a.staff_name}</td>
          <td class="mono">${a.scanned_code}</td>
          <td>${a.item_name||''}</td>
          <td>${a.room||''}</td>
          <td>${a.check_type||''}</td>
          <td>${a.check_value||''}</td>`;
        tb.appendChild(tr);
      }
    }

    // ====== ACTIONS ======
    // Login
    $('doLogin').addEventListener('click', async ()=>{
      $('loginMsg').textContent = 'Signing in…';
      const email=$('loginEmail').value.trim(), password=$('loginPass').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ $('loginMsg').textContent = error.message; return; }
      $('loginMsg').textContent='';
      await init();
    });
    $('btnLogout').addEventListener('click', async ()=>{
      await sb.auth.signOut(); location.reload();
    });

    function setLoginTitle(text){
      const t = $('loginTitle') || document.querySelector('#panel-login .login-title');
      if(t) t.textContent = text;
    }
    // --- Auth mode toggle & helpers ---
    let authMode = 'login'; // or 'signup'
    function setAuthMode(mode){
      authMode = mode;
      const signupRow = $('signupRow');
      const loginStack = $('loginStack');
      const loginActions = $('loginActions');
      const confirmBlock = $('signupConfirm');
      if(confirmBlock) confirmBlock.classList.add('hidden');
      if(loginStack) loginStack.classList.remove('hidden');
      if(loginActions) loginActions.classList.remove('hidden');
      if (signupRow) signupRow.classList.toggle('hidden', mode !== 'signup');
      setLoginTitle(mode === 'signup' ? 'Register your surgery' : 'Sign in');
      const loginBtn = $('doLogin');
      if (loginBtn) loginBtn.classList.toggle('hidden', mode === 'signup');
      const t = $('toggleAuth');
      if (t) t.textContent = (mode === 'signup') ? 'Have an account? Sign in' : 'Register your surgery';
      const msg = $('loginMsg');
      if (msg) msg.textContent = '';
    }
    document.getElementById('toggleAuth')?.addEventListener('click', (e)=>{
      e.preventDefault(); setAuthMode(authMode === 'login' ? 'signup' : 'login');
    });
    // Default to login layout on first render
    setAuthMode('login');

    // --- Helper: load sites into select for signup ---
    // (removed - no longer used)

    // --- Sign up (email & password) ---
    document.getElementById('doSignup')?.addEventListener('click', async ()=>{
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value;
      const full_name = document.getElementById('signupName').value.trim();
      const site_name = (document.getElementById('signupSiteName')?.value || '').trim();
      const msg = document.getElementById('loginMsg');
      if (!email || !password) { msg.textContent = 'Enter email & password.'; return; }
      if (!site_name) { msg.textContent = 'Enter your surgery name.'; return; }
      msg.textContent = 'Creating account…';
      // Cache pending details for after email confirmation
      localStorage.setItem('pendingSiteName', site_name);
      localStorage.setItem('pendingFullName', full_name);
      const { data, error } = await sb.auth.signUp({ email, password });
      if (error) { msg.textContent = error.message; return; }
      // Show confirm panel and explain next step
      const loginStack = $('loginStack');
      const signupRow = $('signupRow');
      const loginActions = $('loginActions');
      const confirmBlock = $('signupConfirm');
      const confirmText = $('signupConfirmText');
      if(loginStack) loginStack.classList.add('hidden');
      if(signupRow) signupRow.classList.add('hidden');
      if(loginActions) loginActions.classList.add('hidden');
      if(confirmText) confirmText.textContent = `We\'ve sent a confirmation link to ${email}. After confirming, sign in here and we\'ll create your site “${site_name}” and set you as owner.`;
      if(confirmBlock) confirmBlock.classList.remove('hidden');
    });

    // Server-side invite check using SECURITY DEFINER RPC function.
    async function checkInvite(email){
      const e = (email||'').trim().toLowerCase();
      if(!e) return null;
      try{
        // Uses a SECURITY DEFINER SQL function that bypasses RLS
        const { data, error } = await sb.rpc('check_site_invite', { p_email: e });
        if(error) throw error;
        // data may be a single row or array depending on Supabase version; normalize
        const row = Array.isArray(data) ? (data[0]||null) : (data||null);
        if(!row) return null;
        return { site_id: row.site_id, role: row.role || 'member', site_name: row.site_name || '' };
      }catch(err){
        console.error('checkInvite RPC failed:', err);
        return null;
      }
    }
    // --- Sign up (invited member: join existing, TWO-STEP) ---
    (function(){
      let joinState = { step: 'start', email: '', siteId: null, siteName: '', role: 'member' };

      function setJoinMode(step, info){
        joinState = { ...joinState, step, ...(info||{}) };
        const msg = $('loginMsg');
        const loginStack = $('loginStack');
        const signupRow = $('signupRow');
        const loginBtn = $('doLogin');
        const passInput = $('loginPass');
        const actions = $('loginActions');
        const btnJoin = $('doSignupInvited');     // ghost link-style button in the footer row
        const btnJoinPrimary = $('joinPrimary');  // big green primary button inside the stack

        // reset visibility we control
        if (signupRow) signupRow.classList.add('hidden'); // never show owner sign-up here
        if (loginStack) loginStack.classList.remove('hidden');
        if (actions) actions.classList.remove('hidden');
        if (btnJoinPrimary) { btnJoinPrimary.classList.add('hidden'); btnJoinPrimary.dataset.step = 'start'; }
        if (msg) msg.textContent = '';

        if (step === 'start') {
          // Normal sign-in mode
          setLoginTitle('Sign in');
          if (passInput) { passInput.classList.remove('hidden'); passInput.placeholder = 'Password'; }
          if (loginBtn) loginBtn.classList.remove('hidden');
          if (btnJoin) { btnJoin.textContent = 'Create account (join existing)'; btnJoin.dataset.step = 'start'; }
          if (btnJoinPrimary) btnJoinPrimary.classList.add('hidden');
          return;
        }

        if (step === 'email') {
          // First step of join: email only
          setLoginTitle('Join existing surgery');
          if (passInput) passInput.classList.add('hidden'); // hide password prompt
          if (loginBtn)  loginBtn.classList.add('hidden');  // hide normal Sign in
          if (actions)   actions.classList.add('hidden');   // hide footer buttons while in join flow
          if (btnJoin)   { btnJoin.textContent = 'Create account (join existing)'; btnJoin.dataset.step = 'email'; } // leave dataset for safety
          if (btnJoinPrimary) { btnJoinPrimary.textContent = 'Continue'; btnJoinPrimary.dataset.step = 'email'; btnJoinPrimary.classList.remove('hidden'); }
          if (msg) msg.textContent = 'Enter your work email. We\'ll check it\'s approved.';
          return;
        }

        if (step === 'password') {
          // Second step of join: show surgery name + ask for password
          setLoginTitle('Join “' + (joinState.siteName || 'your surgery') + '”');
          if (passInput) { passInput.value=''; passInput.placeholder='Create a password'; passInput.classList.remove('hidden'); }
          if (loginBtn)  loginBtn.classList.add('hidden');  // still hide normal Sign in
          if (actions)   actions.classList.add('hidden');   // keep footer hidden during join flow
          if (btnJoin)   { btnJoin.textContent = 'Create account (join existing)'; btnJoin.dataset.step = 'password'; }
          if (btnJoinPrimary) { btnJoinPrimary.textContent = 'Create account'; btnJoinPrimary.dataset.step = 'password'; btnJoinPrimary.classList.remove('hidden'); }
          if (msg) msg.innerHTML = `Approved for <b>${joinState.siteName || ('Site ' + joinState.siteId)}</b>. Create a password to finish.`;
          return;
        }
      }

      // Start in neutral (login) mode
      setJoinMode('start');

      // Footer ghost button just switches into the join flow (email step)
      document.getElementById('doSignupInvited')?.addEventListener('click', ()=>{
        setJoinMode('email', { email: ($('loginEmail')?.value||'').trim().toLowerCase() });
      });

      // Primary button drives the two-step flow
      document.getElementById('joinPrimary')?.addEventListener('click', async ()=>{
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPass').value;
        const msg = document.getElementById('loginMsg');
        const step = $('joinPrimary')?.dataset.step || 'email';

        if (step === 'email') {
          if (!email) { msg.textContent = 'Enter your email.'; return; }
          msg.textContent = 'Checking approval…';
          try{
            const inv = await checkInvite(email);
            if(!inv){ msg.textContent = 'This email is not approved. Please contact your manager.'; return; }
            setJoinMode('password', { email, siteId: inv.site_id, siteName: inv.site_name, role: inv.role || 'member' });
          }catch(e){
            msg.textContent = e?.message || 'Could not check approval';
          }
          return;
        }

        if (step === 'password') {
          if (!email) { msg.textContent = 'Enter your email.'; return; }
          if (!password) { msg.textContent = 'Create a password.'; return; }
          msg.textContent = 'Creating account…';
          try{
            const redirectTo = `${location.origin}/thanks.html`;
            const { error } = await sb.auth.signUp({ email, password, options: { emailRedirectTo: redirectTo } });
            if (error) { msg.textContent = error.message; return; }
            // Switch UI to confirmation panel
            const loginStack = $('loginStack');
            const signupRow = $('signupRow');
            const loginActions = $('loginActions');
            const confirmBlock = $('signupConfirm');
            const confirmText = $('signupConfirmText');
            if(loginStack) loginStack.classList.add('hidden');
            if(signupRow) signupRow.classList.add('hidden');
            if(loginActions) loginActions.classList.add('hidden');
            if(confirmText) confirmText.textContent = `We\'ve sent a confirmation link to ${email}. After confirming, come back here and sign in. We\'ll link you automatically to “${joinState.siteName||('Site ' + joinState.siteId)}”.`;
            if(confirmBlock) confirmBlock.classList.remove('hidden');
          }catch(e){
            msg.textContent = e?.message || 'Sign-up failed';
          }
          return;
        }
      });

      // Make sure toggling back to normal login resets join flow
      document.getElementById('toggleAuth')?.addEventListener('click', ()=> setJoinMode('start'));
      document.getElementById('gotoLogin')?.addEventListener('click', ()=> setJoinMode('start'));
    })();
    // Invite team member button
    $('sendInvite')?.addEventListener('click', async ()=>{
      if(!S.isAdminish){ toast('Only admins can invite'); return; }
      const email = ($('inviteEmail')?.value||'').trim().toLowerCase();
      const role = ($('inviteRole')?.value||'member');
      if(!email) return toast('Email required');
      try{
        const invited_by = S.user?.id || null;
        const { error } = await sb.from('site_invites').insert({
          site_id: S.siteId, email, role, invited_by, status: 'pending'
        });
        if(error) throw error;

        $('inviteMsg').textContent = `Approved: ${email}. Ask them to open this site, click “Create account (join existing)”, sign up with that email, and they’ll be added automatically.`;
        $('inviteEmail').value = '';
        toast('Approved');
      }catch(err){
        $('inviteMsg').textContent = err.message || 'Invite failed';
        console.error(err);
      }
    });



    document.getElementById('gotoLogin')?.addEventListener('click', ()=>{
      setAuthMode('login');
    });

    // --- Forgot password (sends reset email) ---
    document.getElementById('forgotLink')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      setLoginTitle('Forgot password');
      const email = document.getElementById('loginEmail').value.trim();
      const msg = document.getElementById('loginMsg');
      if (!email) { msg.textContent = 'Enter your email first.'; return; }
      msg.textContent = 'Sending reset email…';
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
      msg.textContent = error ? error.message : 'If that email exists, a reset link has been sent.';
    });

    // Navigation
    // Expand/collapse submenu groups
    function toggleSubmenu(id){
      const panel = document.getElementById(id);
      if(!panel) return;
      const isOpen = panel.classList.toggle('open');
      const toggle = panel.previousElementSibling;
      if(toggle && toggle.classList.contains('menu-toggle')){
        toggle.setAttribute('aria-expanded', String(isOpen));
      }
    }
    // Section switching that also highlights the active nav button and ensures its group is open
    function showSection(key){
      const map = {
        'dashboard':'tab-dashboard',
        'rooms':'tab-rooms',
        'check-types':'tab-types',
        'items':'tab-items',
        'staff':'tab-staff',
        'teams':'tab-teams',
        'audits':'tab-audits'
      };
      const id = map[key] || key;
      // Switch content
      setActiveTab(id);
      // Highlight the corresponding nav button
      document.querySelectorAll('.nav button[data-tab]').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab === id);
      });
      // Ensure parent submenu is open
      const btn = document.querySelector(`.nav button[data-tab="${id}"]`);
      const parentSub = btn ? btn.closest('.submenu') : null;
      if(parentSub && !parentSub.classList.contains('open')){
        parentSub.classList.add('open');
        const toggle = parentSub.previousElementSibling;
        if(toggle && toggle.classList.contains('menu-toggle')){
          toggle.setAttribute('aria-expanded','true');
        }
      }
    }
    document.querySelectorAll('.nav button[data-tab]').forEach(b=>b.addEventListener('click', ()=> showSection((b.dataset.tab||'').replace('tab-',''))));
    $('btnRefresh').addEventListener('click', refreshAll);
    $('globalSearch').addEventListener('input', ()=>{ renderItems(); renderAudits(); });

    // Dashboard (quick adds removed) — guard in case old elements exist in cached HTML
    const _qaAddRoom = $('qaAddRoom');
    if(_qaAddRoom){ _qaAddRoom.addEventListener('click', ()=>{/* removed */}); }
    const _qaAddStaff = $('qaAddStaff');
    if(_qaAddStaff){ _qaAddStaff.addEventListener('click', ()=>{/* removed */}); }
    function openItemInForm(code){
      const it=S.items.find(x=>x.item_id===code);
      if(!it){ toast('Item not found'); return; }
      setActiveTab('tab-items');
      S.selectedItem = it;
      openCfgModal();
      $('cfgCodeInput').value = it.item_id;
      $('cfgCodeInput').readOnly = true;
      $('cfgName').textContent = it.item_name || '';
      // Reset Change button and input affordances
      const _btnEC = $('cfgEnableEditCode');
      if(_btnEC){
        _btnEC.textContent = 'Change';
        _btnEC.classList.remove('save-glow');
        _btnEC.dataset.mode = 'change';
      }
      $('cfgCodeInput').classList.remove('edit-pulse');
      fillCfgRooms();
      fillOwnerRoles();
      if(it.room_name) $('cfgRoom').value = it.room_name;
      $('cfgOwnerRole').value = '';
      renderRecentChecksForSelected();
      toast('Opened in configurator');
    }

    function renderRecentChecksForSelected(){
      const box = $('recentChecks'); if(!box) return;
      const it = S.selectedItem; if(!it){ box.innerHTML = '<div class="empty">No item selected</div>'; return; }
      const rows = (S.audits||[])
        .filter(a => (a.scanned_code === it.item_id) || (a.item_name === it.item_name))
        .sort((a,b)=> new Date(b.submitted_at) - new Date(a.submitted_at))
        .slice(0, 10);
      if(rows.length === 0){
        box.innerHTML = '<div class="empty">No recent checks</div>';
        return;
      }
      box.innerHTML = rows.map(a => `
        <div class="mini">
          <div class="left">
            <div class="title">${a.check_type||'Check'}</div>
            <div class="sub">${fmtDate(a.submitted_at)} • ${a.staff_name||'—'} • value: ${a.check_value||''}</div>
          </div>
          <div class="right">
            <span class="tag">${a.room||''}</span>
          </div>
        </div>
      `).join('');
    }

    // Item actions
    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('#itemActionRename, #itemActionMove, #itemActionToggleActive, #itemActionDelete');
      if(!b) return;
      if(!S.selectedItem){ toast('Open an item first'); return; }
      const it = S.selectedItem;

      if(b.id === 'itemActionRename'){
        const name = prompt('New item name', it.item_name || '');
        if(!name) return;
        const { error } = await sb.from('items').update({ item_name: name }).eq('id', it.id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadItems();
        S.selectedItem = S.items.find(x=>x.id===it.id) || S.selectedItem;
        $('cfgName').textContent = S.selectedItem.item_name;
        renderItems(); renderRecentChecksForSelected();
        toast('Item renamed');
        return;
      }

      if(b.id === 'itemActionMove'){
        $('cfgRoom')?.focus();
        toast('Pick a room on the left, then click "Save details".');
        return;
      }

      if(b.id === 'itemActionToggleActive'){
        const nextActive = !(it.active === false);
        const { error } = await sb.from('items').update({ active: !nextActive }).eq('id', it.id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadItems();
        S.selectedItem = S.items.find(x=>x.id===it.id) || S.selectedItem;
        renderItems();
        toast(S.selectedItem.active===false ? 'Item deactivated' : 'Item activated');
        return;
      }

      if(b.id === 'itemActionDelete'){
        if(!confirm('Delete this item and associated schedules/logs?')) return;
        const { error } = await sb.from('items').delete().eq('id', it.id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        closeCfgModal();
        await loadItems();
        renderItems(); updateKPIs();
        toast('Item deleted');
        return;
      }
    });

    // ====== Configure Panel Close Button ======
    // Ensure the "Close" button in the configure panel hides the panel and clears selectedItem state.
    const cfgCloseBtn = document.getElementById('cfgClose');
    if (cfgCloseBtn) {
      cfgCloseBtn.addEventListener('click', () => {
        closeCfgModal();
        S.selectedItem = null;
      });
    }
    // Dashboard manage buttons
    document.getElementById('tab-dashboard').addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-act="manageItem"]'); if(!b) return;
      const code=b.dataset.code; openItemInForm(code);
    });

    // Add Room modal helpers
    function openAddRoomModal(){
      const m = $('addRoomModal'); if(!m) return;
      // Fill owner select
      const sel = $('addRoomOwner');
      if(sel){
        sel.innerHTML = '';
        const mk=(v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); };
        mk('', '(none)');
        const sortedStaff = [...(S.staff||[])].sort((a,b)=> (a.full_name||'').localeCompare(b.full_name||''));
        sortedStaff.forEach(s=> mk(String(s.id), s.full_name));
      }
      const name = $('addRoomName'); if(name){ name.value=''; name.focus(); }
      m.classList.remove('hidden');
    }
    function closeAddRoomModal(){
      $('addRoomModal')?.classList.add('hidden');
    }
    $('openAddRoomModal')?.addEventListener('click', openAddRoomModal);
    $('addRoomCancel')?.addEventListener('click', closeAddRoomModal);
    $('addRoomSave')?.addEventListener('click', async ()=>{
      const name = ($('addRoomName')?.value||'').trim();
      const ownerVal = $('addRoomOwner')?.value || '';
      const owner = ownerVal ? Number(ownerVal) : null;
      if(!name){ toast('Enter a room name'); return; }
      const { error } = await sb.from('rooms').insert({ site_id:S.siteId, name, occupied_by: owner });
      if(error){ toast(error.message); return; }
      closeAddRoomModal();
      await loadRooms(); renderRooms(); fillItemPickers(); updateKPIs();
      toast('Room added');
    });
    $('roomsBody').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const id=Number(btn.dataset.id); const act=btn.dataset.act;
      const tr = btn.closest('tr');

      if(act==='viewItems'){
        // find room & items in that room
        const room = S.rooms.find(rr=>rr.id===id);
        const roomName = room?.name || btn.getAttribute('data-room-name') || 'Room';
        // Use either room_id or fallback to string match
        const items = (S.items||[])
          .filter(it => (it.room_id === id) || (it.room_name === roomName))
          .map(it => it.item_name);
        openRoomItemsModal(`Items in ${roomName}`, items);
        return;
      }

      if(act==='editOwner'){
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        const cancelBtn = tr.querySelector('button[data-act="cancelOwner"]');

        // Enter edit mode
        if(btn.dataset.mode !== 'save'){
          btn.dataset.mode = 'save';
          btn.textContent = 'Save';
          btn.classList.add('save-glow');
          sel.classList.remove('hidden');
          sel.classList.add('edit-pulse');
          text.classList.add('hidden');
          cancelBtn.classList.remove('hidden');
          sel.focus();
          return;
        }

        // Save mode
        const newOwner = sel.value ? Number(sel.value) : null;
        const { error } = await sb.from('rooms').update({ occupied_by: newOwner }).eq('id', id).eq('site_id', S.siteId);
        if(error){ toast(error.message); return; }
        await loadRooms();
        renderRooms();
        toast('Owner updated');
        return;
      }

      if(act==='cancelOwner'){
        const editBtn = tr.querySelector('button[data-act="editOwner"]');
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        editBtn.dataset.mode = 'edit';
        editBtn.textContent = 'Edit owner';
        editBtn.classList.remove('save-glow');
        sel.classList.add('hidden');
        sel.classList.remove('edit-pulse');
        text.classList.remove('hidden');
        btn.classList.add('hidden');
        return;
      }

      if(act==='rename'){
        const row=S.rooms.find(r=>r.id===id); const name=prompt('New room name', row?.name||''); if(!name) return;
        const { error } = await sb.from('rooms').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room renamed');
        return;
      }

      if(act==='del'){
        if(!confirm('Delete this room?')) return;
        const { error } = await sb.from('rooms').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room deleted');
        return;
      }
    });

    // Types tab
    $('addType').addEventListener('click', async ()=>{
      const name=$('typeName').value.trim(); const category=$('typeCategory').value;
      if(!name) return;
      const { error } = await sb.from('check_types').insert({ site_id:S.siteId, name, category, active:true });
      if(error) return toast(error.message);
      $('typeName').value=''; await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); updateKPIs(); toast('Type added');
    });
    $('typesBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==='toggleType'){
        const t=S.types.find(x=>x.id===id); const active = !(t?.active===false);
        const { error } = await sb.from('check_types').update({ active: !active }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type toggled');
      }
      if(act==='renameType'){
        const t=S.types.find(x=>x.id===id); const name=prompt('New type name', t?.name||''); if(!name) return;
        const { error } = await sb.from('check_types').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type renamed');
      }
      if(act==='delType'){
        if(!confirm('Delete this check type?')) return;
        const { error } = await sb.from('check_types').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type deleted');
      }
    });
    async function setTypeTeam(checkTypeId, teamId){
      // clear existing mapping then set if provided
      await sb.from('check_type_teams').delete()
        .eq('site_id', S.siteId).eq('check_type_id', checkTypeId);
      if(teamId){
        const { error } = await sb.from('check_type_teams').insert({
          site_id:S.siteId, check_type_id: checkTypeId, team_id: Number(teamId)
        });
        if(error){ toast(error.message); return; }
      }
      await loadCheckTypeTeams(); buildTypeTeamMap(); renderTypes(); renderDashboard();
      toast('Team updated');
    }
    $('typesBody').addEventListener('change', async (e)=>{
      const sel = e.target.closest('select[data-act="typeTeam"]'); if(!sel) return;
      const id = Number(sel.getAttribute('data-id'));
      const teamId = sel.value || null;
      await setTypeTeam(id, teamId);
    });

    // Teams
    const _addTeam = $('addTeam'); if(_addTeam){ _addTeam.addEventListener('click', async ()=>{
      const name = ($('teamName').value||'').trim(); if(!name) return;
      const { error } = await sb.from('teams').insert({ site_id:S.siteId, name });
      if(error) return toast(error.message);
      $('teamName').value=''; await loadTeams(); renderTeams(); toast('Team added');
    }); }
    const _teamsBody = $('teamsBody'); if(_teamsBody){ _teamsBody.addEventListener('click', async (e)=>{
      const b = e.target.closest('button,span.chip'); if(!b) return;
      const act = b.getAttribute('data-act');
      if(act==='renameTeam'){
        const id = Number(b.getAttribute('data-id'));
        const row = (S.teams||[]).find(t=>t.id===id);
        const name = prompt('New team name', row?.name||''); if(!name) return;
        const { error } = await sb.from('teams').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTeams(); renderTeams(); renderTypes(); buildTypeTeamMap(); toast('Renamed');
      }
      if(act==='delTeam'){
        const id = Number(b.getAttribute('data-id'));
        if(!confirm('Delete this team?')) return;
        // clean up mappings and members
        await sb.from('team_members').delete().eq('team_id', id).eq('site_id', S.siteId);
        await sb.from('check_type_teams').delete().eq('team_id', id).eq('site_id', S.siteId);
        const { error } = await sb.from('teams').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await Promise.all([loadTeams(), loadTeamMembers(), loadCheckTypeTeams()]);
        buildTypeTeamMap(); renderTeams(); renderTypes(); renderDashboard(); toast('Team deleted');
      }
      if(act==='addMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const sel = b.parentElement.querySelector('select.team-add-member');
        const userId = Number(sel?.value||''); if(!userId) return;
        const { error } = await sb.from('team_members').insert({ site_id:S.siteId, team_id:teamId, user_id:userId });
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member added');
      }
      if(act==='removeMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const userId = Number(b.getAttribute('data-user'));
        const { error } = await sb.from('team_members').delete().eq('site_id', S.siteId).eq('team_id', teamId).eq('user_id', userId);
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member removed');
      }
    }); }

    // Items tab
    const _itemCategoryEl = $('itemCategory'); if(_itemCategoryEl){ _itemCategoryEl.addEventListener('change', fillItemPickers); }
    const _saveItemBtn = $('saveItem');
    if(_saveItemBtn){
      _saveItemBtn.addEventListener('click', async ()=>{
        const p = {
          p_site_id: S.siteId,
          p_item_id: $('itemCode').value.trim(),
          p_item_name: $('itemName').value.trim(),
          p_room_name: $('itemRoom').value,
          p_category: $('itemCategory').value,
          p_default_check_type_name: $('itemType').value,
          p_comments: $('itemComments').value.trim() || null
        };
        if(!p.p_item_id || !p.p_item_name){ return toast('Code & name required'); }
        const { data, error } = await sb.rpc('admin_upsert_item', p);
        if(error) return toast(error.message);
        await loadItems(); renderItems(); updateKPIs(); toast('Item saved');
      });
    }
    $('itemSearch').addEventListener('input', renderItems);
    $('refreshItems').addEventListener('click', async ()=>{ await loadItems(); renderItems(); });

    // Items configurator
    $('itemsBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const act=b.dataset.act;
      if(act==='cfg'){
        const code=b.dataset.code;
        const it=S.items.find(x=>x.item_id===code);
        if(!it) return;
        S.selectedItem = it;
        openCfgModal();
        $('cfgCodeInput').value = it.item_id;
        $('cfgCodeInput').readOnly = true;
        $('cfgName').textContent = it.item_name || '';
        // Reset Change button and input affordances
        const _btnEC = $('cfgEnableEditCode');
        if(_btnEC){
          _btnEC.textContent = 'Change';
          _btnEC.classList.remove('save-glow');
          _btnEC.dataset.mode = 'change';
        }
        $('cfgCodeInput').classList.remove('edit-pulse');
        fillCfgRooms(); fillOwnerRoles(); fillPlanTypePicker(it);
        if(it.room_name) $('cfgRoom').value = it.room_name;
        // owner role best-effort (from comments if present)
        $('cfgOwnerRole').value = '';
        await loadItemPlan(code); renderPlan();
      }
    });

    // Quick chips for frequency new
    document.querySelectorAll('button[data-quick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v=btn.getAttribute('data-quick'); const inp=$('planFreqNew'); if(inp) inp.value=v;
      });
    });

    // Add plan row
    $('planAdd').addEventListener('click', async ()=>{
      if(!S.selectedItem) return toast('Select an item first');
      const typeName = $('planTypeNew').value;
      const freq = $('planFreqNew').value || '0 days';
      if(!typeName) return toast('Choose a check type');
      const { error } = await sb.rpc('admin_set_item_check', {
        p_site_id: S.siteId,
        p_item_code: S.selectedItem.item_id,
        p_check_type_name: typeName,
        p_frequency: freq,
        p_warn_before: '3 days',
        p_required: true,
        p_active: true
      });
      if(error) return toast(error.message);
      $('planFreqNew').value='';
      await loadItemPlan(S.selectedItem.item_id); renderPlan(); toast('Check added');
    });

    // Save/remove plan rows
    $('planBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const act=b.dataset.act, id=b.dataset.id;
      if(act==='savePlan'){ await savePlanRow(id); }
      if(act==='delPlan'){
        if(!confirm('Remove this check from the plan?')) return;
        const { error } = await sb.from('item_allowed_types').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadItemPlan(S.selectedItem.item_id); renderPlan(); toast('Removed');
      }
    });

    // Save details (room + owner role)
    $('cfgSaveDetails').addEventListener('click', async ()=>{
      if(!S.selectedItem) return;
      const roomName = $('cfgRoom').value;
      const ownerRole = $('cfgOwnerRole').value;
      // Save room via existing RPC
      const { error } = await sb.rpc('admin_upsert_item', {
        p_site_id: S.siteId,
        p_item_id: $('cfgCodeInput').value.trim(),
        p_item_name: S.selectedItem.item_name,
        p_room_name: roomName,
        p_category: S.selectedItem.category,
        p_default_check_type_name: S.selectedItem.default_check_type_name || null,
        p_comments: (S.selectedItem.comments||'').replace(/owner:\s*.*$/i,'').trim() + (ownerRole?` owner: ${ownerRole}`:'')
      });
      if(error) return toast(error.message);
      await loadItems();
      // refresh selected
      S.selectedItem = S.items.find(x=>x.item_id===S.selectedItem.item_id);
      toast('Details saved');
    });


    // Staff tab
    $('addStaff').addEventListener('click', async ()=>{
      const full_name=$('staffName').value.trim(); const role=$('staffRole').value;
      if(!full_name) return;
      const { error } = await sb.from('kiosk_users').insert({ site_id:S.siteId, full_name, role });
      if(error) return toast(error.message);
      $('staffName').value=''; await loadStaff(); renderStaff(); updateKPIs(); toast('Staff added');
    });
    $('staffBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==='setPin'){
        const p = prompt('Enter new 4-digit PIN'); if(!p) return;
        const { error } = await sb.rpc('set_kiosk_user_pin', { p_user_id:id, p_site_id:S.siteId, p_pin:p });
        if(error) return toast(error.message);
        // Also persist the plain PIN so the UI (which reads the plain column) stays in sync
        await sb.from('kiosk_users').update({ pin: p }).eq('id', id).eq('site_id', S.siteId);
        await loadStaff(); renderStaff(); toast('PIN set');
      }
      if(act==='renameStaff'){
        const row=S.staff.find(x=>x.id===id); const name=prompt('New name', row?.full_name||''); if(!name) return;
        const { error } = await sb.from('kiosk_users').update({ full_name:name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Renamed');
      }
      if(act==='roleStaff'){
        const row=S.staff.find(x=>x.id===id); const role=prompt('Role (admin/staff)', row?.role||'staff'); if(!role) return;
        const { error } = await sb.from('kiosk_users').update({ role }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Role updated');
      }
      if(act==='delStaff'){
        if(!confirm('Delete this staff member?')) return;
        const { error } = await sb.from('kiosk_users').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); updateKPIs(); toast('Staff deleted');
      }
    });

    // Audits
    $('refreshAudits').addEventListener('click', async ()=>{ await loadAudits(); renderAudits(); });
    $('auditSearch').addEventListener('input', renderAudits);
    $('exportAudits').addEventListener('click', ()=>{
      const rows = S.audits.map(a=>({
        submitted_at: a.submitted_at,
        staff_name: a.staff_name,
        scanned_code: a.scanned_code,
        item_name: a.item_name,
        room: a.room,
        check_type: a.check_type,
        check_value: a.check_value
      }));
      const csv = Papa.unparse(rows);
      download(`audits_site_${S.siteId}.csv`, csv);
    });

    // Initial picker listeners
    const _itemRoomEl = $('itemRoom'); if(_itemRoomEl){ _itemRoomEl.addEventListener('change', ()=>{}); }
    const _itemTypeEl = $('itemType'); if(_itemTypeEl){ _itemTypeEl.addEventListener('change', ()=>{}); }

    // Modal close listeners
    const _cfgClose = $('cfgClose'); if(_cfgClose){ _cfgClose.addEventListener('click', closeCfgModal); }
    const _cfgModal = $('cfgModal'); if(_cfgModal){ _cfgModal.addEventListener('click', (e)=>{ if(e.target===_cfgModal) closeCfgModal(); }); }
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCfgModal(); });
    const _riClose = $('roomItemsClose'); if(_riClose){ _riClose.addEventListener('click', closeRoomItemsModal); }
    const _riModal = $('roomItemsModal'); if(_riModal){ _riModal.addEventListener('click', (e)=>{ if(e.target===_riModal) closeRoomItemsModal(); }); }
    const _cfgEnableEditCode = $('cfgEnableEditCode');
    if(_cfgEnableEditCode){
      _cfgEnableEditCode.dataset.mode = 'change';
      _cfgEnableEditCode.addEventListener('click', async ()=>{
        const btn = _cfgEnableEditCode;
        const inp = $('cfgCodeInput');
        if(!inp) return;
        // Enter edit mode
        if(btn.dataset.mode !== 'save'){
          btn.dataset.mode = 'save';
          btn.textContent = 'Save';
          btn.classList.add('save-glow');
          inp.readOnly = false;
          inp.classList.add('edit-pulse');
          inp.focus();
          inp.select();
          return;
        }
        // Save mode
        const newCode = (inp.value||'').trim();
        if(!S.selectedItem){ toast('No item selected'); return; }
        if(!newCode){ toast('Code required'); return; }
        // If unchanged, just exit edit mode gracefully
        if(newCode === S.selectedItem.item_id){
          btn.dataset.mode = 'change';
          btn.textContent = 'Change';
          btn.classList.remove('save-glow');
          inp.readOnly = true;
          inp.classList.remove('edit-pulse');
          return;
        }
        btn.disabled = true;
        try{
          const { error } = await sb.rpc('admin_upsert_item', {
            p_site_id: S.siteId,
            p_item_id: newCode,
            p_item_name: S.selectedItem.item_name,
            p_room_name: $('cfgRoom').value,
            p_category: S.selectedItem.category,
            p_default_check_type_name: S.selectedItem.default_check_type_name || null,
            p_comments: S.selectedItem.comments || null
          });
          if(error) throw error;
          await loadItems();
          S.selectedItem = S.items.find(x => x.item_id === newCode) || S.selectedItem;
          renderItems();
          toast('Item ID saved');
          // Exit edit mode
          btn.dataset.mode = 'change';
          btn.textContent = 'Change';
          btn.classList.remove('save-glow');
          inp.readOnly = true;
          inp.classList.remove('edit-pulse');
        }catch(err){
          console.error(err);
          toast(err.message || 'Save failed');
        }finally{
          btn.disabled = false;
        }
      });
    }

    // Kick off
    init();
  </script>
</body>
</html>
    // Sign up (invited member) — no surgery name required
    document.getElementById('doSignupInvited')?.addEventListener('click', async ()=>{
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const password = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMsg');
      if (!email || !password) { msg.textContent = 'Enter email & password.'; return; }
      msg.textContent = 'Creating account…';
      const { error } = await sb.auth.signUp({ email, password });
      if (error) { msg.textContent = error.message; return; }
      // Show confirm panel like owner sign-up
      const loginStack = $('loginStack');
      const signupRow = $('signupRow');
      const loginActions = $('loginActions');
      const confirmBlock = $('signupConfirm');
      const confirmText = $('signupConfirmText');
      if(loginStack) loginStack.classList.add('hidden');
      if(signupRow) signupRow.classList.add('hidden');
      if(loginActions) loginActions.classList.add('hidden');
      if(confirmText) confirmText.textContent = `We\'ve sent a confirmation link to ${email}. After confirming, sign in here and we\'ll link you to your surgery automatically if you were invited.`;
      if(confirmBlock) confirmBlock.classList.remove('hidden');
    });