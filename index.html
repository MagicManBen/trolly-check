<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CQC – PIN Portal (DEBUG BUILD)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
h1,h2{margin:0 0 20px}

/* ---------- modern core look & feel ---------- */
body{
  margin:0;
  background:#141314;
  color:#fff;
  font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  text-align:center;
  padding:40px;
}
input,button,select,textarea{font-size:1rem;padding:10px;border:none;border-radius:6px}
input[type=password],input[type=text]{background:#111;color:#fff;letter-spacing:8px;width:160px;text-align:center}
button{
  cursor:pointer;
  background:#1e8c1e;
  color:#fff;
  border-radius:12px;
  box-shadow:0 8px 18px rgba(30,140,30,.25), inset 0 -2px 0 rgba(0,0,0,.25);
  transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;
}
button:hover{ box-shadow:0 10px 22px rgba(30,140,30,.35), inset 0 -2px 0 rgba(0,0,0,.25); }
button:active{ transform:translateY(1px) scale(.99); }
#status{margin-top:15px;font-weight:bold}
#welcome{
  margin-top:12px;
  font-size:1.35rem;
  color:#d3ffd3;
  background:rgba(30,140,30,.16);
  border:1px solid rgba(30,140,30,.55);
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
}
/* hide the welcome pill until there’s content to prevent the small green square */
#welcome:empty{display:none}

/* keypad */
#keypad{margin:25px auto 10px;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#keypad .key{
  background:#333;color:#fff;border-radius:10px;font-size:1.3rem;padding:16px 0;
  user-select:none;transition:transform .05s ease, background .05s ease;box-shadow:none;
}
#keypad .wide{grid-column:span 3}
#keypad .zero{grid-column:2}

/* pressed visual */
.key.pressed{background:#555;color:#fff;transform:scale(0.96)}
/* login success banner */
.login-success{display:none;color:#1e8c1e;font-weight:bold;margin-top:8px;font-size:1.1rem}

/* hide scanner inputs but keep them usable */
.scanner{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
#visibleBulkInput{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}

/* debug panel (button removed) */
#debug{position:fixed;bottom:80px;left:20px;width:300px;max-height:50vh;overflow:auto;background:#111;padding:10px;border:1px solid #555;border-radius:8px;font-family:Consolas,monospace;font-size:.75rem;display:none}
#debug pre{margin:0;white-space:pre-wrap}

/* pages */
.page{display:none}
.active{display:block}

#qrCodeWrapper,#auditMsgWrapper,#doneScreen,#outputPage{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh}

/* upload page elements */
@keyframes glowEdge{from{box-shadow:0 0 6px #1e8c1e}to{box-shadow:0 0 20px #1e8c1e}}
.scanning{animation:glowEdge .5s ease-in-out infinite alternate;border:2px solid #1e8c1e!important}
#progressAnim{display:none;flex-direction:column;align-items:center;margin-top:20px}
.spinner{width:80px;height:80px;border:10px solid #1e8c1e;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#uploadText{margin-top:12px;font-size:1.2rem;color:#1e8c1e;font-weight:bold}
/* progress ring */
.progress-ring{position:relative;width:120px;height:120px}
.progress-ring svg{transform:rotate(-90deg)}
.progress-ring__bg{stroke:#333;stroke-width:10;fill:none}
.progress-ring__circle{stroke:#1e8c1e;stroke-width:10;fill:none;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.progress-ring__label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:bold}
#progressText{margin-top:14px;font-size:1.4rem;color:#fff;font-weight:bold}

/* review table (Page 5) */
.review-wrap{width:96%;max-width:980px;margin:0 auto}
.review-note{color:#bbb;margin:6px 0 14px;font-size:.95rem}
.table{width:100%;border-collapse:collapse;background:#fff;color:#000;border-radius:14px;overflow:hidden;table-layout:fixed;box-shadow:0 14px 30px rgba(0,0,0,.35)}
.table th,.table td{border:1px solid #ddd;padding:10px;vertical-align:middle;text-align:center}
.table th{background:#f3f3f3;font-weight:600;font-size:.95rem}
.table td.item-col,.table td.room-col{text-align:left}
.table td.item-col{width:30%}
.table td.room-col{width:14%}
.chk-cell{display:flex;align-items:center;justify-content:center;gap:6px}
.chk-cell input[type="checkbox"]{transform:scale(1.2)}
.actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
#submitChecksBtn{background:#1e8c1e;color:#fff;border-radius:12px;padding:12px 18px;font-size:1.05rem}
#submitChecksBtn[disabled]{opacity:.6;cursor:not-allowed}
.success-msg{color:#1e8c1e;font-weight:bold;margin-top:10px}
.error-msg{color:#ff6961;font-weight:bold;margin-top:10px}

/* temperature panel below table */
#tempSection{display:none;margin:12px 0 6px;padding:10px;background:#1a1a1a;border:1px solid #333;border-radius:12px;width:96%;max-width:980px}
#tempSection h3{margin:0 0 8px;font-size:1.05rem;color:#ddd}
.temp-row{display:grid;grid-template-columns:1.2fr .8fr auto;gap:10px;align-items:center;margin:6px 0}
.temp-row .label{color:#ddd;text-align:left}
.temp-input{width:56px;padding:6px 8px;border:1px solid #bbb;border-radius:8px;font-size:1rem;text-align:center}
.temp-hint{color:#aaa;font-size:.85rem;text-align:left}

/* session comment */
.comment-wrap{width:96%;max-width:980px;margin:12px auto 0}
#sessionComment{
  width:100%;
  min-height:64px;
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:10px 12px;
  font-size:1rem;
  resize:vertical;
}

/* + button & modal styles */
button.danger{background:#b30000}
#plusBtn{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 16px);right:calc(env(safe-area-inset-right,0px) + 16px);width:48px;height:48px;border-radius:50%;font-size:28px;padding:6px 0;z-index:10000}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center}
#box{background:#222;padding:20px;border-radius:12px;width:90%;max-width:380px}
#box select,#box input{width:100%;margin:6px 0}

/* modal keypad */
#modalKeypad{margin:10px auto;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#modalKeypad .key{
  background:#333;color:#fff;border-radius:10px;font-size:1.3rem;padding:16px 0;
  user-select:none;transition:transform .05s ease, background .05s ease;box-shadow:none;
}

/* user badge — bottom center */
.user-badge{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);color:#aaa;background:transparent;padding:0;border-radius:0;font-size:.95rem;opacity:1;z-index:9999;display:none}

/* page 2 spacing + bigger instruction */
#qrCodeWrapper{gap:28px}
#clickText{margin-top:28px}
#qrTitle{
  font-size:1.7rem;
  font-weight:800;
  letter-spacing:.3px;
  text-shadow:0 2px 10px rgba(0,0,0,.6);
  animation:glowText 1.4s ease-in-out infinite alternate;
}
@keyframes glowText{
  from{ text-shadow:0 0 6px rgba(255,255,255,.4), 0 0 0 #1e8c1e; }
  to{ text-shadow:0 0 14px rgba(255,255,255,.9), 0 0 18px rgba(30,140,30,.65); }
}

/* instructional images (responsive for vertical iPad) */
.instruction-img{display:block;margin:16px auto 0;max-width:80vw;height:auto}
#page1 .instruction-img{max-width:60vw;max-height:30vh;margin-top:12px}
#page2 .instruction-img{max-width:70vw;max-height:32vh}
#page3 .instruction-img{max-width:70vw;max-height:35vh;margin-top:16px}

/* cards */
.card{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  padding:16px;
}

/* center the page 2 wrapper */
#qrCodeWrapper{justify-content:center;min-height:70vh;padding-top:0;gap:18px}
/* upload page layout */
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center;justify-items:center}
@media (max-width:740px){ .upload-grid{grid-template-columns:1fr} }
.scan-illustration{max-width:280px;width:80%;height:auto;filter:drop-shadow(0 6px 18px rgba(0,0,0,.35));border-radius:12px;opacity:.95}

/* audit radar animation */
.radar{position:relative;width:140px;height:140px;margin:10px auto}
.radar span{position:absolute;inset:0;border:3px solid #1e8c1e;border-radius:50%;opacity:.95;animation:radar 1.8s linear infinite}
.radar span:nth-child(2){animation-delay:.3s}
.radar span:nth-child(3){animation-delay:.6s}
@keyframes radar{0%{transform:scale(.2);opacity:.9}100%{transform:scale(1);opacity:0}}

/* big green plate with text for audit page */
.radarPlate{
  position:relative;width:min(78vw,340px);height:min(78vw,340px);
  border-radius:50%;border:6px solid #1e8c1e;
  box-shadow:inset 0 0 40px rgba(30,140,30,.35),0 0 40px rgba(30,140,30,.25);
  margin:8px auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden
}
.radarText{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:22px;text-align:center}
.radarText .big{font-size:1.8rem;font-weight:800;letter-spacing:.3px}
.radarText .sub{margin-top:8px;font-size:1.05rem;color:#d3ffd3;line-height:1.35}
.instruction-img.small-bottom{max-width:58vw;max-height:25vh;opacity:.9;margin-top:8px}

#beginBtn{background:#fff!important;color:#000!important;border:2px solid #000;border-radius:12px;padding:14px 22px;font-size:1.15rem}

/* done animation */
.done-wrap{position:relative;width:160px;height:160px;border-radius:50%;background:#0e0e0e;border:3px solid #1e8c1e;display:flex;align-items:center;justify-content:center;animation:pulse 1.8s ease-in-out 2}
.tick{width:60px;height:30px;border-left:6px solid #1e8c1e;border-bottom:6px solid #1e8c1e;transform:rotate(-45deg) translateY(-6px);opacity:0;animation:draw .6s .3s ease forwards}
.burst{position:absolute;width:8px;height:8px;background:#1e8c1e;border-radius:50%;opacity:0}
.b1{animation:burst 1.2s .4s ease-out forwards}
.b2{animation:burst 1.2s .6s ease-out forwards}
.b3{animation:burst 1.2s .8s ease-out forwards}
@keyframes draw{to{opacity:1;transform:rotate(-45deg) translateY(-6px) scale(1.05)}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(30,140,30,.5)}50%{box-shadow:0 0 30px 6px rgba(30,140,30,.45)}}
@keyframes burst{0%{opacity:0;transform:translate(0,0) scale(.8)}50%{opacity:1}100%{opacity:0;transform:translate(var(--x,0),var(--y,0)) scale(1)}}
.b1{--x:-60px;--y:-20px}
.b2{--x:50px;--y:-10px}
.b3{--x:0px;--y:60px}
</style>
</head>
<body>

<!-- Page 1 – PIN -->
<div id="page1" class="page active">
  <h1>Enter 4-Digit PIN</h1>
  <input id="pin" type="password" maxlength="4" placeholder="****">
  <div id="keypad">
    <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
    <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
    <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
    <button class="key zero" type="button">0</button>
    <button class="key wide" data-act="clear" type="button">Clear</button>
  </div>
  <img id="wristbandImg" class="instruction-img" src="WristBand.png" alt="Attach the wrist strap" />
  <button id="plusBtn" type="button">+</button>
  <div id="status"></div><div id="welcome"></div>
  <div id="loginSuccess" class="login-success">Login successful</div>
</div>

<!-- Page 2 – BEGIN -->
<div id="page2" class="page">
  <div id="qrCodeWrapper">
    <div class="card" style="width:min(92vw,560px);margin:0 auto">
      <div id="qrTitle">Press button once and wait for two beeps</div>
      <img id="doubleBeepImg" class="instruction-img" src="DoubleDeep.png" alt="Wait for two beeps" />
      <div id="qrCode"></div>
      <div id="clickText">After 2 beeps, click the BEGIN button below</div>
      <button id="beginBtn" type="button" style="margin-top:8px">Begin</button>
    </div>
  </div>
</div>

<!-- Page 3 – Audit -->
<div id="page3" class="page">
  <div id="auditMsgWrapper">
    <div class="card" style="width:min(92vw,560px);margin:0 auto">
      <div class="radarPlate">
        <div id="auditVisual" class="radar" aria-hidden="true"><span></span><span></span><span></span></div>
        <div class="radarText">
          <div class="big">Audit live</div>
          <div class="sub">Scan the QR code on each item as you check it.<br/>When you’re finished, return to this iPad.</div>
        </div>
      </div>
      <img class="instruction-img small-bottom" src="ScanTrolly.png" alt="Scanner and QR code" />
      <div id="qrCodeAudit" style="margin-top:12px;"></div>
    </div>
  </div>
  <input id="hiddenScanner3" class="scanner" type="text" autocomplete="off">
</div>

<!-- Page 4 – Upload -->
<div id="page4" class="page">
  <div id="doneScreen">
    <div class="card" style="width:min(92vw,560px);margin:0 auto">
      <h2>Finished your audit? Scan this code to upload</h2>
      <div class="upload-grid">
        <img id="ipadScanImg" class="scan-illustration" src="IPADSCAN.png" alt="Scan the iPad screen">
        <div id="uploadQr"></div>
      </div>
      <input id="visibleBulkInput" autocomplete="off">
      <div id="scanCount">No scans captured yet.</div>
      <div id="progressAnim">
        <div class="progress-ring">
          <svg width="120" height="120">
            <circle class="progress-ring__bg" cx="60" cy="60" r="52"></circle>
            <circle class="progress-ring__circle" cx="60" cy="60" r="52"></circle>
          </svg>
          <div class="progress-ring__label" id="progressPercent">0%</div>
        </div>
        <div id="progressText">Uploading…</div>
      </div>
    </div>
  </div>
</div>

<!-- Page 5 – Results -->
<div id="page5" class="page">
  <div id="outputPage" class="review-wrap card">
    <h2>Review checks before submitting</h2>
    <div class="review-note">Select the checks performed for each item.</div>
    <div id="reviewTable"></div>

    <!-- temperatures panel -->
    <div id="tempSection">
      <h3>Temperatures</h3>
      <div id="tempRows"></div>
      <div class="temp-hint">Enter a 1–2 digit value for each item you ticked as "Temperature".</div>
    </div>

    <!-- session comment -->
    <div id="commentSection" class="comment-wrap">
      <textarea id="sessionComment" maxlength="280" placeholder="Optional comment for this submission…"></textarea>
    </div>

    <div class="actions">
      <button id="submitChecksBtn" type="button" disabled>Submit</button>
    </div>
    <div id="submitMsg" aria-live="polite"></div>
  </div>
</div>

<!-- Page 6 – Done -->
<div id="page6" class="page">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh">
    <div class="done-wrap">
      <div class="tick"></div>
      <div class="burst b1"></div>
      <div class="burst b2"></div>
      <div class="burst b3"></div>
    </div>
    <h2 style="margin-top:18px">All set!</h2>
  </div>
</div>

<!-- + button & modal -->
<div id="modal">
  <div id="box">
    <h2>Create PIN</h2>
    <select id="userSel"></select>
    <input id="pin1" type="password" maxlength="4" placeholder="New PIN" readonly />
    <input id="pin2" type="password" maxlength="4" placeholder="Confirm PIN" readonly />
    <div id="modalKeypad">
      <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
      <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
      <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
      <button class="key wide" data-act="clear" type="button">C</button>
      <button class="key" type="button">0</button><button class="key wide" data-act="del" type="button">←</button>
    </div>
    <button id="save" type="button">Save PIN</button>
    <button class="danger" id="cancel" type="button">Cancel</button>
    <div id="modalMsg"></div>
  </div>
</div>

<!-- User badge -->
<div id="userBadge" class="user-badge"></div>

<!-- Debug -->
<div id="debug"><pre id="debugLog"></pre></div>

<script>
/* ---------- constants ---------- */
const FLOW_VALIDATE = "https://prod-89.westeurope.logic.azure.com:443/workflows/f1639be7e1a441a4a97130cb087ebe28/triggers/manual/paths/invoke?api-version=2016-06-01&sp=/triggers/manual/run&sv=1.0&sig=LX2eGuTosv-wKZinDs7z4TkpNTZ3POLUvMiiXftISOE";
const FLOW_BASE = FLOW_VALIDATE;
const FLOW = FLOW_VALIDATE;

const $=id=>document.getElementById(id);

// --- audio helpers (keypad-only beeps) ---
let audioCtx=null;
function playBeep(freq=600, duration=120, volume=0.2){
  try{
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ try{osc.stop();}catch{} }, duration);
  }catch{}
}

/* ---------- state ---------- */
let capturedScans=new Set();
let itemsData=[];
let loggedInUser="";
let uploadTimer=null;
let hasUploadInput=false;
let isUploading=false;
let resolvedItems=[]; // items returned by resolveScans

/* ---------- debug ---------- */
function dbg(...m){const log=$("debugLog");log.textContent+=m.join(" ")+"\n";log.parentElement.scrollTop=log.parentElement.scrollHeight;}

/* ---------- helpers ---------- */
function callFlow(mode,payload={}) {
  return fetch(`${FLOW_BASE}&mode=${mode}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({mode,...payload})
  }).then(r=>r.json());
}
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  $(id).classList.add("active");
  // Show logged-in user badge on pages 2+ only
  if (id !== "page1" && loggedInUser) {
    $("userBadge").textContent = "User: " + loggedInUser;
    $("userBadge").style.display = "block";
  } else {
    $("userBadge").style.display = "none";
  }
}

// ----- Keypad binder -----
function bindKeypad(selector, onpress){
  const downEvt = window.PointerEvent ? 'pointerdown' : 'mousedown';
  const upEvt = window.PointerEvent ? 'pointerup' : 'mouseup';
  const leaveEvt = window.PointerEvent ? 'pointerleave' : 'mouseleave';
  document.querySelectorAll(selector).forEach(btn=>{
    const downHandler=(e)=>{ e.preventDefault(); btn.classList.add('pressed'); playBeep(); onpress(btn); };
    const upHandler=()=>{ btn.classList.remove('pressed'); };
    const leaveHandler=()=>{ btn.classList.remove('pressed'); };
    btn.addEventListener(downEvt, downHandler, { passive:false });
    btn.addEventListener(upEvt, upHandler);
    btn.addEventListener(leaveEvt, leaveHandler);
  });
}

let pinSubmitting=false;
async function validatePin(pin){
  if(pinSubmitting) return; pinSubmitting=true;
  $("status").textContent="Checking…";
  try{
    const d=await fetch(FLOW_VALIDATE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"validatePin",pin:pin})}).then(r=>r.json());
    if(d.status==="success"){
      loggedInUser = d.user?.Name || "";
      $("status").textContent = "✅";
      $("welcome").textContent = loggedInUser ? "Welcome, "+loggedInUser : "";
      if (loggedInUser) { $("userBadge").textContent = "User: " + loggedInUser; }
      // show a clear success signal for 2 seconds
      $("loginSuccess").style.display = "block";
      setTimeout(()=>{
        showPage("page2");
        $("loginSuccess").style.display = "none";
        $("qrCode").innerHTML = "";
      }, 2000);
    } else {
      $("status").textContent="❌ Invalid";
      $("pin").value="";
    }
  }catch{
    $("status").textContent="❌ Network error";
  } finally { pinSubmitting=false; }
}

bindKeypad('#keypad .key', (btn)=>{
  const act=btn.dataset.act;
  if(act==="clear"){ $("pin").value=""; return; }
  if(/^\d$/.test(btn.textContent)){
    if($("pin").value.length<4){
      $("pin").value += btn.textContent;
      if($("pin").value.length===4){ validatePin($("pin").value.trim()); }
    }
  }
});

/* ---------- Page 2: Begin ---------- */
$("beginBtn").addEventListener("click", ()=>{
  // Instant navigation to page 3
  showPage("page3");
  $("qrCodeAudit").innerHTML="";

  // Fetch items in the background
  callFlow("listItems")
    .then(items=>{ itemsData = Array.isArray(items)? items : []; dbg("Fetched items:", itemsData.length); })
    .catch(err=>{ dbg("Error fetching items:", err); });

  // Short transition to upload page (5s)
  setTimeout(()=>{ showUploadPage(); }, 5000);
});

/* ---------- Page 3: DONE (still supported if scanner sends DONE) ---------- */
$("hiddenScanner3").addEventListener("keydown", e=>{
  if(e.key==="Enter" && e.target.value.trim().toUpperCase()==="DONE"){
    e.target.value="";
    showUploadPage();
  }
});

/* ---------- Page 4: Upload ---------- */
function showUploadPage(){
  showPage("page4");
  $("uploadQr").style.display = ""; // reset visible until first scan
  $("uploadQr").innerHTML="";
  new QRCode("uploadQr",{text:"^&032&^",width:240,height:240});
  $("visibleBulkInput").value="";
  $("visibleBulkInput").focus();
  capturedScans.clear();
  hasUploadInput=false;
  if(uploadTimer){clearTimeout(uploadTimer); uploadTimer=null;}
  renderScanCount();
}

function renderScanCount(){
  $("scanCount").textContent = capturedScans.size
    ? `${capturedScans.size} scan${capturedScans.size===1?"":"s"} captured`
    : "No scans captured yet.";
}

// Accept scans whether they arrive line-by-line or as a single bulk paste
$("visibleBulkInput").addEventListener("input", e=>{
  const val = e.target.value;
  if(/\d{10}/.test(val) || e.data?.includes("\n") || e.inputType==="insertLineBreak"){
    addMany(val);
    e.target.value = ""; // clear for more scans
  }
});
$("visibleBulkInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addMany(e.target.value);
    e.target.value="";
  }
});

function addMany(text){
  const before=capturedScans.size;
  (text.match(/\d{10}/g)||[]).forEach(c=>capturedScans.add(c));
  renderScanCount();
  if(capturedScans.size>before){
    hasUploadInput=true;
    scheduleAutoUpload();
    // Hide the QR once scans start arriving
    $("uploadQr").style.display = "none";
  }
}
function scheduleAutoUpload(){
  if(!hasUploadInput) return;
  if(uploadTimer) clearTimeout(uploadTimer);
  uploadTimer=setTimeout(()=>{ doUpload(); },2000); // keep 2s no-input debounce
}

/* --- 0–100% progress ring helpers (visual only) --- */
let _progressTimer=null, _progressStart=0, _progressCircumference=0;
function startProgress(durationMs=2000){
  const circle = document.querySelector('.progress-ring__circle');
  const percentLabel = $("progressPercent");
  if(!circle || !percentLabel) return;
  const radius = circle.r.baseVal.value;
  _progressCircumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = `${_progressCircumference} ${_progressCircumference}`;
  circle.style.strokeDashoffset = `${_progressCircumference}`;
  _progressStart = performance.now();
  $("progressAnim").style.display = "flex";
  cancelAnimationFrame(_progressTimer);
  const tick = (now)=>{
    const elapsed = now - _progressStart;
    const p = Math.min(1, elapsed / durationMs);
    const offset = _progressCircumference * (1 - p);
    circle.style.strokeDashoffset = `${offset}`;
    percentLabel.textContent = `${Math.round(p*100)}%`;
    if(p < 1){ _progressTimer = requestAnimationFrame(tick); }
  };
  _progressTimer = requestAnimationFrame(tick);
}
function stopProgress(){
  cancelAnimationFrame(_progressTimer);
  const circle = document.querySelector('.progress-ring__circle');
  const percentLabel = $("progressPercent");
  if(circle){ circle.style.strokeDashoffset = 0; }
  if(percentLabel){ percentLabel.textContent = '100%'; }
}

/* auto-upload */
async function doUpload(){
  if (isUploading || !capturedScans.size) return;
  isUploading=true;
  startProgress(2000);
  $("progressText").textContent = "Preparing items…";
  $("progressAnim").style.display = "flex";

  const payload = {
    SessionID: "SESSION-" + Date.now(),
    ScannedItemIDs: [...capturedScans]
  };

  try{
    const res = await callFlow("resolveScans", payload);
    // Expecting an array of items with: ItemID, ItemName, Room, Checks[{Name,RequiresValue}]
    resolvedItems = Array.isArray(res?.items) ? res.items : [];
  }catch(err){
    dbg("resolveScans error", err);
    alert("Couldn't resolve items from scans.");
    resolvedItems = [];
  }finally{
    stopProgress();
    $("progressAnim").style.display = "none";
    isUploading=false;
  }

  // Move to review page either way
  renderReviewTable();
  showPage("page5");
}

/* ---------- Page 5: Review ---------- */
function renderReviewTable(){
  const container = $("reviewTable");
  if(!container) return;

  if(!resolvedItems.length){
    container.innerHTML = '<div class="error-msg">No known items were resolved from the scans.</div>';
    $("submitChecksBtn").disabled = true;
    return;
  }

  // Preferred column order; also include any extra check names found
  const PREFERRED = ["Cleaned","Stocked","Battery","ExpiryDates","Temperature"];
  const namesSet = new Set(PREFERRED);
  resolvedItems.forEach(it => (it.Checks || []).forEach(c => {
    const n = String(c.Name || "").trim();
    if(n) namesSet.add(n);
  }));
  const columns = Array.from(namesSet);

  // Build table header
  let html = '<table class="table"><thead><tr>'+
    '<th class="item-col">Item</th>'+
    '<th class="room-col">Room</th>'+
    columns.map(n => `<th>${n}</th>`).join("")+
    '</tr></thead><tbody>';

  // Build each row
  resolvedItems.forEach((item, i)=>{
    const checks = Array.isArray(item.Checks) ? item.Checks : [];
    const hasByName = Object.fromEntries(checks.map(c => [String(c.Name || ""), c]));

    html += `<tr>`+
      `<td class="item-col">${item.ItemName || item.ItemID}</td>`+
      `<td class="room-col">${item.Room || ""}</td>`;

    columns.forEach(name=>{
      if(!hasByName[name]){ html += `<td></td>`; return; }
      html += `<td><div class="chk-cell">
        <input type="checkbox" class="rev-chk" data-i="${i}" data-name="${name}">
      </div></td>`;
    });

    html += `</tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // --- Temperature panel logic ---
  function updateTempSection(){
    const tempRows = [];
    container.querySelectorAll('.rev-chk').forEach(chk=>{
      if(chk.checked && String(chk.dataset.name||"").toLowerCase()==="temperature"){
        const idx = Number(chk.dataset.i);
        const it = resolvedItems[idx] || {};
        tempRows.push({i: idx, item: it});
      }
    });
    const wrap = $("tempSection");
    const rowsHost = $("tempRows");
    if(!wrap || !rowsHost) return;
    if(!tempRows.length){ wrap.style.display = "none"; rowsHost.innerHTML = ""; return; }
    wrap.style.display = "block";
    rowsHost.innerHTML = tempRows.map(r => `
      <div class="temp-row" data-i="${r.i}">
        <div class="label">${r.item.ItemName || r.item.ItemID}</div>
        <div class="label">${r.item.Room || ""}</div>
        <input class="temp-input" type="text" maxlength="2" inputmode="numeric" pattern="\\d{1,2}" placeholder=".." data-i="${r.i}">
      </div>
    `).join("");
    validateSubmit();
  }

  function validateSubmit(){
    const totalRows = resolvedItems.length;
    const rowHasChoice = new Array(totalRows).fill(false);
    let tempsOk = true;

    // mark rows that have at least one selection
    container.querySelectorAll('.rev-chk').forEach(chk=>{
      if(chk.checked){
        const idx = Number(chk.dataset.i);
        if(!isNaN(idx)) rowHasChoice[idx] = true;
      }
    });

    // validate any temperature inputs present (only appear when ticked)
    const tempInputsHost = $("tempRows");
    if(tempInputsHost){
      tempInputsHost.querySelectorAll('.temp-input').forEach(inp=>{
        const v = (inp.value||'').trim();
        if(!/^[0-9]{1,2}$/.test(v)) tempsOk = false;
      });
    }

    const allRowsSatisfied = rowHasChoice.every(Boolean);
    $("submitChecksBtn").disabled = !(allRowsSatisfied && tempsOk);
  }

  container.querySelectorAll('.rev-chk').forEach(el=>{
    el.addEventListener('change', ()=>{
      if(String(el.dataset.name||"").toLowerCase()==="temperature"){ updateTempSection(); }
      validateSubmit();
    });
  });
  const tempHost = $("tempRows");
  if(tempHost){
    tempHost.addEventListener('input', (e)=>{
      if(e.target && e.target.classList.contains('temp-input')) validateSubmit();
    });
  }
  // Initial state
  $("tempSection").style.display = "none";
  $("tempRows").innerHTML = "";
  $("submitChecksBtn").disabled = true;
}

function buildSubmission(){
  const rows = [];
  const sessionComment = ($("sessionComment")?.value || "").trim();
  const table = $("reviewTable");
  if(!table) return rows;

  // For every checked box, create a row (Temperature value comes from panel)
  table.querySelectorAll('.rev-chk:checked').forEach(chk=>{
    const i = Number(chk.dataset.i);
    const name = String(chk.dataset.name || "");
    const item = resolvedItems[i] || {};

    let value = "Done";
    if(name.toLowerCase()==="temperature"){
      const valEl = $("tempRows") ? $("tempRows").querySelector(`.temp-input[data-i="${i}"]`) : null;
      value = (valEl?.value || "").trim();
    }

    rows.push({
      ItemID: String(item.ItemID || ""),
      ItemName: item.ItemName || "",
      Room: item.Room || "",
      CheckType: name,
      CheckValue: value || "Done",
      Comment: sessionComment
    });
  });

  return rows;
}

$("submitChecksBtn").addEventListener("click", async ()=>{
  const rows = buildSubmission();
  if(!rows.length){ return; }
  $("submitChecksBtn").disabled = true;
  $("submitMsg").textContent = "Submitting…";
  try{
    const payload = {
      SessionID: "SESSION-" + Date.now(),
      StaffName: loggedInUser || 'PIN User',
      SubmittedAt: new Date().toISOString(),
      Rows: rows
    };
    const res = await callFlow('submitChecks', payload);
    if(res && res.status === 'success'){
      // Done animation then full reset back to page 1
      showPage("page6");
      setTimeout(()=>{
        // clear temperature panel and comment
        const ts = $("tempSection"); if(ts){ ts.style.display="none"; }
        const tr = $("tempRows"); if(tr){ tr.innerHTML=""; }
        const sc = $("sessionComment"); if(sc){ sc.value = ""; }
        // clear review + state
        $("reviewTable").innerHTML = "";
        $("submitMsg").innerHTML = "";
        $("submitChecksBtn").disabled = true;
        capturedScans.clear();
        itemsData = [];
        resolvedItems = [];
        // reset login visuals on page 1
        $("pin").value = "";
        $("status").textContent = "";
        $("welcome").textContent = "";
        $("userBadge").style.display = "none";
        loggedInUser = ""; // re-set on next successful PIN
        // go home
        showPage("page1");
      }, 2500);
    }else{
      $("submitMsg").innerHTML = `<div class="error-msg">Submission failed.</div>`;
      $("submitChecksBtn").disabled = false;
    }
  }catch(e){
    $("submitMsg").innerHTML = `<div class="error-msg">Submission error.</div>`;
    $("submitChecksBtn").disabled = false;
  }
});

/* ---------- keep focus on inputs ---------- */
setInterval(()=>{
  ["hiddenScanner3","visibleBulkInput"].forEach(id=>{
    $(id)?.focus();
  });
},500);

/* + modal logic */
$("plusBtn").onclick = async () => {
  $("modalMsg").textContent = "";
  $("pin1").value = $("pin2").value = "";
  $("userSel").innerHTML = "<option>Loading…</option>";
  $("modal").style.display = "flex";

  window._modalActive = "pin1";
  $("pin1").focus();

  try {
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "getUsersWithoutPins" })
    });
    const d = await r.json();
    $("userSel").innerHTML = d.status === "success"
      ? d.users.map(u => `<option>${u.Name}</option>`).join("")
      : "<option>❌ Couldn't load users</option>";
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};

$("cancel").onclick = () => $("modal").style.display = "none";

/* Modal keypad-only entry */
["pin1","pin2"].forEach(id=>{
  $(id).addEventListener("keydown", e=> e.preventDefault());
  $(id).addEventListener("input", e=> e.preventDefault());
  $(id).addEventListener("click", ()=> window._modalActive = id);
});
bindKeypad('#modalKeypad .key', (btn)=>{
  const targetId = window._modalActive || 'pin1';
  const el = $(targetId);
  const act = btn.dataset.act;
  if (!el) return;
  if (act === 'clear') { el.value = ''; return; }
  if (act === 'del') { el.value = el.value.slice(0,-1); return; }
  if (el.value.length < 4 && /^\d$/.test(btn.textContent)) {
    el.value += btn.textContent;
  }
});

/* Save with pre-check (no extra beeps) */
$("save").onclick = async () => {
  const name = $("userSel").value;
  const p1 = $("pin1").value.trim(), p2 = $("pin2").value.trim();
  if (p1 !== p2 || p1.length !== 4 || isNaN(p1)) {
    $("modalMsg").textContent = "Pins must match & be 4 digits";
    return;
  }
  $("modalMsg").textContent = "Checking…";
  try {
    const chk = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "validatePin", pin: p1 })
    });
    const chkData = await chk.json();
    if (chkData && chkData.status === "success") {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
      return;
    }
    $("modalMsg").textContent = "Saving…";
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "addPin", name, pin: p1 })
    });
    const d = await r.json();
    const taken =
      (d && d.error === "PinAlreadyExists") ||
      (d && d.message && /already\s*(taken|exists)/i.test(String(d.message)));
    if (d && d.status === "success") {
      $("modalMsg").textContent = "✅ Saved";
      setTimeout(() => { $("modal").style.display = "none"; }, 1000);
    } else if (taken || r.status === 409) {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
    } else {
      $("modalMsg").textContent = "❌ Error";
    }
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};
</script>

</body>
</html>
