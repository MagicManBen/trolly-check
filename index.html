<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC - PIN Portal (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root {
      --bg: #0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444;
      --card:#111317; --line:#272a30; --btn:#2a2f36;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .panel { width: min(520px, 95vw); background:var(--panel); border-radius:20px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1,h2,h3 { margin:0 0 12px; }
    .muted { color:var(--muted); font-size:14px; }
    .center { text-align:center; }
    .hidden { display:none !important; }
    .btn { display:inline-flex; justify-content:center; align-items:center; padding:12px 16px; border-radius:12px; background:var(--btn); border:1px solid var(--line); color:var(--text); cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background:var(--accent); border-color:transparent; color:#04130a; font-weight:600; }
    .btn.danger { background:var(--danger); border-color:transparent; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; width:min(360px, 92%); margin:8px auto 0; }
    .pad { margin-top:14px; }
    .key { height:64px; padding:0; border-radius:12px; background:#2f3339; text-align:center; font-weight:700; font-size:26px; border:1px solid #3a3f46; box-shadow: inset 0 2px 0 rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; }
    .key:active { transform: scale(.98); }
    .pin-dots { display:flex; gap:8px; justify-content:center; margin:10px 0 6px; }
    .dot { width:14px; height:14px; border-radius:50%; background:#30363f; }
    .dot.filled {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent), 0 0 16px rgba(34, 197, 94, 0.6);
    }
    .row { display:flex; gap:10px; }
    input[type=text], input[type=password], select { background:#0f1216; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px; width:100%; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom:1px solid var(--line); padding:10px; text-align:left; }
    .topbar { position:fixed; left:0; right:0; top:0; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(to bottom, rgba(0,0,0,.5), transparent); }
    .pill { padding:6px 10px; background:#1e232b; border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:#0f1216; border:1px solid var(--line); padding:10px 14px; border-radius:10px; color:#fff; }
    .hr { border-top:1px solid var(--line); margin:14px 0; }
    .list { max-height: 260px; overflow:auto; border:1px solid var(--line); border-radius:10px; padding:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .art { margin: 16px auto 4px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
    .art img { max-width: 360px; width: 90%; height: auto; border-radius: 12px; border:1px solid var(--line); background:#0f1216; }
    .twocol { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: center; }
    @media (max-width: 720px) { .twocol { grid-template-columns: 1fr; } }

    /* --- Upload screen enhancements --- */
    #screen-upload h2 {
      font-size: clamp(1.6rem, 4vw, 2.2rem);
      animation: pulseTitle 2s ease-in-out infinite;
    }
    @keyframes pulseTitle {
      0%,100% { text-shadow: 0 0 8px rgba(34,197,94,.6); color: var(--accent); }
      50% { text-shadow: 0 0 18px rgba(34,197,94,.9); color: #b8f5b8; }
    }
    #qrUploadWrap {
      position: relative;
      padding: 14px;
      border-radius: 16px;
      background: var(--card);
      box-shadow: 0 0 16px rgba(34,197,94,.3), inset 0 0 18px rgba(34,197,94,.15);
      animation: glowQR 2.4s ease-in-out infinite;
    }
    @keyframes glowQR {
      0%, 100% { box-shadow: 0 0 16px rgba(34,197,94,.3), inset 0 0 18px rgba(34,197,94,.15); transform: scale(1); }
      50% { box-shadow: 0 0 28px rgba(34,197,94,.5), inset 0 0 26px rgba(34,197,94,.25); transform: scale(1.03); }
    }
    #screen-upload .muted {
      font-size: 1.05rem;
      animation: fadeHint 3.2s ease-in-out infinite;
    }
    @keyframes fadeHint {
      0%,100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    .glow { text-shadow: 0 2px 0 rgba(0,0,0,.6), 0 0 18px rgba(255,255,255,.35); }
    .btn.light { background:#ffffff; border-color:#d1d5db; color:#111; font-weight:600; box-shadow: 0 8px 24px rgba(0,0,0,.25), 0 0 0 0 rgba(34,197,94,.0); }
    .btn.light:active { transform: translateY(1px); }
    #btnBegin {
      position: relative;
      background: var(--accent) !important;
      border-color: transparent !important;
      color: #04130a !important;
      font-weight: 700;
      padding: 16px 22px;           /* bigger button */
      font-size: 1.1rem;            /* slightly larger text */
      border-radius: 14px;          /* a touch rounder */
      box-shadow: 0 10px 30px rgba(34,197,94,.55), 0 0 12px rgba(34,197,94,.45);
    }
    #btnBegin::after {
      content: "";
      position: absolute;
      inset: -10px;                 /* larger halo */
      border-radius: 18px;          /* match larger rounding */
      pointer-events: none;
      box-shadow: 0 0 0 0 rgba(34,197,94,.60);
      animation: btnPulse 1.8s ease-in-out infinite; /* faster, more obvious */
    }
    @keyframes btnPulse {
      0%   { box-shadow: 0 0 0 0 rgba(34,197,94,.60); }
      60%  { box-shadow: 0 0 36px 26px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    .fab { position: fixed; right: 22px; bottom: 22px; width:56px; height:56px; border-radius:50%; background: var(--accent); border: none; color:#04130a; font-size:28px; display:flex; justify-content:center; align-items:center; box-shadow: 0 10px 26px rgba(34,197,94,.40); }
    .footer { position: fixed; bottom: 10px; left:0; right:0; text-align:center; color: var(--muted); }
    /* Hide Exit Audit / Logout button */
    #btnLogout { display:none !important; }
    /* --- Audit in progress hero --- */
    .audit-hero{
      position:relative;
      height:100vh;
      width:100%;
      display:grid;
      grid-template-rows: 1fr 1fr; /* top half ring + text, bottom half images */
      align-items:center;
      justify-items:center;
      overflow:hidden;
      padding-top:40px;
    }
    .audit-center{
      position:relative;
      z-index:200;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding:32px 16px;
      text-align:center;
      width:100%;
      max-width:780px;
    }
    .audit-top{
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      height:100%;
    }
    .audit-bottom{
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      height:100%;
      padding: 8px 0 24px;
    }
    .audit-ring{
      position:relative;
      width:min(78vw,380px);
      height:min(78vw,380px);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:180;
    }
    .audit-ring:before,
    .audit-ring:after{
      content:"";
      position:absolute; inset:0; border-radius:50%;
    }
    .audit-ring:before{
      border:6px solid #1e8c1e;
      box-shadow:inset 0 0 40px rgba(30,140,30,.35), 0 0 26px rgba(30,140,30,.25);
      animation:pulseExpand 1.6s ease-in-out infinite;
    }
    .audit-ring:after{
      content:"";
      position:absolute; inset:-10px; border-radius:50%;
      border:0;
      box-shadow:0 0 0 0 rgba(30,140,30,.5);
      animation:ripple 1.6s ease-out infinite;
    }
    .audit-title{
      position:absolute;
      text-align:center;
      padding:0 24px;
      z-index:220;
    }
    .audit-title .big{
      font-size:clamp(1.6rem, 3.8vw, 2.2rem);
      font-weight:900;
      letter-spacing:.3px;
      text-shadow:0 2px 10px rgba(0,0,0,.6);
    }
    .audit-title .sub{
      margin-top:8px;
      font-size:clamp(1rem, 2.4vw, 1.15rem);
      color:#d3ffd3;
      line-height:1.35;
    }
    /* --- Upload counter (green flowing) --- */
    .upload-counter{
      position:relative;
      width:220px; height:220px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
    }
    .upload-counter:before{
      content:"";
      position:absolute; inset:0; border-radius:50%;
      border:6px solid #1e8c1e;
      box-shadow:inset 0 0 40px rgba(30,140,30,.35), 0 0 26px rgba(30,140,30,.25);
      animation:pulseExpand 1.6s ease-in-out infinite;
    }
    .upload-counter:after{
      content:"";
      position:absolute; inset:-10px; border-radius:50%;
      border:0;
      box-shadow:0 0 0 0 rgba(30,140,30,.5);
      animation:ripple 1.6s ease-out infinite;
    }
    .upload-title{ position:absolute; text-align:center; padding:0 12px; z-index:5; }
    .upload-title .num{ font-size:clamp(1.8rem, 5vw, 2.8rem); font-weight:900; color:#d3ffd3; text-shadow:0 2px 10px rgba(0,0,0,.6); }
    .upload-title .sub{ margin-top:4px; font-size:clamp(.9rem, 2.2vw, 1rem); color:#b8f5b8; }
    @keyframes pulseExpand{
      0%{ transform:scale(.95) }
      50%{ transform:scale(1.05) }
      100%{ transform:scale(.95) }
    }
    @keyframes ripple{
      0%{ box-shadow:0 0 0 0 rgba(30,140,30,.5); opacity:1 }
      100%{ box-shadow:0 0 0 24px rgba(30,140,30,0); opacity:0 }
    }
    .scan-bottom{
      display:block;
      max-width:min(70vw, 420px);
      width:90%;
      height:auto;
      opacity:1;
      pointer-events:auto;
      margin:0 auto;
    }
    /* --- Final reset emphasis (bigger text, same QR size) --- */
    #screen-reset h2 { font-size: clamp(2rem, 6vw, 2.6rem); }
    #screen-reset #resetInstruction { font-size: clamp(1.2rem, 4vw, 1.6rem); }
    #screen-reset #resetCountdown { font-size: clamp(1.1rem, 3.6vw, 1.4rem); }
    #screen-reset #btnResetDone { font-size: 1.15rem; padding: 14px 22px; }
    /* Keep QR at library default (220px) */
    #screen-reset #qrReset canvas, #screen-reset #qrReset img { width: 220px !important; height: 220px !important; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="pill" id="status">Not signed in</div>
    <div class="row">
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap" id="screen-login">
    <div class="panel center">
      <h1>Staff Portal</h1>
      <p class="muted">Sign in (one-time) with your email & password. Then staff use a 4‑digit PIN.</p>
      <div class="pad">
        <input id="loginEmail" type="text" placeholder="email@example.com">
      </div>
      <div class="pad">
        <input id="loginPass" type="password" placeholder="Password">
      </div>
      <div class="pad">
        <button class="btn primary" id="doLogin">Sign in</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-pin">
    <div class="panel center">
      <h2>Enter 4 digit PIN</h2>
      <div class="pin-dots">
        <div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div>
      </div>
      <div class="grid pad" id="pad">
        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
        <div class="key" style="grid-column:2">0</div>
      </div>
      <div class="pad"><button class="btn" id="btnClearPin">Clear</button></div>
      <div class="art"><img src="WristBand.png" alt="Wrist band / safety reminder"></div>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-begin">
    <div class="panel center">
      <h2 class="glow">Press the circle button on the scanner once and wait for 2 beeps</h2>
      <p class="muted">After 2 beeps, click the BEGIN button below</p>
      <div class="art"><img id="imgDoubleDeep" src="DoubleDeep.png" alt="Press the handheld once"></div>
      <div class="pad"><button class="btn light" id="btnBegin">Begin</button></div>
    </div>
  </div>


  <div class="wrap hidden" id="screen-scanning">
    <div class="panel center" style="background:transparent; box-shadow:none; width:100%; padding:0;">
      <div class="audit-hero">
        <div class="audit-top">
          <div class="audit-center">
            <div class="audit-ring" aria-hidden="true">
              <div class="audit-title">
                <div class="big">Audit in progress</div>
                <div class="sub">Scan the QR on each item as you check it.<br>When finished, return to this iPad.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="audit-bottom">
          <img src="ScanTrolly.png" alt="Scan items during your round" class="scan-bottom">
        </div>
      </div>
    </div>
  </div>

  <div class="wrap hidden" id="screen-review">
    <div class="panel center" style="width:min(820px, 96vw)">
<h2>Review & Submit</h2>
<div class="hr"></div>
<div id="reviewInfo" class="pill" style="margin:8px 0; display:inline-block;">Loading context…</div>
<div class="hr"></div>
<table id="reviewTable"><thead><tr><th>Name</th><th>Room</th><th>Check Type</th></tr></thead><tbody></tbody></table>
<div class="pad">
  <label for="comment" class="muted">Comments (optional)</label>
  <textarea id="comment" placeholder="Any notes" rows="4" style="width:100%; background:#0f1216; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px;"></textarea>
</div>
<div class="pad"><button class="btn primary" id="btnSubmit">Submit</button></div>
<p id="submitMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-upload">
    <div class="panel center">
      <h2>Upload from scanner</h2>
      <p class="muted">Scan this QR on the handheld to upload stored scans.</p>
      <div class="twocol">
        <div class="art"><img src="IPADSCAN.png" alt="Use the iPad to upload from handheld" id="imgIpadScan"></div>
        <div>
          <div class="art" id="qrUploadWrap"><div id="qrUpload"></div></div>
          <p id="uploadStatus" class="muted hidden">Captured: <span id="capCount">0</span></p>
        </div>
      </div>
      <input id="uploadInput" autocomplete="off" autocapitalize="off" spellcheck="false" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
    </div>
  </div>

  <div class="wrap hidden" id="screen-reset">
    <div class="panel center">
      <h2 class="glow">Final reset</h2>
      <p class="muted" id="resetInstruction">Scan this QR to finish.</p>
      <div class="art"><div id="qrReset" aria-label="Final reset QR code"></div></div>
      <p class="muted" id="resetCountdown"></p>
      <div class="pad"><button class="btn primary" id="btnResetDone">Done</button></div>
    </div>
  </div>


  <div class="footer">User: <span id="footerWho">—</span></div>
  <div id="toast" class="toast hidden"></div>

  <script>
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Production: always use authenticated client for reads
    function readClient(){ return sb; }

    // State
    const S = { siteId: null, user: null, staff: null, scans: [], itemsById: new Map(), types: [], typesByCategory: {} };

    // Helpers
    function $(id) { return document.getElementById(id); }
    let currentScreen = 'screen-login';
    function setTopbarFor(id){
    if (id === 'screen-begin') startDoubleDeepCycle(); else stopDoubleDeepCycle();
      currentScreen = id;
      const btn = $('btnLogout');
      if (!btn) return;
      const auditing = (id !== 'screen-login');
      btn.textContent = auditing ? 'Exit Audit' : 'Logout';
    }

    function show(id) {
      ['screen-login','screen-pin','screen-begin','screen-scanning','screen-upload','screen-review','screen-reset']
        .forEach(x => $(x).classList.add('hidden'));
      $(id).classList.remove('hidden');
      setTopbarFor(id);
    }
    function toast(msg) { const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); }
    // Update the banner with who/where and basic counts
    async function updateReviewInfo(scanned, matched){
      try{
        const { data } = await sb.auth.getUser();
        const email = data?.user?.email || '(not signed in)';
        const site = S.siteId == null ? '—' : String(S.siteId);
        const el = document.getElementById('reviewInfo');
        if (el){ el.textContent = `User: ${email}  •  Site: ${site}  •  Scanned: ${scanned}  •  Matched: ${matched}`; }
      }catch(e){ const el = document.getElementById('reviewInfo'); if (el) el.textContent = 'Context unavailable'; }
    }
    // Disable Submit when no check types are available
    function guardSubmitForTypes(){
      const b = document.getElementById('btnSubmit');
      const m = document.getElementById('submitMsg');
      if (!b) return;
      // At least one category has types
      const ok = S.typesByCategory && Object.values(S.typesByCategory).some(arr => Array.isArray(arr) && arr.length > 0);
      b.disabled = !ok;
      if (!ok && m) m.textContent = 'No check types available for this site. Please contact an admin.';
      else if (m) m.textContent = '';
    }
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    function pinDots(n) { for (let i=1;i<=4;i++) { const d=$('d'+i); if(!d) continue; d.classList.toggle('filled', i<=n); } }

    // Simple keypad click using WebAudio (works on iOS after first tap)
    let AC = null;
    function playClick(freq = 420, dur = 0.07) {
      try {
        AC = AC || new (window.AudioContext || window.webkitAudioContext)();
        const o = AC.createOscillator();
        const g = AC.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        o.connect(g);
        g.connect(AC.destination);
        const now = AC.currentTime;
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.14, now + 0.005);
        g.gain.exponentialRampToValueAtTime(0.00001, now + dur);
        o.start();
        o.stop(now + dur + 0.02);
      } catch(e) { /* no-op */ }
    }

    // QR code rendering helpers
    function renderQR(elId, text) {
      const el = $(elId); if (!el) return;
      el.innerHTML = '';
      if (typeof QRCode !== 'undefined') {
        new QRCode(el, { text, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      } else {
        el.textContent = text;
      }
    }
    function showUploadQR() { renderQR('qrUpload', '^&032&^'); }
    function showResetQR() { renderQR('qrReset', '^&030&^'); }
    function showUploadCounter(){
      const el = $('qrUpload'); if(!el) return;
      el.innerHTML = `
        <div class="upload-counter" aria-hidden="true">
          <div class="upload-title">
            <div class="num mono" id="uploadCount">0</div>
            <div class="sub">captured</div>
          </div>
        </div>`;
    }
    function updateUploadCounter(){
      const n = $('uploadCount'); if(n) n.textContent = String(S.scans.length);
    }
    let uploadQuietTimer = null;
    let resetInterval = null;
    let doubleDeepTimer = null;
    function startResetCountdown(seconds = 30) {
      if (resetInterval) { clearInterval(resetInterval); resetInterval = null; }
      const el = $('resetCountdown');
      let t = seconds;
      const tick = () => {
        if (el) el.textContent = `Auto return in ${t}s`;
        if (t <= 0) {
          clearInterval(resetInterval);
          resetInterval = null;
          show('screen-pin');
          return;
        }
        t -= 1;
      };
      tick();
      resetInterval = setInterval(tick, 1000);
    }
    function focusUploadInput(){ const u=$('uploadInput'); if(!u) return; u.value=''; u.focus(); }
    function scheduleUploadAutoContinue(){ if(uploadQuietTimer) clearTimeout(uploadQuietTimer); uploadQuietTimer = setTimeout(async ()=>{ await refreshReview(); show('screen-review'); }, 2000); }
    function startDoubleDeepCycle(){
  const img = $('imgDoubleDeep');
  if (!img) return;
  stopDoubleDeepCycle(); // ensure only one timer
  let alt = false;
  doubleDeepTimer = setInterval(()=>{
    alt = !alt;
    img.src = alt ? 'DoubleDeep2.png' : 'DoubleDeep.png';
  }, 1000);
}
function stopDoubleDeepCycle(){
  if (doubleDeepTimer) { clearInterval(doubleDeepTimer); doubleDeepTimer = null; }
  const img = $('imgDoubleDeep');
  if (img) img.src = 'DoubleDeep.png';
}
    // Helper to reset upload screen UI state
    function resetUploadUI(){
      if(uploadQuietTimer) { clearTimeout(uploadQuietTimer); uploadQuietTimer=null; }
      const wrap=$('qrUploadWrap'); if(wrap) wrap.classList.remove('hidden');
      const st=$('uploadStatus'); if(st) st.classList.add('hidden');
      const cnt=$('capCount'); if(cnt) cnt.textContent='0';
      const inp=$('uploadInput'); if(inp){ inp.value=''; }
    }

    // Ensure session -> get site -> show PIN

    // Lookup helper: fetch items by scanned IDs using Supabase client only (no REST fallback)
    async function fetchItemsByIds(siteId, codes){
      // Normalise to unique trimmed strings
      const ids = Array.from(new Set((codes||[]).map(c => String(c).trim())));
      if (!ids.length) return [];

      // --- 1) JS client: straightforward .in() with strings ---
      try{
        const { data, error } = await readClient()
          .from('items')
          .select('item_id, item_name, room, default_check_type, category')
          .eq('site_id', siteId)
          .in('item_id', ids);
        if (!error && Array.isArray(data) && data.length) return data;
      }catch(_){}

      return [];
    }
    async function init() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) { show('screen-login'); $('status').textContent = 'Not signed in'; return; }
      S.user = session.user;
      $('status').textContent = session.user.email;
      // Fetch profile -> site id
      const { data: prof, error } = await sb.from('profiles').select('site_id, full_name, role').eq('user_id', session.user.id).limit(1);
      if (error || !prof || !prof.length) { show('screen-login'); $('loginMsg').textContent = 'No profile/site. Please onboard first.'; return; }
      S.siteId = prof[0].site_id;
      $('status').textContent = `${session.user.email} • Site ${S.siteId}`;
      await preloadCache();
      show('screen-pin');
    }

    // Preload items and types for fast lookup
    async function preloadCache() {
      const i = await readClient().from('items').select('item_id, item_name, room, default_check_type, category').eq('site_id', S.siteId).order('item_name');
      if (!i.error) { S.itemsById.clear(); (i.data||[]).forEach(r=>S.itemsById.set(r.item_id, r)); }
      // Get check_types with category, and group by category
      const t = await readClient().from('check_types').select('name, category').eq('site_id', S.siteId).order('name');
      if (!t.error) {
        S.typesByCategory = {};
        (t.data || []).forEach(r => {
          if (!S.typesByCategory[r.category]) S.typesByCategory[r.category] = [];
          S.typesByCategory[r.category].push(r.name);
        });
      }
      guardSubmitForTypes();
    }

    // Login
    $('doLogin').addEventListener('click', async ()=>{
      $('loginMsg').textContent = 'Signing in…';
      const email = $('loginEmail').value.trim();
      const password = $('loginPass').value;
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { $('loginMsg').textContent = error.message; return; }
      await init();
    });

    $('btnLogout').addEventListener('click', onTopbarButton);

    // PIN keypad
    let pin = '';
    function onTopbarButton(){
      const auditing = (currentScreen !== 'screen-login');
      if (auditing) {
        if (!confirm('Are you sure? All progress will be lost.')) return;
        // Reset audit state
        S.scans = [];
        pin = '';
        pinDots(0);
        resetUploadUI();
        const sl = $('scanList'); if (sl) sl.innerHTML = '';
        const sc = $('scanCount'); if (sc) sc.textContent = '0';
        const cm = $('comment'); if (cm) cm.value = '';
        if (resetInterval) { clearInterval(resetInterval); resetInterval = null; }
        show('screen-pin');
        return;
      }
      // Full sign-out when not in an audit
      sb.auth.signOut().then(()=>{ $('footerWho').textContent = '—'; location.reload(); });
    }
    $('pad').addEventListener('click', async (e)=>{
      const k = e.target.closest('.key'); if (!k) return;
      const v = k.textContent.trim();
      if (/^\d$/.test(v)) { playClick(); if (pin.length<4) pin+=v; pinDots(pin.length); }
      if (pin.length === 4) { await tryPin(pin); }
    });
    $('btnClearPin').addEventListener('click', ()=>{ playClick(300, 0.08); pin=''; pinDots(0); });

    async function tryPin(p) {
      $('pinMsg').textContent = 'Checking…';
      try {
        const { data, error } = await sb
          .from('kiosk_users')
          .select('id, full_name, role')
          .eq('site_id', S.siteId)
          .eq('pin', p)
          .limit(1);
        if (error) { $('pinMsg').textContent = error.message; pin=''; pinDots(0); return; }
        if (!data || !data.length) { $('pinMsg').textContent = 'Invalid PIN'; pin=''; pinDots(0); return; }

        S.staff = { name: data[0].full_name, role: data[0].role || 'staff' };
        $('footerWho').textContent = S.staff.name;
        $('pinMsg').textContent = '';
        pin=''; pinDots(0);
        show('screen-begin');
      } catch (e) {
        $('pinMsg').textContent = e.message || String(e);
        pin=''; pinDots(0);
      }
    }

    // Begin -> scanning, auto-advance to upload after 10 seconds
    $('btnBegin').addEventListener('click', ()=>{
      S.scans = [];
      show('screen-scanning');
      setTimeout(()=>{
        resetUploadUI();
        show('screen-upload');
        showUploadQR();
        focusUploadInput();
      }, 10000);
    });

    function addScan(code) {
      if (S.scans.includes(code)) return;
      S.scans.push(code);
      // No on-page list during audit; items are reviewed later.
    }

    // Finish -> upload
    $('uploadInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const raw=e.target.value.trim(); e.target.value=''; const m=raw.match(/^\d{10}$/); if(!m){ scheduleUploadAutoContinue(); return; } const code=m[0]; if(!S.scans.includes(code)){ const wasEmpty = S.scans.length === 0; S.scans.push(code); if (wasEmpty) { showUploadCounter(); } updateUploadCounter(); } scheduleUploadAutoContinue(); }});
    $('btnResetDone').addEventListener('click', () => { if (resetInterval) { clearInterval(resetInterval); resetInterval = null; } show('screen-pin'); });

    async function refreshReview() {
      // Normalise scanned codes (strings, trimmed, unique)
      const codes = Array.from(new Set((S.scans || []).map(c => String(c).trim())));

      // Short-circuit if nothing scanned
      const tb = $('reviewTable')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = '';
      if (!codes.length) return;

      // Use siteId; hard-fail if not initialised
      const siteId = S.siteId;
      if (siteId == null) { toast('No site configured. Please sign out and sign in again.'); return; }

      // Fetch ONLY the scanned items for this site (with fallback)
      const rows = await fetchItemsByIds(siteId, codes);
      if (!rows || rows.length === 0) {
        toast('No matching items found for this site. Check scanned codes or permissions.');
      }

      // Build a quick lookup map (string keys)
      const byId = new Map();
      for (const r of (rows||[])) byId.set(String(r.item_id).trim(), r);

      guardSubmitForTypes();

      // Render rows in the same order as scanned
      for (const code of codes) {
        const it = byId.get(code);
        // Determine types for this item's category
        const category = it?.category || 'general';
        const types = S.typesByCategory?.[category] || S.typesByCategory?.general || [];

        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = it ? it.item_name : '(Unknown)';

        const tdRoom = document.createElement('td');
        tdRoom.textContent = it ? (it.room || '—') : '—';

        const tdType = document.createElement('td');
        const sel = document.createElement('select');
        sel.className = 'rowType';
        sel.setAttribute('data-item-id', code);
        for (const n of types) {
          const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o);
        }
        // Prefer per-item default if present and valid; otherwise fall back to first type
        const def = it && it.default_check_type;
        if (def && types.includes(def)) sel.value = def;
        else if (types.length) sel.value = types[0];
        tdType.appendChild(sel);

        tr.appendChild(tdName); tr.appendChild(tdRoom); tr.appendChild(tdType);
        tb.appendChild(tr);
      }
    }

    // Submit
    $('btnSubmit').addEventListener('click', async()=>{
      $('submitMsg').textContent='Submitting…';
      if (!S.scans.length) { $('submitMsg').textContent='No scans.'; return; }
      const selects = Array.from(document.querySelectorAll('.rowType'));
      const staffName = S.staff?.name || 'Staff';
      const comment = $('comment').value.trim();

      const sessionId = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
      const { data: sub, error: e1 } = await sb.from('submissions')
        .insert({ site_id: S.siteId, session_id: sessionId, staff_name: staffName, comment })
        .select('id').single();
      if (e1) { $('submitMsg').textContent = e1.message; return; }
      const sid = sub.id;
      const rows = [];
      for (const s of selects) {
        const itemId = s.getAttribute('data-item-id');
        const type = (s.value || 'Working');
        const value = 'Done';
        rows.push({ site_id: S.siteId, submission_id: sid, item_id: itemId, check_type: type, check_value: value });
      }
      const { error: e2 } = await sb.from('submission_rows').insert(rows);
      if (e2) { $('submitMsg').textContent = e2.message; return; }
      $('submitMsg').textContent='Submitted!';
      toast('Submission uploaded');
      S.scans = [];
      $('comment').value='';
      show('screen-reset');
      showResetQR();
      startResetCountdown(30);
    });


    init();
</script>
</body>
</html>
