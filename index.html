<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC Admin â€” Sites, Rooms, Items, Staff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script>
  (function(){
    // Allow manual override with ?noipad in the URL
    if (new URLSearchParams(location.search).has('noipad')) return;

    // Detect iPad:
    // 1) Older iPads include "iPad" in the user agent
    // 2) iPadOS 13+ reports as "Mac" but has touch support
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIpadUA = /\biPad\b/i.test(ua);
    const isIpadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // If we're on an iPad and not already on the iPad page, redirect
    if ((isIpadUA || isIpadOS) && !/indexipad\.html$/i.test(location.pathname)) {
      location.replace('indexipad.html');
    }
  })();
  </script>
  <style>
    :root{
      --bg:#0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444;
      --card:#111317; --line:#272a30; --btn:#2a2f36; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--panel);border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;font-size:18px;margin-bottom:12px}
    .status{font-size:12px;color:var(--muted);margin-bottom:16px}
    .nav button{width:100%;text-align:left;background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;margin-bottom:8px;cursor:pointer}
    .nav button.active{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    .main{padding:18px 18px 80px}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    .btn.warn{background:var(--warn);border-color:transparent;color:#111}
    .btn.danger{background:var(--danger);border-color:transparent}
    .btn.small{padding:6px 8px;border-radius:8px;font-size:12px}
    input, select, textarea{background:#0f1216;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    textarea{min-height:70px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);background:#121419;position:sticky;top:0}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:10px 0 14px 0;background:linear-gradient(to bottom, rgba(0,0,0,.3), transparent)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#1e232b;font-size:12px}
    .right{display:flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f1216;border:1px solid var(--line);padding:10px 14px;border-radius:10px}
    .danger-text{color:var(--danger)}
    .success-text{color:var(--accent)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .hr{border-top:1px solid var(--line);margin:12px 0}
    .table-wrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--card);max-height:60vh;overflow:auto}
    .chip{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b;cursor:pointer}
    .chip:hover{background:#222}
    .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi > div{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .big{font-size:24px;font-weight:800}
    .right input[type="text"]{width:220px}
    .danger-row{background:rgba(239,68,68,.08)}
    .ok-row{background:rgba(34,197,94,.08)}
    /* --- DASHBOARD --- */
    .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .dash-title{font-weight:800;letter-spacing:.2px}
    .stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;position:relative;overflow:hidden}
    .stat-card .label{color:var(--muted);font-size:12px}
    .stat-card .value{font-size:26px;font-weight:900}
    .stat-card.ok::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(34,197,94,.18), transparent)}
    .stat-card.warn::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(245,158,11,.18), transparent)}
    .stat-card.danger::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(239,68,68,.18), transparent)}
    .ring{--p:0; width:64px;height:64px;border-radius:50%;background:
      conic-gradient(var(--accent) calc(var(--p)*1%), #222 0);
      display:grid;place-items:center;border:1px solid var(--line)}
    .ring .inner{width:46px;height:46px;border-radius:50%;background:#0f1216;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
    .ring.small{width:42px;height:42px}.ring.small .inner{width:30px;height:30px;font-size:11px}
    .status-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--accent)}
    .dot.soon{background:var(--warn)}
    .dot.late{background:var(--danger)}
    .list-mini{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto}
    .mini{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--card)}
    .mini:hover{background:#111317}
    .mini .left{display:flex;flex-direction:column}
    .mini .title{font-weight:700}
    .mini .sub{color:var(--muted);font-size:12px}
    .mini .right{display:flex;align-items:center;gap:10px}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.85}50%{opacity:1}}
    .glow-red{box-shadow:0 0 0 0 rgba(239,68,68,.5);animation:glowRed 2s ease-in-out infinite}
    @keyframes glowRed{0%{box-shadow:0 0 0 0 rgba(239,68,68,.55)}70%{box-shadow:0 0 24px 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .glow-amber{box-shadow:0 0 0 0 rgba(245,158,11,.5);animation:glowAmber 2s ease-in-out infinite}
    @keyframes glowAmber{0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}70%{box-shadow:0 0 24px 12px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}

    /* Standard amendâ†’save affordances */
    .save-glow{box-shadow:0 0 0 0 rgba(34,197,94,.55);animation:glowGreen 2s ease-in-out infinite}
    @keyframes glowGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.55)}70%{box-shadow:0 0 24px 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .edit-pulse{border-color:var(--accent)!important;box-shadow:0 0 0 0 rgba(34,197,94,.45);animation:pulseGreen 1.8s ease-in-out infinite}
    @keyframes pulseGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}70%{box-shadow:0 0 20px 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}

    /* Desktop-friendly dashboard grid + extras */
    .hero-grid{display:grid;grid-template-columns:2fr 3fr;gap:12px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}
    .ring.lg{width:120px;height:120px}
    .ring.lg .inner{width:92px;height:92px;font-size:18px}
    .empty{color:var(--muted);padding:6px 0}
    .fade-in{animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @media (max-width:1100px){
      .hero-grid{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:repeat(2,1fr)}
    }

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:960px;width:min(960px,90vw);max-height:85vh;overflow:auto;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-full{width:min(1400px,96vw);height:92vh;display:flex;flex-direction:column}
    .modal-body{flex:1;overflow:auto;padding:8px 2px}
    .modal-header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding-bottom:10px;z-index:2}
    .title-lg{font-size:22px;font-weight:800}
    .title-lg.green{color:#39ff14}
    .modal-header.center-title{justify-content:center;text-align:center}
    .modal-header.center-title .right{position:absolute;right:20px;top:20px}
    .code-chip{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#0f1216}
    .modal .grid.cols-2{grid-template-columns:1.2fr 1fr}
    .modal input,.modal select,.modal textarea{font-size:16px}
    .modal .table-wrap{max-height:48vh}
    .modal .tools .btn.small{font-size:12px;padding:6px 8px}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">CQC Admin</div>
      <div class="status">
        <div id="who">Not signed in</div>
        <div id="site" class="muted">â€”</div>
      </div>
      <div class="nav">
        <button data-tab="tab-dashboard" class="active">Dashboard</button>
        <button data-tab="tab-rooms">Rooms</button>
        <button data-tab="tab-types">Check Types</button>
        <button data-tab="tab-items">Items</button>
        <button data-tab="tab-staff">Staff</button>
        <button data-tab="tab-teams">Teams</button>
        <button data-tab="tab-audits">Audit Log</button>
        <div class="hr"></div>
        <button id="btnLogout">Logout</button>
      </div>
    </aside>

    <main class="main">
      <!-- LOGIN PANEL -->
      <div id="panel-login" class="card">
        <h3>Sign in</h3>
        <div class="grid cols-3">
          <div><input id="loginEmail" type="text" placeholder="email@example.com"></div>
          <div><input id="loginPass" type="password" placeholder="Password"></div>
          <div><button class="btn primary" id="doLogin">Sign in</button></div>
        </div>
        <div id="loginMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- MAIN APP PANEL -->
      <div id="panel-app" class="hidden">
        <div class="topbar">
          <div class="pill">Admin</div>
          <div class="right">
            <input id="globalSearch" type="text" placeholder="Global searchâ€¦">
            <button class="btn" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="tab-dashboard">
          <div class="dash-header">
            <div class="dash-title">Overview</div>
          </div>

          <div class="hero-grid">
            <div class="card">
              <div class="row" style="gap:18px;align-items:center">
                <div class="ring lg" id="ringProgress"><div class="inner" id="ringInner">0%</div></div>
                <div>
                  <div class="muted">Scheduled checks</div>
                  <div class="dash-big" style="font-size:22px;font-weight:800;margin-top:4px" id="dashProgressText">â€”</div>
                  <div class="muted" style="font-size:12px;margin-top:6px">*of all scheduled items currently within their required window</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="stat-grid">
                <div class="stat-card ok fade-in">
                  <div class="label">OK</div>
                  <div class="value" id="statOk">â€”</div>
                </div>
                <div class="stat-card warn fade-in">
                  <div class="label">Due soon</div>
                  <div class="value" id="statSoon">â€”</div>
                </div>
                <div class="stat-card danger fade-in">
                  <div class="label">Overdue</div>
                  <div class="value" id="statLate">â€”</div>
                </div>
                <div class="stat-card fade-in">
                  <div class="label">Unscheduled</div>
                  <div class="value" id="statUnsch">â€”</div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div class="card">
              <div class="row" style="justify-content:space-between;align-items:center">
                <h3>Overdue</h3>
                <div class="status-badges" id="dashBadges"></div>
              </div>
              <div class="list-mini" id="dashOverdueBody"></div>
            </div>

            <div class="card">
              <h3>Due soon (next 7 days)</h3>
              <div class="list-mini" id="dashSoonBody"></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Due today</h3>
            <div class="list-mini" id="dashTodayBody"></div>
          </div>
        </section>

        <!-- ROOMS -->
        <section id="tab-rooms" class="hidden">
          <div class="card">
            <h3>Add room</h3>
            <div class="row">
              <input id="roomName" type="text" placeholder="Room name">
              <button class="btn primary" id="addRoom">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Rooms</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Owner</th><th>Actions</th></tr></thead>
                <tbody id="roomsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CHECK TYPES -->
        <section id="tab-types" class="hidden">
          <div class="card">
            <h3>Add check type</h3>
            <div class="grid cols-2">
              <input id="typeName" type="text" placeholder="Name (e.g., Date Check)">
              <button class="btn primary" id="addType">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Check types</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Team</th><th>Active</th><th>Actions</th></tr></thead>
                <tbody id="typesBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ITEMS CONFIGURATOR -->
        <section id="tab-items" class="hidden">
          <!-- ITEM PICKER FULL WIDTH -->
          <div class="card">
            <h3>Find & select an item</h3>
            <div class="row" style="margin-bottom:10px">
              <input id="itemSearch" type="text" placeholder="Search by code, name, roomâ€¦">
              <button class="btn" id="refreshItems">Refresh</button>
            </div>
            <div class="table-wrap" style="max-height:42vh">
              <table>
                <thead><tr><th style="width:140px">Code</th><th>Name</th><th>Room</th><th></th></tr></thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Configuration Modal -->
          <div id="cfgModal" class="modal-overlay hidden">
            <div class="modal modal-full" role="document">
              <div class="modal-header center-title">
                <div>
                  <div class="title-lg green" id="cfgName">â€”</div>
                </div>
                <div class="right">
                  <button class="btn" id="cfgClose">Close</button>
                </div>
              </div>
              <div class="modal-body">
                <div id="itemConfig">
                  <div class="card" style="margin:0 0 10px 0">
                    <h3>Details</h3>
                    <div class="grid cols-2">
                      <div>
                        <div class="muted">Item ID (code)</div>
                        <div class="row" style="gap:8px">
                          <input id="cfgCodeInput" type="text" readonly>
                          <button class="btn small" id="cfgEnableEditCode">Change</button>
                        </div>
                      </div>
                      <div>
                        <div class="muted">Room</div>
                        <select id="cfgRoom"></select>
                      </div>
                      <div>
                        <div class="muted">Owner (team)</div>
                        <select id="cfgOwnerRole"></select>
                      </div>
                    </div>
                    <div class="row" style="margin-top:10px;justify-content:flex-start">
                      <button class="btn primary" id="cfgSaveDetails">Save details</button>
                      <span class="muted">Owner will be stored until we add firstâ€‘class support.</span>
                    </div>
                  </div>

                  <div class="card" style="margin:0">
                    <h3>Check plan</h3>
                    <div class="grid cols-3" style="align-items:end">
                      <div>
                        <div class="muted">Check type</div>
                        <select id="planTypeNew"></select>
                      </div>
                      <div>
                        <div class="muted">Frequency (interval)</div>
                        <input id="planFreqNew" type="text" placeholder="e.g., 1 week">
                      </div>
                      <div class="row" style="gap:8px">
                        <button class="btn primary" id="planAdd">Add check</button>
                        <div class="tools">
                          <button class="btn small" data-quick="1 week">1w</button>
                          <button class="btn small" data-quick="2 weeks">2w</button>
                          <button class="btn small" data-quick="1 month">1m</button>
                        </div>
                      </div>
                    </div>

                    <div class="table-wrap" style="margin-top:10px">
                      <table>
                        <thead>
                          <tr>
                            <th>Type</th><th>Owner team</th><th>Frequency</th><th>Warn before</th><th>Required</th><th>Active</th><th></th>
                          </tr>
                        </thead>
                        <tbody id="planBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OPTIONAL: legacy add/update + CSV import remain below for now -->
        </section>

        <!-- TEAMS -->
        <section id="tab-teams" class="hidden">
          <div class="card">
            <h3>Add team</h3>
            <div class="row">
              <input id="teamName" type="text" placeholder="Team name (e.g., Nurses)">
              <button class="btn primary" id="addTeam">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Teams</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Name</th><th>Members</th><th>Add member</th><th>Actions</th></tr>
                </thead>
                <tbody id="teamsBody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- STAFF -->
        <section id="tab-staff" class="hidden">
          <div class="card">
            <h3>Add staff</h3>
            <div class="grid cols-3">
              <input id="staffName" type="text" placeholder="Full name">
              <select id="staffRole">
                <option value="staff">staff</option>
                <option value="admin">admin</option>
              </select>
              <button class="btn primary" id="addStaff">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Staff</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Role</th><th>Teams</th><th>PIN</th><th>Actions</th></tr></thead>
                <tbody id="staffBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AUDITS -->
        <section id="tab-audits" class="hidden">
          <div class="card">
            <h3>Audit log</h3>
            <div class="tools" style="margin-bottom:8px">
              <input id="auditSearch" type="text" placeholder="Search (name, item, code, type)">
              <button class="btn" id="refreshAudits">Refresh</button>
              <button class="btn" id="exportAudits">Export CSV</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>When</th><th>Staff</th><th>Code</th><th>Item</th><th>Room</th><th>Type</th><th>Value</th>
                  </tr>
                </thead>
                <tbody id="auditsBody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Room Items Modal -->
  <div id="roomItemsModal" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="title-lg" id="roomItemsTitle">Items in room</div>
        <div class="right"><button class="btn" id="roomItemsClose">Close</button></div>
      </div>
      <div class="modal-body">
        <div id="roomItemsList" class="list-mini"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== STATE ======
    const S = {
      user: null, profile: null, siteId: null,
      rooms: [], types: [], typesByCat: {}, items: [], staff: [], audits: [],
      dashStatus: [], dashSummary: [],
      teams: [], teamMembers: [], checkTypeTeams: [],
      typeTeamById: {}, typeTeamByName: {}
    };
    S.selectedItem = null;
    S.selectedItemPlan = [];

    // ====== HELPERS ======
    function $(id){ return document.getElementById(id); }
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
    function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(_){ return s; } }
    function setActiveTab(id){
      document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $(id)?.classList.remove('hidden');
    }
    function updateKPIs(){
      $('kpiRooms').textContent = S.rooms.length;
      $('kpiTypes').textContent = S.types.length;
      $('kpiItems').textContent = S.items.length;
      $('kpiStaff').textContent = S.staff.length;
    }
    function buildTypesByCat(){
      S.typesByCat = {};
      for (const t of S.types.filter(x=>x.active !== false)){
        if (!S.typesByCat[t.category]) S.typesByCat[t.category] = [];
        S.typesByCat[t.category].push(t);
      }
      for(const k in S.typesByCat){ S.typesByCat[k].sort((a,b)=>a.name.localeCompare(b.name)); }
    }
    function fillItemPickers(){
      // Legacy form removed â€” safely bail if controls don't exist
      const rSel = $('itemRoom');
      const tSel = $('itemType');
      const catEl = $('itemCategory');
      if(!rSel || !tSel || !catEl) return;
      // Rooms
      rSel.innerHTML = '';
      const rOpt = (id, name)=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; rSel.appendChild(o); };
      const sortedRooms = [...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sortedRooms.length===0){ rOpt('', '(no rooms yet)'); } else { sortedRooms.forEach(r=>rOpt(r.id, r.name)); }
      // Types (by selected category)
      const cat = catEl.value || 'general';
      tSel.innerHTML = '';
      const types = S.typesByCat[cat] || S.typesByCat['general'] || [];
      if(types.length===0){
        const o=document.createElement('option'); o.value=''; o.textContent='(no types for '+cat+')'; tSel.appendChild(o);
      }else{
        for(const t of types){ const o=document.createElement('option'); o.value=t.name; o.textContent=t.name; tSel.appendChild(o); }
      }
    }
    function filterTextMatch(hay, needle){
      const n = (needle||'').trim().toLowerCase();
      if(!n) return true;
      return (hay||'').toString().toLowerCase().includes(n);
    }
    function download(filename, text){
      const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click();
    }

    function isPinSet(v){
      // Treat PIN as set when the plain pin column has a non-empty value
      // and is not the placeholder string 'EMPTY'.
      return typeof v === 'string' && v.trim() !== '' && v.trim().toUpperCase() !== 'EMPTY';
    }

    function openCfgModal(){ const m=$('cfgModal'); if(m) m.classList.remove('hidden'); }
    function closeCfgModal(){ const m=$('cfgModal'); if(m) m.classList.add('hidden'); }

    // Room items modal helpers
    function openRoomItemsModal(title, items){
      const m = $('roomItemsModal');
      const titleEl = $('roomItemsTitle');
      const list = $('roomItemsList');
      if(titleEl) titleEl.textContent = title || 'Items';
      if(list){
        if(!items || items.length===0){
          list.innerHTML = '<div class="empty">No items in this room</div>';
        }else{
          list.innerHTML = items.map(n => `<div class="mini"><div class="left"><div class="title">${n}</div></div></div>`).join('');
        }
      }
      if(m) m.classList.remove('hidden');
    }
    function closeRoomItemsModal(){ const m=$('roomItemsModal'); if(m) m.classList.add('hidden'); }

    // ====== INIT & AUTH ======
    async function init(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session){ $('panel-login').classList.remove('hidden'); $('panel-app').classList.add('hidden'); return; }
      S.user = session.user;
      $('who').textContent = S.user.email || 'Signed in';
      // Get profile -> site
      const { data: prof, error } = await sb.from('profiles').select('site_id, full_name, role').eq('user_id', S.user.id).limit(1);
      if(error || !prof || !prof.length){ $('site').textContent='No profile/site'; toast(error?.message||'No profile'); return; }
      S.profile = prof[0]; S.siteId = S.profile.site_id;
      $('site').textContent = `Site ${S.siteId}`;
      $('panel-login').classList.add('hidden');
      $('panel-app').classList.remove('hidden');
      await refreshAll();
    }

    async function refreshAll(){
      await Promise.all([
        loadRooms(), loadTypes(), loadItems(), loadStaff(), loadAudits(),
        loadCheckStatus(), loadCheckSummary(),
        loadTeams(), loadTeamMembers(), loadCheckTypeTeams()
      ]);
      buildTypesByCat();
      buildTypeTeamMap();
      fillItemPickers();
      renderRooms(); renderTypes(); renderItems(); renderStaff(); renderTeams(); renderAudits(); renderDashboard();
      updateKPIs();
    }
    async function loadCheckStatus(){
      const { data, error } = await sb.from('v_item_check_status')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashStatus = data||[]; else toast(error.message);
    }
    async function loadCheckSummary(){
      const { data, error } = await sb.from('v_item_check_summary')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashSummary = data||[]; else toast(error.message);
    }
    function relTime(toIso){
      const t = new Date(toIso).getTime();
      const now = Date.now();
      const diff = Math.round((t - now)/1000); // seconds
      const abs = Math.abs(diff);
      const d = Math.floor(abs/86400), h = Math.floor((abs%86400)/3600), m = Math.floor((abs%3600)/60);
      const base = d ? `${d}d ${h}h` : h ? `${h}h ${m}m` : `${m}m`;
      return diff >= 0 ? `in ${base}` : `${base} ago`;
    }
    function setRing(percent){
      const p = Math.max(0, Math.min(100, Math.round(percent)));
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      if(ring) ring.style.setProperty('--p', p);
      if(inner) inner.textContent = p + '%';
    }

    function animateNumber(el, to){
      if(!el) return;
      const from = parseInt(el.getAttribute('data-prev')||el.textContent||'0',10) || 0;
      const start = performance.now(), dur = 450;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const val = Math.round(from + (to-from)*t);
        el.textContent = val;
        if(t < 1) requestAnimationFrame(step); else el.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function setRingAnimated(percent){
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      const from = parseInt(inner?.getAttribute('data-prev')||'0',10) || 0;
      const to = Math.max(0, Math.min(100, Math.round(percent)));
      const start = performance.now(), dur = 650;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const p = Math.round(from + (to-from)*t);
        if(ring) ring.style.setProperty('--p', p);
        if(inner) inner.textContent = p + '%';
        if(t < 1) requestAnimationFrame(step); else inner?.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function renderDashboard(){
      // summary badges
      const byStatus = Object.fromEntries(S.dashSummary.map(r => [r.status, r.count]));
      const ok = byStatus.ok||0, soon = byStatus.due_soon||0, late = byStatus.overdue||0, uns = byStatus.unscheduled||0;
      // progress ring considers only scheduled items
      const scheduled = ok + soon + late;
      const pct = scheduled ? Math.round((ok / scheduled) * 100) : 0;
      setRingAnimated(pct);
      const progText = document.getElementById('dashProgressText');
      if(progText) progText.textContent = `${ok}/${scheduled} within window`;

      const badgeWrap = document.getElementById('dashBadges');
      if(badgeWrap){
        badgeWrap.innerHTML = `
          <span class="badge"><span class="dot ok"></span> OK ${ok}</span>
          <span class="badge"><span class="dot soon"></span> Due soon ${soon}</span>
          <span class="badge"><span class="dot late"></span> Overdue ${late}</span>
          <span class="badge"><span class="dot"></span> Unscheduled ${uns}</span>`;
      }
      animateNumber($('statOk'), ok);
      animateNumber($('statSoon'), soon);
      animateNumber($('statLate'), late);
      animateNumber($('statUnsch'), uns);

      // partition lists
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);

      const overdue = S.dashStatus.filter(x => x.status === 'overdue')
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));
      const dueSoon = S.dashStatus.filter(x => x.status === 'due_soon' && new Date(x.next_due_at) > todayEnd)
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at))
        .filter(x => (new Date(x.next_due_at) - todayEnd) <= 7*86400000); // next 7 days
      const dueToday = S.dashStatus.filter(x => {
        const d = new Date(x.next_due_at);
        return d >= todayStart && d <= todayEnd && (x.status === 'due_soon' || x.status === 'overdue');
      }).sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));

      function rowHTML(x, cls){
        const due = new Date(x.next_due_at);
        const ownerTeam = S.typeTeamByName[x.check_type]?.name || '';
        const title = `${x.item_name} â€¢ ${x.check_type}`;
        const sub = `${x.room_name||''} â€¢ due ${due.toLocaleString()} â€¢ ${relTime(x.next_due_at)}`;
        return `<div class="mini ${cls}">
          <div class="left">
            <div class="title">${title}</div>
            <div class="sub">${sub}</div>
          </div>
          <div class="right">
            ${ownerTeam ? `<span class="tag" title="owner team">${ownerTeam}</span>` : ''}
            <div class="ring small" style="--p:0"><div class="inner" title="frequency">${x.frequency}</div></div>
            <button class="btn small" data-act="manageItem" data-code="${x.item_code}">Manage</button>
          </div>
        </div>`;
      }

      const od = $('dashOverdueBody'); if(od) od.innerHTML = overdue.map(x => rowHTML(x, 'glow-red')).join('') || '<div class="empty">Nothing overdue ðŸŽ‰</div>';
      const ds = $('dashSoonBody'); if(ds) ds.innerHTML = dueSoon.map(x => rowHTML(x, 'glow-amber')).join('') || '<div class="empty">Nothing due soon</div>';
      const td = $('dashTodayBody'); if(td) td.innerHTML = dueToday.map(x => rowHTML(x, 'pulse')).join('') || '<div class="empty">Nothing due today</div>';
    }

    // ====== LOADERS ======
    async function loadRooms(){
      const { data, error } = await sb.from('rooms').select('id,name,occupied_by').eq('site_id', S.siteId).order('name');
      if(!error) S.rooms = data||[]; else toast(error.message);
    }
    async function loadTypes(){
      const { data, error } = await sb.from('check_types').select('id,name,category,active').eq('site_id', S.siteId).order('name');
      if(!error) S.types = data||[]; else toast(error.message);
    }
    async function loadItems(){
      const { data, error } = await sb.from('v_items_admin')
        .select('id,site_id,item_id,item_name,category,active,room_id,room_name,default_check_type_id,default_check_type_name,comments')
        .eq('site_id', S.siteId).order('item_name');
      if(!error) S.items = data||[]; else toast(error.message);
    }
    async function loadStaff(){
      const { data, error } = await sb.from('kiosk_users').select('id,full_name,role,pin').eq('site_id', S.siteId).order('full_name');
      if(!error) S.staff = data||[]; else toast(error.message);
    }
    async function loadAudits(){
      const { data, error } = await sb.from('v_submission_detail')
        .select('*').eq('site_id', S.siteId).order('submitted_at', { ascending:false }).limit(200);
      if(!error) S.audits = data||[]; else toast(error.message);
    }

    async function loadTeams(){
      const { data, error } = await sb.from('teams')
        .select('id,name').eq('site_id', S.siteId).order('name');
      if(!error) S.teams = data||[]; else toast(error.message);
    }
    async function loadTeamMembers(){
      const { data, error } = await sb.from('team_members')
        .select('team_id,user_id').eq('site_id', S.siteId);
      if(!error) S.teamMembers = data||[]; else toast(error.message);
    }
    async function loadCheckTypeTeams(){
      const { data, error } = await sb.from('check_type_teams')
        .select('check_type_id,team_id').eq('site_id', S.siteId);
      if(!error) S.checkTypeTeams = data||[]; else toast(error.message);
      buildTypeTeamMap();
    }

    function buildTypeTeamMap(){
      S.typeTeamById = {}; S.typeTeamByName = {};
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t]));
      for(const m of (S.checkTypeTeams||[])){
        const team = teamById[m.team_id];
        if(team) S.typeTeamById[m.check_type_id] = team;
      }
      for(const t of (S.types||[])){
        const team = S.typeTeamById[t.id];
        if(team) S.typeTeamByName[t.name] = team;
      }
    }

    // ====== RENDERERS ======
    function renderRooms(){
      const tb=$('roomsBody'); tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      const staffOptions = ['<option value="">(none)</option>']
        .concat((S.staff||[]).map(s=>`<option value="${s.id}">${s.full_name}</option>`))
        .join('');

      for(const r of S.rooms){
        const ownerName = r.occupied_by ? (staffById[r.occupied_by] || '') : '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td data-cell="owner">
            <span class="owner-text">${ownerName || ''}</span>
            <select class="owner-select hidden">${staffOptions}</select>
          </td>
          <td class="tools">
            <button class="btn small" data-act="viewItems" data-id="${r.id}" data-room-name="${r.name}">View items</button>
            <button class="btn small" data-act="editOwner" data-id="${r.id}" data-mode="edit">Edit owner</button>
            <button class="btn small hidden" data-act="cancelOwner" data-id="${r.id}">Cancel</button>
            <button class="btn small" data-act="rename" data-id="${r.id}">Rename</button>
            <button class="btn small danger" data-act="del" data-id="${r.id}">Delete</button>
          </td>`;
        const sel = tr.querySelector('select.owner-select');
        if(sel) sel.value = r.occupied_by || '';
        tb.appendChild(tr);
      }
    }

    function renderTypes(){
      const tb=$('typesBody'); tb.innerHTML='';
      const teamOpts = ['<option value="">(none)</option>']
        .concat((S.teams||[]).map(t=>`<option value="${t.id}">${t.name}</option>`))
        .join('');
      for(const t of S.types){
        const selectedTeam = S.typeTeamById[t.id]?.id || '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>
            <select class="type-team-select" data-act="typeTeam" data-id="${t.id}">
              ${teamOpts}
            </select>
          </td>
          <td>${t.active===false?'<span class="danger-text">no</span>':'yes'}</td>
          <td class="tools">
            <button class="btn small" data-act="toggleType" data-id="${t.id}">${t.active===false?'Activate':'Deactivate'}</button>
            <button class="btn small" data-act="renameType" data-id="${t.id}">Rename</button>
            <button class="btn small danger" data-act="delType" data-id="${t.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
        const sel = tr.querySelector('select.type-team-select');
        if(sel) sel.value = selectedTeam;
      }
    }

    function renderTeams(){
      const tb=$('teamsBody'); if(!tb) return; tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      for(const team of (S.teams||[])){
        const members = (S.teamMembers||[]).filter(m=>m.team_id===team.id).map(m=>({ id:m.user_id, name:staffById[m.user_id]||'?' }));
        const memberChips = members.length
          ? members.map(m=>`<span class="chip" data-act="removeMember" data-team="${team.id}" data-user="${m.id}">${m.name} âœ•</span>`).join(' ')
          : '<span class="muted">(no members)</span>';
        const nonMembers = (S.staff||[]).filter(s=>!members.some(m=>m.id===s.id));
        const addOpts = ['<option value="">Select staffâ€¦</option>']
          .concat(nonMembers.map(s=>`<option value="${s.id}">${s.full_name}</option>`)).join('');
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${team.name}</td>
          <td>${memberChips}</td>
          <td class="row" style="gap:8px">
            <select class="team-add-member" data-team="${team.id}">${addOpts}</select>
            <button class="btn small" data-act="addMember" data-team="${team.id}">Add</button>
          </td>
          <td class="tools">
            <button class="btn small" data-act="renameTeam" data-id="${team.id}">Rename</button>
            <button class="btn small danger" data-act="delTeam" data-id="${team.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderItems(){
      const q = $('itemSearch')?.value || $('globalSearch')?.value || '';
      const tb=$('itemsBody'); if(!tb) return; tb.innerHTML='';
      const rows = S.items.filter(r =>
        filterTextMatch(r.item_id, q) || filterTextMatch(r.item_name, q) || filterTextMatch(r.room_name, q)
      );
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.item_id}</td>
          <td>${r.item_name}</td>
          <td>${r.room_name||'<span class="muted">(none)</span>'}</td>
          <td class="tools">
            <button class="btn small" data-act="cfg" data-code="${r.item_id}">Configure</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    // Loader for single item's plan
    async function loadItemPlan(itemCode){
      // resolve item pk
      const it = S.items.find(x=>x.item_id===itemCode);
      if(!it){ S.selectedItemPlan=[]; return; }
      const { data, error } = await sb
        .from('item_allowed_types')
        .select('id, site_id, item_id, check_type_id, frequency, warn_before, required, active, check_types!inner(name)')
        .eq('site_id', S.siteId)
        .eq('item_id', it.id);
      if(error){ toast(error.message); S.selectedItemPlan=[]; return; }
      // map shape
      S.selectedItemPlan = (data||[]).map(d=>({
        id: d.id, check_type_id: d.check_type_id, check_type_name: d.check_types.name,
        frequency: d.frequency, warn_before: d.warn_before, required: d.required, active: d.active
      }));
    }
    // Configurator helpers/renderers
    function fillOwnerRoles(){
      // Now shows TEAMS instead of roles
      const sel=$('cfgOwnerRole'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); };
      mk('','(none)');
      const sortedTeams = [...(S.teams||[])].sort((a,b)=>a.name.localeCompare(b.name));
      sortedTeams.forEach(t=>mk(t.name, t.name));
    }
    function fillCfgRooms(){
      const sel=$('cfgRoom'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); };
      const sorted=[...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sorted.length===0) mk('', '(no rooms yet)'); else sorted.forEach(r=>mk(r.id,r.name));
    }
    function fillPlanTypePicker(item){
      const tSel=$('planTypeNew'); if(!tSel) return; tSel.innerHTML='';
      const types = S.typesByCat[item?.category||'general'] || S.typesByCat.general || [];
      const mk=(v)=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=v.name; tSel.appendChild(o); };
      if(types.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='(no types for category)'; tSel.appendChild(o); }
      else types.forEach(mk);
    }
    function renderPlan(){
      const tb=$('planBody'); if(!tb) return; tb.innerHTML='';
      if(!S.selectedItem){ tb.innerHTML='<tr><td colspan="7" class="muted">Select an item.</td></tr>'; return; }
      for(const row of S.selectedItemPlan){
        const ownerTeam = (S.typeTeamByName[row.check_type_name]?.name) || '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${row.check_type_name}</td>
          <td>${ownerTeam ? `<span class="tag">${ownerTeam}</span>` : '<span class="muted">(none)</span>'}</td>
          <td><input class="mono" type="text" data-field="frequency" data-id="${row.id}" value="${row.frequency||''}" placeholder="e.g., 1 week"></td>
          <td><input class="mono" type="text" data-field="warn_before" data-id="${row.id}" value="${row.warn_before||'3 days'}" placeholder="e.g., 2 days"></td>
          <td><input type="checkbox" data-field="required" data-id="${row.id}" ${row.required?'checked':''}></td>
          <td><input type="checkbox" data-field="active" data-id="${row.id}" ${row.active?'checked':''}></td>
          <td class="tools">
            <button class="btn small" data-act="savePlan" data-id="${row.id}">Save</button>
            <button class="btn small danger" data-act="delPlan" data-id="${row.id}">Remove</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    async function savePlanRow(id){
      const row = S.selectedItemPlan.find(x=>x.id===Number(id));
      if(!row) return;
      const freq = document.querySelector(`input[data-field="frequency"][data-id="${id}"]`)?.value || '0 days';
      const warn = document.querySelector(`input[data-field="warn_before"][data-id="${id}"]`)?.value || '3 days';
      const required = document.querySelector(`input[data-field="required"][data-id="${id}"]`)?.checked || false;
      const active = document.querySelector(`input[data-field="active"][data-id="${id}"]`)?.checked || false;
      // Use RPC to upsert by name
      await sb.rpc('admin_set_item_check', {
        p_site_id: S.siteId,
        p_item_code: S.selectedItem.item_id,
        p_check_type_name: row.check_type_name,
        p_frequency: freq,
        p_warn_before: warn,
        p_required: required,
        p_active: active
      }).then(async ({ error })=>{
        if(error) return toast(error.message);
        await loadItemPlan(S.selectedItem.item_id); renderPlan(); toast('Plan saved');
      });
    }

    function renderStaff(){
      const tb=$('staffBody'); tb.innerHTML='';
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t.name]));
      const teamsForUser = (uid)=> (S.teamMembers||[]).filter(m=>m.user_id===uid).map(m=>teamById[m.team_id]).filter(Boolean);
      for(const s of S.staff){
        const tnames = teamsForUser(s.id);
        const teamHtml = tnames.length ? tnames.map(n=>`<span class=\"tag\">${n}</span>`).join(' ') : '<span class=\"muted\">(none)</span>';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${s.full_name}</td>
          <td>${s.role}</td>
          <td>${teamHtml}</td>
          <td>${isPinSet(s.pin) ? 'set' : '<span class=\"muted\">not set</span>'}</td>
          <td class=\"tools\">
            <button class=\"btn small\" data-act=\"setPin\" data-id=\"${s.id}\">Set PIN</button>
            <button class=\"btn small\" data-act=\"renameStaff\" data-id=\"${s.id}\">Rename</button>
            <button class=\"btn small\" data-act=\"roleStaff\" data-id=\"${s.id}\">Change role</button>
            <button class=\"btn small danger\" data-act=\"delStaff\" data-id=\"${s.id}\">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderAudits(){
      const q=$('auditSearch').value||'';
      const tb=$('auditsBody'); tb.innerHTML='';
      const rows = S.audits.filter(r =>
        filterTextMatch(r.staff_name,q) || filterTextMatch(r.item_name,q) || filterTextMatch(r.scanned_code,q) || filterTextMatch(r.check_type,q)
      );
      for(const a of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(a.submitted_at)}</td>
          <td>${a.staff_name}</td>
          <td class="mono">${a.scanned_code}</td>
          <td>${a.item_name||''}</td>
          <td>${a.room||''}</td>
          <td>${a.check_type||''}</td>
          <td>${a.check_value||''}</td>`;
        tb.appendChild(tr);
      }
    }

    // ====== ACTIONS ======
    // Login
    $('doLogin').addEventListener('click', async ()=>{
      $('loginMsg').textContent = 'Signing inâ€¦';
      const email=$('loginEmail').value.trim(), password=$('loginPass').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ $('loginMsg').textContent = error.message; return; }
      $('loginMsg').textContent='';
      await init();
    });
    $('btnLogout').addEventListener('click', async ()=>{
      await sb.auth.signOut(); location.reload();
    });

    // Navigation
    document.querySelectorAll('.nav button[data-tab]').forEach(b=>b.addEventListener('click', ()=> setActiveTab(b.dataset.tab)));
    $('btnRefresh').addEventListener('click', refreshAll);
    $('globalSearch').addEventListener('input', ()=>{ renderItems(); renderAudits(); });

    // Dashboard (quick adds removed) â€” guard in case old elements exist in cached HTML
    const _qaAddRoom = $('qaAddRoom');
    if(_qaAddRoom){ _qaAddRoom.addEventListener('click', ()=>{/* removed */}); }
    const _qaAddStaff = $('qaAddStaff');
    if(_qaAddStaff){ _qaAddStaff.addEventListener('click', ()=>{/* removed */}); }
    function openItemInForm(code){
      const it=S.items.find(x=>x.item_id===code);
      if(!it){ toast('Item not found'); return; }
      setActiveTab('tab-items');
      S.selectedItem = it;
      openCfgModal();
      $('cfgCodeInput').value = it.item_id;
      $('cfgCodeInput').readOnly = true;
      $('cfgName').textContent = it.item_name || '';
      // Reset Change button and input affordances
      const _btnEC = $('cfgEnableEditCode');
      if(_btnEC){
        _btnEC.textContent = 'Change';
        _btnEC.classList.remove('save-glow');
        _btnEC.dataset.mode = 'change';
      }
      $('cfgCodeInput').classList.remove('edit-pulse');
      fillCfgRooms();
      fillOwnerRoles();
      fillPlanTypePicker(it);
      if(it.room_name) $('cfgRoom').value = it.room_name;
      $('cfgOwnerRole').value = '';
      loadItemPlan(code).then(()=> renderPlan());
      toast('Opened in configurator');
    }
    // Dashboard manage buttons
    document.getElementById('tab-dashboard').addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-act="manageItem"]'); if(!b) return;
      const code=b.dataset.code; openItemInForm(code);
    });

    // Rooms tab
    $('addRoom').addEventListener('click', async ()=>{
      const name=$('roomName').value.trim(); if(!name) return;
      const { error } = await sb.from('rooms').insert({ site_id:S.siteId, name });
      if(error) return toast(error.message);
      $('roomName').value=''; await loadRooms(); renderRooms(); fillItemPickers(); updateKPIs(); toast('Room added');
    });
    $('roomsBody').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const id=Number(btn.dataset.id); const act=btn.dataset.act;
      const tr = btn.closest('tr');

      if(act==='viewItems'){
        // find room & items in that room
        const room = S.rooms.find(rr=>rr.id===id);
        const roomName = room?.name || btn.getAttribute('data-room-name') || 'Room';
        // Use either room_id or fallback to string match
        const items = (S.items||[])
          .filter(it => (it.room_id === id) || (it.room_name === roomName))
          .map(it => it.item_name);
        openRoomItemsModal(`Items in ${roomName}`, items);
        return;
      }

      if(act==='editOwner'){
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        const cancelBtn = tr.querySelector('button[data-act="cancelOwner"]');

        // Enter edit mode
        if(btn.dataset.mode !== 'save'){
          btn.dataset.mode = 'save';
          btn.textContent = 'Save';
          btn.classList.add('save-glow');
          sel.classList.remove('hidden');
          sel.classList.add('edit-pulse');
          text.classList.add('hidden');
          cancelBtn.classList.remove('hidden');
          sel.focus();
          return;
        }

        // Save mode
        const newOwner = sel.value ? Number(sel.value) : null;
        const { error } = await sb.from('rooms').update({ occupied_by: newOwner }).eq('id', id).eq('site_id', S.siteId);
        if(error){ toast(error.message); return; }
        await loadRooms();
        renderRooms();
        toast('Owner updated');
        return;
      }

      if(act==='cancelOwner'){
        const editBtn = tr.querySelector('button[data-act="editOwner"]');
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        editBtn.dataset.mode = 'edit';
        editBtn.textContent = 'Edit owner';
        editBtn.classList.remove('save-glow');
        sel.classList.add('hidden');
        sel.classList.remove('edit-pulse');
        text.classList.remove('hidden');
        btn.classList.add('hidden');
        return;
      }

      if(act==='rename'){
        const row=S.rooms.find(r=>r.id===id); const name=prompt('New room name', row?.name||''); if(!name) return;
        const { error } = await sb.from('rooms').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room renamed');
        return;
      }

      if(act==='del'){
        if(!confirm('Delete this room?')) return;
        const { error } = await sb.from('rooms').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room deleted');
        return;
      }
    });

    // Types tab
    $('addType').addEventListener('click', async ()=>{
      const name=$('typeName').value.trim(); const category=$('typeCategory').value;
      if(!name) return;
      const { error } = await sb.from('check_types').insert({ site_id:S.siteId, name, category, active:true });
      if(error) return toast(error.message);
      $('typeName').value=''; await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); updateKPIs(); toast('Type added');
    });
    $('typesBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==='toggleType'){
        const t=S.types.find(x=>x.id===id); const active = !(t?.active===false);
        const { error } = await sb.from('check_types').update({ active: !active }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type toggled');
      }
      if(act==='renameType'){
        const t=S.types.find(x=>x.id===id); const name=prompt('New type name', t?.name||''); if(!name) return;
        const { error } = await sb.from('check_types').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type renamed');
      }
      if(act==='delType'){
        if(!confirm('Delete this check type?')) return;
        const { error } = await sb.from('check_types').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type deleted');
      }
    });
    async function setTypeTeam(checkTypeId, teamId){
      // clear existing mapping then set if provided
      await sb.from('check_type_teams').delete()
        .eq('site_id', S.siteId).eq('check_type_id', checkTypeId);
      if(teamId){
        const { error } = await sb.from('check_type_teams').insert({
          site_id:S.siteId, check_type_id: checkTypeId, team_id: Number(teamId)
        });
        if(error){ toast(error.message); return; }
      }
      await loadCheckTypeTeams(); buildTypeTeamMap(); renderTypes(); renderPlan(); renderDashboard();
      toast('Team updated');
    }
    $('typesBody').addEventListener('change', async (e)=>{
      const sel = e.target.closest('select[data-act="typeTeam"]'); if(!sel) return;
      const id = Number(sel.getAttribute('data-id'));
      const teamId = sel.value || null;
      await setTypeTeam(id, teamId);
    });

    // Teams
    const _addTeam = $('addTeam'); if(_addTeam){ _addTeam.addEventListener('click', async ()=>{
      const name = ($('teamName').value||'').trim(); if(!name) return;
      const { error } = await sb.from('teams').insert({ site_id:S.siteId, name });
      if(error) return toast(error.message);
      $('teamName').value=''; await loadTeams(); renderTeams(); toast('Team added');
    }); }
    const _teamsBody = $('teamsBody'); if(_teamsBody){ _teamsBody.addEventListener('click', async (e)=>{
      const b = e.target.closest('button,span.chip'); if(!b) return;
      const act = b.getAttribute('data-act');
      if(act==='renameTeam'){
        const id = Number(b.getAttribute('data-id'));
        const row = (S.teams||[]).find(t=>t.id===id);
        const name = prompt('New team name', row?.name||''); if(!name) return;
        const { error } = await sb.from('teams').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTeams(); renderTeams(); renderTypes(); buildTypeTeamMap(); toast('Renamed');
      }
      if(act==='delTeam'){
        const id = Number(b.getAttribute('data-id'));
        if(!confirm('Delete this team?')) return;
        // clean up mappings and members
        await sb.from('team_members').delete().eq('team_id', id).eq('site_id', S.siteId);
        await sb.from('check_type_teams').delete().eq('team_id', id).eq('site_id', S.siteId);
        const { error } = await sb.from('teams').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await Promise.all([loadTeams(), loadTeamMembers(), loadCheckTypeTeams()]);
        buildTypeTeamMap(); renderTeams(); renderTypes(); renderPlan(); renderDashboard(); toast('Team deleted');
      }
      if(act==='addMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const sel = b.parentElement.querySelector('select.team-add-member');
        const userId = Number(sel?.value||''); if(!userId) return;
        const { error } = await sb.from('team_members').insert({ site_id:S.siteId, team_id:teamId, user_id:userId });
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member added');
      }
      if(act==='removeMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const userId = Number(b.getAttribute('data-user'));
        const { error } = await sb.from('team_members').delete().eq('site_id', S.siteId).eq('team_id', teamId).eq('user_id', userId);
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member removed');
      }
    }); }

    // Items tab
    const _itemCategoryEl = $('itemCategory'); if(_itemCategoryEl){ _itemCategoryEl.addEventListener('change', fillItemPickers); }
    const _saveItemBtn = $('saveItem');
    if(_saveItemBtn){
      _saveItemBtn.addEventListener('click', async ()=>{
        const p = {
          p_site_id: S.siteId,
          p_item_id: $('itemCode').value.trim(),
          p_item_name: $('itemName').value.trim(),
          p_room_name: $('itemRoom').value,
          p_category: $('itemCategory').value,
          p_default_check_type_name: $('itemType').value,
          p_comments: $('itemComments').value.trim() || null
        };
        if(!p.p_item_id || !p.p_item_name){ return toast('Code & name required'); }
        const { data, error } = await sb.rpc('admin_upsert_item', p);
        if(error) return toast(error.message);
        await loadItems(); renderItems(); updateKPIs(); toast('Item saved');
      });
    }
    $('itemSearch').addEventListener('input', renderItems);
    $('refreshItems').addEventListener('click', async ()=>{ await loadItems(); renderItems(); });

    // Items configurator
    $('itemsBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const act=b.dataset.act;
      if(act==='cfg'){
        const code=b.dataset.code;
        const it=S.items.find(x=>x.item_id===code);
        if(!it) return;
        S.selectedItem = it;
        openCfgModal();
        $('cfgCodeInput').value = it.item_id;
        $('cfgCodeInput').readOnly = true;
        $('cfgName').textContent = it.item_name || '';
        // Reset Change button and input affordances
        const _btnEC = $('cfgEnableEditCode');
        if(_btnEC){
          _btnEC.textContent = 'Change';
          _btnEC.classList.remove('save-glow');
          _btnEC.dataset.mode = 'change';
        }
        $('cfgCodeInput').classList.remove('edit-pulse');
        fillCfgRooms(); fillOwnerRoles(); fillPlanTypePicker(it);
        if(it.room_name) $('cfgRoom').value = it.room_name;
        // owner role best-effort (from comments if present)
        $('cfgOwnerRole').value = '';
        await loadItemPlan(code); renderPlan();
      }
    });

    // Quick chips for frequency new
    document.querySelectorAll('button[data-quick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v=btn.getAttribute('data-quick'); const inp=$('planFreqNew'); if(inp) inp.value=v;
      });
    });

    // Add plan row
    $('planAdd').addEventListener('click', async ()=>{
      if(!S.selectedItem) return toast('Select an item first');
      const typeName = $('planTypeNew').value;
      const freq = $('planFreqNew').value || '0 days';
      if(!typeName) return toast('Choose a check type');
      const { error } = await sb.rpc('admin_set_item_check', {
        p_site_id: S.siteId,
        p_item_code: S.selectedItem.item_id,
        p_check_type_name: typeName,
        p_frequency: freq,
        p_warn_before: '3 days',
        p_required: true,
        p_active: true
      });
      if(error) return toast(error.message);
      $('planFreqNew').value='';
      await loadItemPlan(S.selectedItem.item_id); renderPlan(); toast('Check added');
    });

    // Save/remove plan rows
    $('planBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const act=b.dataset.act, id=b.dataset.id;
      if(act==='savePlan'){ await savePlanRow(id); }
      if(act==='delPlan'){
        if(!confirm('Remove this check from the plan?')) return;
        const { error } = await sb.from('item_allowed_types').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadItemPlan(S.selectedItem.item_id); renderPlan(); toast('Removed');
      }
    });

    // Save details (room + owner role)
    $('cfgSaveDetails').addEventListener('click', async ()=>{
      if(!S.selectedItem) return;
      const roomName = $('cfgRoom').value;
      const ownerRole = $('cfgOwnerRole').value;
      // Save room via existing RPC
      const { error } = await sb.rpc('admin_upsert_item', {
        p_site_id: S.siteId,
        p_item_id: $('cfgCodeInput').value.trim(),
        p_item_name: S.selectedItem.item_name,
        p_room_name: roomName,
        p_category: S.selectedItem.category,
        p_default_check_type_name: S.selectedItem.default_check_type_name || null,
        p_comments: (S.selectedItem.comments||'').replace(/owner:\s*.*$/i,'').trim() + (ownerRole?` owner: ${ownerRole}`:'')
      });
      if(error) return toast(error.message);
      await loadItems();
      // refresh selected
      S.selectedItem = S.items.find(x=>x.item_id===S.selectedItem.item_id);
      toast('Details saved');
    });


    // Staff tab
    $('addStaff').addEventListener('click', async ()=>{
      const full_name=$('staffName').value.trim(); const role=$('staffRole').value;
      if(!full_name) return;
      const { error } = await sb.from('kiosk_users').insert({ site_id:S.siteId, full_name, role });
      if(error) return toast(error.message);
      $('staffName').value=''; await loadStaff(); renderStaff(); updateKPIs(); toast('Staff added');
    });
    $('staffBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==='setPin'){
        const p = prompt('Enter new 4-digit PIN'); if(!p) return;
        const { error } = await sb.rpc('set_kiosk_user_pin', { p_user_id:id, p_site_id:S.siteId, p_pin:p });
        if(error) return toast(error.message);
        // Also persist the plain PIN so the UI (which reads the plain column) stays in sync
        await sb.from('kiosk_users').update({ pin: p }).eq('id', id).eq('site_id', S.siteId);
        await loadStaff(); renderStaff(); toast('PIN set');
      }
      if(act==='renameStaff'){
        const row=S.staff.find(x=>x.id===id); const name=prompt('New name', row?.full_name||''); if(!name) return;
        const { error } = await sb.from('kiosk_users').update({ full_name:name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Renamed');
      }
      if(act==='roleStaff'){
        const row=S.staff.find(x=>x.id===id); const role=prompt('Role (admin/staff)', row?.role||'staff'); if(!role) return;
        const { error } = await sb.from('kiosk_users').update({ role }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Role updated');
      }
      if(act==='delStaff'){
        if(!confirm('Delete this staff member?')) return;
        const { error } = await sb.from('kiosk_users').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); updateKPIs(); toast('Staff deleted');
      }
    });

    // Audits
    $('refreshAudits').addEventListener('click', async ()=>{ await loadAudits(); renderAudits(); });
    $('auditSearch').addEventListener('input', renderAudits);
    $('exportAudits').addEventListener('click', ()=>{
      const rows = S.audits.map(a=>({
        submitted_at: a.submitted_at,
        staff_name: a.staff_name,
        scanned_code: a.scanned_code,
        item_name: a.item_name,
        room: a.room,
        check_type: a.check_type,
        check_value: a.check_value
      }));
      const csv = Papa.unparse(rows);
      download(`audits_site_${S.siteId}.csv`, csv);
    });

    // Initial picker listeners
    const _itemRoomEl = $('itemRoom'); if(_itemRoomEl){ _itemRoomEl.addEventListener('change', ()=>{}); }
    const _itemTypeEl = $('itemType'); if(_itemTypeEl){ _itemTypeEl.addEventListener('change', ()=>{}); }

    // Modal close listeners
    const _cfgClose = $('cfgClose'); if(_cfgClose){ _cfgClose.addEventListener('click', closeCfgModal); }
    const _cfgModal = $('cfgModal'); if(_cfgModal){ _cfgModal.addEventListener('click', (e)=>{ if(e.target===_cfgModal) closeCfgModal(); }); }
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCfgModal(); });
    const _riClose = $('roomItemsClose'); if(_riClose){ _riClose.addEventListener('click', closeRoomItemsModal); }
    const _riModal = $('roomItemsModal'); if(_riModal){ _riModal.addEventListener('click', (e)=>{ if(e.target===_riModal) closeRoomItemsModal(); }); }
    const _cfgEnableEditCode = $('cfgEnableEditCode');
    if(_cfgEnableEditCode){
      _cfgEnableEditCode.dataset.mode = 'change';
      _cfgEnableEditCode.addEventListener('click', async ()=>{
        const btn = _cfgEnableEditCode;
        const inp = $('cfgCodeInput');
        if(!inp) return;
        // Enter edit mode
        if(btn.dataset.mode !== 'save'){
          btn.dataset.mode = 'save';
          btn.textContent = 'Save';
          btn.classList.add('save-glow');
          inp.readOnly = false;
          inp.classList.add('edit-pulse');
          inp.focus();
          inp.select();
          return;
        }
        // Save mode
        const newCode = (inp.value||'').trim();
        if(!S.selectedItem){ toast('No item selected'); return; }
        if(!newCode){ toast('Code required'); return; }
        // If unchanged, just exit edit mode gracefully
        if(newCode === S.selectedItem.item_id){
          btn.dataset.mode = 'change';
          btn.textContent = 'Change';
          btn.classList.remove('save-glow');
          inp.readOnly = true;
          inp.classList.remove('edit-pulse');
          return;
        }
        btn.disabled = true;
        try{
          const { error } = await sb.rpc('admin_upsert_item', {
            p_site_id: S.siteId,
            p_item_id: newCode,
            p_item_name: S.selectedItem.item_name,
            p_room_name: $('cfgRoom').value,
            p_category: S.selectedItem.category,
            p_default_check_type_name: S.selectedItem.default_check_type_name || null,
            p_comments: S.selectedItem.comments || null
          });
          if(error) throw error;
          await loadItems();
          S.selectedItem = S.items.find(x => x.item_id === newCode) || S.selectedItem;
          renderItems();
          toast('Item ID saved');
          // Exit edit mode
          btn.dataset.mode = 'change';
          btn.textContent = 'Change';
          btn.classList.remove('save-glow');
          inp.readOnly = true;
          inp.classList.remove('edit-pulse');
        }catch(err){
          console.error(err);
          toast(err.message || 'Save failed');
        }finally{
          btn.disabled = false;
        }
      });
    }

    // Kick off
    init();
  </script>
</body>
</html>
