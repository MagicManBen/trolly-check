<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC — PIN Portal (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root {
      --bg: #0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444;
      --card:#111317; --line:#272a30; --btn:#2a2f36;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .panel { width: min(520px, 95vw); background:var(--panel); border-radius:20px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1,h2,h3 { margin:0 0 12px; }
    .muted { color:var(--muted); font-size:14px; }
    .center { text-align:center; }
    .hidden { display:none !important; }
    .btn { display:inline-flex; justify-content:center; align-items:center; padding:12px 16px; border-radius:12px; background:var(--btn); border:1px solid var(--line); color:var(--text); cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background:var(--accent); border-color:transparent; color:#04130a; font-weight:600; }
    .btn.danger { background:var(--danger); border-color:transparent; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .pad { margin-top:14px; }
    .key { padding:18px 0; border-radius:14px; background:#2b2f36; text-align:center; font-weight:600; font-size:20px; border:1px solid var(--line); }
    .key:active { transform: translateY(1px); }
    .pin-dots { display:flex; gap:10px; justify-content:center; margin:16px 0 6px; }
    .dot { width:14px; height:14px; border-radius:50%; background:#30363f; }
    .dot.filled { background:#9fb3c8; }
    .row { display:flex; gap:10px; }
    input[type=text], input[type=password], select { background:#0f1216; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px; width:100%; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom:1px solid var(--line); padding:10px; text-align:left; }
    .topbar { position:fixed; left:0; right:0; top:0; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(to bottom, rgba(0,0,0,.5), transparent); }
    .pill { padding:6px 10px; background:#1e232b; border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:#0f1216; border:1px solid var(--line); padding:10px 14px; border-radius:10px; color:#fff; }
    .hr { border-top:1px solid var(--line); margin:14px 0; }
    .list { max-height: 260px; overflow:auto; border:1px solid var(--line); border-radius:10px; padding:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .art { margin: 16px auto 4px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
    .art img { max-width: 360px; width: 90%; height: auto; border-radius: 12px; border:1px solid var(--line); background:#0f1216; }
    .twocol { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: center; }
    @media (max-width: 720px) { .twocol { grid-template-columns: 1fr; } }
    .glow { text-shadow: 0 2px 0 rgba(0,0,0,.6), 0 0 18px rgba(255,255,255,.35); }
    .btn.light { background:#ffffff; border-color:#d1d5db; color:#111; font-weight:600; box-shadow: 0 8px 24px rgba(0,0,0,.25), 0 0 0 0 rgba(34,197,94,.0); }
    .btn.light:active { transform: translateY(1px); }
    .fab { position: fixed; right: 22px; bottom: 22px; width:56px; height:56px; border-radius:50%; background: var(--accent); border: none; color:#04130a; font-size:28px; display:flex; justify-content:center; align-items:center; box-shadow: 0 10px 26px rgba(34,197,94,.40); }
    .footer { position: fixed; bottom: 10px; left:0; right:0; text-align:center; color: var(--muted); }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="pill" id="status">Not signed in</div>
    <div class="row">
      <button class="btn" id="btnAdmin">⚙︎</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap" id="screen-login">
    <div class="panel center">
      <h1>Staff Portal</h1>
      <p class="muted">Sign in (one-time) with your email & password. Then staff use a 4‑digit PIN.</p>
      <div class="pad">
        <input id="loginEmail" type="text" placeholder="email@example.com">
      </div>
      <div class="pad">
        <input id="loginPass" type="password" placeholder="Password">
      </div>
      <div class="pad">
        <button class="btn primary" id="doLogin">Sign in</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-pin">
    <div class="panel center">
      <h2>Enter 4 digit PIN</h2>
      <div class="pin-dots">
        <div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div>
      </div>
      <div class="grid pad" id="pad">
        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
        <div class="key" style="grid-column:2">0</div>
      </div>
      <div class="pad"><button class="btn" id="btnClearPin">Clear</button></div>
      <div class="art"><img src="PlugIn.png" alt="Plug in the handheld"></div>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-begin">
    <div class="panel center">
      <h2 class="glow">Press button once and wait for two beeps</h2>
      <p class="muted">After 2 beeps, click the BEGIN button below</p>
      <div class="art"><img src="DoubleDeep.png" alt="Press the handheld once"></div>
      <div class="pad"><button class="btn light" id="btnBegin">Begin</button></div>
      <p class="muted">Auditing: <span id="whoName">—</span></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-admin-reset">
    <div class="panel center">
      <h2>Set a new Admin PIN</h2>
      <p class="muted">Enter a new 4‑digit PIN to replace the default admin PIN. You'll use this to manage users and settings.</p>
      <div class="row">
        <input id="resetAdminPin1" placeholder="New 4‑digit PIN" inputmode="numeric" pattern="\d*" maxlength="4">
        <input id="resetAdminPin2" placeholder="Confirm PIN" inputmode="numeric" pattern="\d*" maxlength="4">
      </div>
      <div class="pad">
        <button class="btn primary" id="btnSaveAdminPin">Save new PIN</button>
        <button class="btn" id="btnCancelResetPin">Cancel</button>
      </div>
      <p id="resetPinMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-scanning">
    <div class="panel center" style="width:min(780px, 96vw)">
      <h2>Audit in progress</h2>
      <p class="muted">Scan the QR on each item as you check it. When finished, return to this iPad.</p>
      <div class="art">
        <img src="ScanTrolly.png" alt="Scan the trolley QR">
        <img src="DoubleDeep.png" alt="Deep scan guidance">
      </div>
      <div class="hr"></div>
      <p class="muted">Scanned: <span id="scanCount">0</span></p>
      <div class="list mono" id="scanList"></div>
      <div class="pad"><button class="btn primary" id="btnFinish">Finish audit</button></div>
      <input id="scanInput" class="hidden" />
    </div>
  </div>

  <div class="wrap hidden" id="screen-review">
    <div class="panel center" style="width:min(820px, 96vw)">
      <h2>Review & Submit</h2>
      <div class="art"><img src="WristBand.png" alt="Wrist band / safety reminder"></div>
      <div class="row">
        <div style="flex:1; display:none">
          <label>Check type</label>
          <select id="checkType"></select>
        </div>
        <div style="flex:1">
          <label>Comment (optional)</label>
          <input id="comment" placeholder="Any notes" />
        </div>
      </div>
      <div class="hr"></div>
      <table id="reviewTable"><thead><tr><th>Item ID</th><th>Name</th><th>Room</th><th>Check Type</th><th>Value</th></tr></thead><tbody></tbody></table>
      <div class="pad"><button class="btn primary" id="btnSubmit">Submit</button></div>
      <p id="submitMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-upload">
    <div class="panel center">
      <h2>Upload from scanner</h2>
      <p class="muted">Scan this QR on the handheld to upload stored scans.</p>
      <div class="twocol">
        <div class="art"><img src="IPADSCAN.png" alt="Use the iPad to upload from handheld" id="imgIpadScan"></div>
        <div>
          <div class="art" id="qrUploadWrap"><div id="qrUpload"></div></div>
          <p class="muted mono">Value: ^&032&^</p>
          <p id="uploadStatus" class="muted hidden">Captured: <span id="capCount">0</span></p>
        </div>
      </div>
      <input id="uploadInput" autocomplete="off" autocapitalize="off" spellcheck="false" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
      <div class="pad"><button class="btn primary" id="btnUploaded">Continue</button></div>
    </div>
  </div>

  <div class="wrap hidden" id="screen-reset">
    <div class="panel center">
      <h2>Final reset</h2>
      <p class="muted">After submitting, clear the handheld memory.</p>
      <div class="art"><div id="qrReset"></div></div>
      <p class="muted mono">Value: ^&030&^</p>
      <div class="pad"><button class="btn primary" id="btnResetDone">Done</button></div>
    </div>
  </div>

  <!-- Admin modal (inline simple) -->
  <div class="wrap hidden" id="screen-admin">
    <div class="panel" style="width:min(860px,96vw)">
      <h2>Admin</h2>
      <div class="hr"></div>
      <h3>Users & PINs</h3>
      <div class="row">
        <input id="newUserName" placeholder="Full name">
        <input id="newUserPin" placeholder="4-digit PIN">
        <select id="newUserRole">
          <option value="staff">Staff</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn" id="btnAddUser">Add</button>
      </div>
      <table id="usersTable">
        <thead><tr><th>Name</th><th>PIN</th><th>Role</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>
      <h3>Items</h3>
      <div class="row">
        <input id="item_id" placeholder="Item ID">
        <input id="item_name" placeholder="Item name">
        <input id="room" placeholder="Room">
        <button class="btn" id="btnAddItem">Add</button>
      </div>
      <table id="itemsTable">
        <thead><tr><th>Item ID</th><th>Name</th><th>Room</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>
      <h3>Check types</h3>
      <div class="row">
        <input id="newType" placeholder="e.g., Working">
        <button class="btn" id="btnAddType">Add</button>
      </div>
      <ul id="typesList" class="list"></ul>

      <div class="hr"></div>
      <h3>Admin settings</h3>
      <div class="row">
        <input id="newAdminPin" placeholder="New 4‑digit admin PIN" inputmode="numeric" pattern="\d*" maxlength="4">
        <input id="newAdminPin2" placeholder="Confirm PIN" inputmode="numeric" pattern="\d*" maxlength="4">
        <button class="btn" id="btnChangeAdminPin">Change PIN</button>
      </div>
      <p id="changeAdminPinMsg" class="muted"></p>

      <div class="pad"><button class="btn" id="btnCloseAdmin">Close</button></div>
      <p id="adminMsg" class="muted"></p>
    </div>
  </div>

  <button class="fab" id="btnFab">+</button>
  <div class="footer">User: <span id="footerWho">—</span></div>
  <div id="toast" class="toast hidden"></div>

  <script>
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    const S = { siteId: null, user: null, staff: null, scans: [], itemsById: new Map(), types: [] };

    // Helpers
    function $(id) { return document.getElementById(id); }
    function show(id) { ['screen-login','screen-pin','screen-begin','screen-scanning','screen-upload','screen-review','screen-reset','screen-admin','screen-admin-reset'].forEach(x => $(x).classList.add('hidden')); $(id).classList.remove('hidden'); }
    function toast(msg) { const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); }
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    function pinDots(n) { for (let i=1;i<=4;i++) { const d=$('d'+i); if(!d) continue; d.classList.toggle('filled', i<=n); } }

    // QR code rendering helpers
    function renderQR(elId, text) {
      const el = $(elId); if (!el) return;
      el.innerHTML = '';
      if (typeof QRCode !== 'undefined') {
        new QRCode(el, { text, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      } else {
        el.textContent = text;
      }
    }
    function showUploadQR() { renderQR('qrUpload', '^&032&^'); }
    function showResetQR() { renderQR('qrReset', '^&030&^'); }
    let uploadQuietTimer = null;
    function focusUploadInput(){ const u=$('uploadInput'); if(!u) return; u.value=''; u.focus(); }
    function scheduleUploadAutoContinue(){ if(uploadQuietTimer) clearTimeout(uploadQuietTimer); uploadQuietTimer = setTimeout(async ()=>{ await refreshReview(); show('screen-review'); }, 2000); }
    // Helper to reset upload screen UI state
    function resetUploadUI(){
      if(uploadQuietTimer) { clearTimeout(uploadQuietTimer); uploadQuietTimer=null; }
      const wrap=$('qrUploadWrap'); if(wrap) wrap.classList.remove('hidden');
      const st=$('uploadStatus'); if(st) st.classList.add('hidden');
      const cnt=$('capCount'); if(cnt) cnt.textContent='0';
      const inp=$('uploadInput'); if(inp){ inp.value=''; }
    }

    // Ensure session -> get site -> show PIN
    async function init() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) { show('screen-login'); $('status').textContent = 'Not signed in'; return; }
      S.user = session.user;
      $('status').textContent = session.user.email;
      // Fetch profile -> site id
      const { data: prof, error } = await sb.from('profiles').select('site_id, full_name, role').eq('user_id', session.user.id).limit(1);
      if (error || !prof || !prof.length) { show('screen-login'); $('loginMsg').textContent = 'No profile/site. Please onboard first.'; return; }
      S.siteId = prof[0].site_id;
      await preloadCache();
      show('screen-pin');
    }

    // Preload items and types for fast lookup
    async function preloadCache() {
      const i = await sb.from('items').select('item_id, item_name, room').eq('site_id', S.siteId).order('item_name');
      if (!i.error) { S.itemsById.clear(); (i.data||[]).forEach(r=>S.itemsById.set(r.item_id, r)); }
      const t = await sb.from('check_types').select('name').eq('site_id', S.siteId).order('name');
      if (!t.error) { S.types = (t.data||[]).map(r=>r.name); }
    }

    // Login
    $('doLogin').addEventListener('click', async ()=>{
      $('loginMsg').textContent = 'Signing in…';
      const email = $('loginEmail').value.trim();
      const password = $('loginPass').value;
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { $('loginMsg').textContent = error.message; return; }
      await init();
    });

    $('btnLogout').addEventListener('click', async()=>{ await sb.auth.signOut(); $('footerWho').textContent = '—'; location.reload(); });

    // PIN keypad
    let pin = '';
    $('pad').addEventListener('click', async (e)=>{
      const k = e.target.closest('.key'); if (!k) return;
      const v = k.textContent.trim();
      if (/^\d$/.test(v)) { if (pin.length<4) pin+=v; pinDots(pin.length); }
      if (pin.length === 4) { await tryPin(pin); }
    });
    $('btnClearPin').addEventListener('click', ()=>{ pin=''; pinDots(0); });
    $('btnFab').addEventListener('click', openUserManagement);

    async function tryPin(p) {
      $('pinMsg').textContent = 'Checking…';
      try {
        // If default admin PIN entered, either find or create the admin row, then force reset
        if (p === DEFAULT_ADMIN_PIN) {
          // See if an admin with the default PIN already exists for this site
          let { data: adminRow, error: findErr } = await sb
            .from('kiosk_users')
            .select('id, full_name, role')
            .eq('site_id', S.siteId)
            .eq('role', 'admin')
            .eq('pin', DEFAULT_ADMIN_PIN)
            .limit(1)
            .maybeSingle();

          if (findErr) { $('pinMsg').textContent = findErr.message; pin=''; pinDots(0); return; }

          if (!adminRow) {
            // Create a placeholder admin using the default PIN so we have a row to update
            const { data: ins, error: insErr } = await sb
              .from('kiosk_users')
              .insert({ site_id: S.siteId, full_name: 'Admin User', pin: DEFAULT_ADMIN_PIN, role: 'admin', active: true })
              .select('id, full_name')
              .single();
            if (insErr) { $('pinMsg').textContent = insErr.message; pin=''; pinDots(0); return; }
            adminRow = ins;
          }

          // Stash admin id and route to forced reset screen
          S.staff = { name: adminRow.full_name || 'Admin User', role: 'admin' };
          S.adminUserId = adminRow.id;
          $('footerWho').textContent = S.staff.name;
          $('whoName').textContent = S.staff.name;
          $('pinMsg').textContent = '';
          pin=''; pinDots(0);
          $('resetPinMsg').textContent = 'Please choose a new 4‑digit Admin PIN now.';
          show('screen-admin-reset');
          return;
        }

        // Normal kiosk user PIN path
        const { data, error } = await sb
          .from('kiosk_users')
          .select('id, full_name, role')
          .eq('site_id', S.siteId)
          .eq('pin', p)
          .limit(1);
        if (error) { $('pinMsg').textContent = error.message; pin=''; pinDots(0); return; }
        if (!data || !data.length) { $('pinMsg').textContent = 'Invalid PIN'; pin=''; pinDots(0); return; }

        S.staff = { name: data[0].full_name, role: data[0].role };
        S.adminUserId = (data[0].role === 'admin') ? data[0].id : null;
        $('footerWho').textContent = S.staff.name;
        $('whoName').textContent = S.staff.name;
        $('pinMsg').textContent = '';
        pin=''; pinDots(0);
        show('screen-begin');
      } catch (e) {
        $('pinMsg').textContent = e.message || String(e);
        pin=''; pinDots(0);
      }
    }

    // Begin -> scanning, auto-advance to upload after 7 seconds
    $('btnBegin').addEventListener('click', ()=>{
      S.scans = [];
      $('scanList').innerHTML = '';
      $('scanCount').textContent = '0';
      show('screen-scanning');
      setTimeout(()=>{
        resetUploadUI();
        show('screen-upload');
        showUploadQR();
        focusUploadInput();
      }, 7000);
    });
    $('scanInput').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); const code = e.target.value.trim(); e.target.value=''; if (!code) return; addScan(code); } });

    function addScan(code) {
      if (S.scans.includes(code)) return;
      S.scans.push(code);
      const known = S.itemsById.get(code);
      const line = known ? (code + ' — ' + known.item_name + ' (' + known.room + ')') : (code + ' — (Unknown item)');
      const div = document.createElement('div'); div.textContent = line;
      $('scanList').appendChild(div);
      $('scanCount').textContent = String(S.scans.length);
    }

    // Finish -> upload
    $('uploadInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const raw=e.target.value.trim(); e.target.value=''; const m=raw.match(/^\d{10}$/); if(!m){ scheduleUploadAutoContinue(); return; } const code=m[0]; if(!S.scans.includes(code)){ S.scans.push(code); $('capCount').textContent=String(S.scans.length); $('uploadStatus').classList.remove('hidden'); const wrap=$('qrUploadWrap'); if(wrap) wrap.classList.add('hidden'); } scheduleUploadAutoContinue(); }});
    $('btnFinish').addEventListener('click', async()=>{
      resetUploadUI();
      show('screen-upload');
      showUploadQR();
      focusUploadInput();
    });
    $('btnUploaded').addEventListener('click', async()=>{ await refreshReview(); show('screen-review'); });
    $('btnResetDone').addEventListener('click', ()=>{ show('screen-pin'); });

    async function refreshReview() {
      await preloadCache();
      const tb = $('reviewTable')?.querySelector('tbody');
      if (tb) {
        tb.innerHTML = '';
        const types = S.types && S.types.length ? S.types : ['Working'];
        for (const code of S.scans) {
          const it = S.itemsById.get(code);
          const tr = document.createElement('tr');
          const td1 = document.createElement('td'); td1.textContent = code;
          const td2 = document.createElement('td'); td2.textContent = it ? it.item_name : '(Unknown)';
          const td3 = document.createElement('td'); td3.textContent = it ? it.room : '—';
          const td4 = document.createElement('td');
          const sel = document.createElement('select'); sel.className = 'rowType'; sel.setAttribute('data-item-id', code);
          for (const n of types) { const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }
          td4.appendChild(sel);
          const td5 = document.createElement('td');
          const inp = document.createElement('input');
          inp.className = 'rowTemp';
          inp.setAttribute('data-item-id', code);
          inp.type = 'text';
          inp.inputMode = 'decimal';
          inp.placeholder = '--';
          inp.style.width = '90px';
          inp.style.display = 'none';
          td5.appendChild(inp);
          sel.addEventListener('change', ()=>{
            const show = sel.value === 'Temperature';
            inp.style.display = show ? '' : 'none';
            if (!show) inp.value = '';
          });
          tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
          tb.appendChild(tr);
        }
      }
    }

    // Submit
    $('btnSubmit').addEventListener('click', async()=>{
      $('submitMsg').textContent='Submitting…';
      if (!S.scans.length) { $('submitMsg').textContent='No scans.'; return; }
      const selects = Array.from(document.querySelectorAll('.rowType'));
      const staffName = S.staff?.name || 'Staff';
      const comment = $('comment').value.trim();

      const sessionId = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
      const { data: sub, error: e1 } = await sb.from('submissions')
        .insert({ site_id: S.siteId, session_id: sessionId, staff_name: staffName, comment })
        .select('id').single();
      if (e1) { $('submitMsg').textContent = e1.message; return; }
      const sid = sub.id;
      const rows = [];
      for (const s of selects) {
        const itemId = s.getAttribute('data-item-id');
        const type = (s.value || 'Working');
        let value = 'Done';
        if (type === 'Temperature') {
          const inp = document.querySelector(`.rowTemp[data-item-id="${itemId}"]`);
          const t = (inp?.value || '').trim();
          if (!/^\d{1,3}(\.\d{1,2})?$/.test(t)) { $('submitMsg').textContent = 'Enter a valid temperature for '+itemId; return; }
          value = t;
        }
        rows.push({ site_id: S.siteId, submission_id: sid, item_id: itemId, check_type: type, check_value: value });
      }
      const { error: e2 } = await sb.from('submission_rows').insert(rows);
      if (e2) { $('submitMsg').textContent = e2.message; return; }
      $('submitMsg').textContent='Submitted!';
      toast('Submission uploaded');
      S.scans = []; $('scanList').innerHTML=''; $('scanCount').textContent='0'; $('comment').value='';
      show('screen-reset');
      showResetQR();
    });

    // ----- Admin / Add-Edit Users (bootstrap first admin) -----
    async function openUserManagement() {
      if (!S.siteId) { toast('Please sign in first.'); return; }
      await renderAdmin();
      show('screen-admin');
    }

    $('btnCreatePin')?.addEventListener('click', openUserManagement);
    $('btnAdmin').addEventListener('click', openUserManagement);
    $('btnCloseAdmin').addEventListener('click', ()=> show('screen-pin'));

    // Admin: load tables
    async function renderAdmin() {
      $('adminMsg').textContent = '';
      // Users
      const u = await sb.from('kiosk_users').select('id, full_name, pin, role').eq('site_id', S.siteId).order('full_name');
      const tb = $('usersTable').querySelector('tbody'); tb.innerHTML = '';
      if (!u.error) {
        for (const r of (u.data||[])) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>'+r.full_name+'</td><td>'+r.pin+'</td><td>'+r.role+'</td><td><button class="btn danger" data-id="'+r.id+'">Delete</button></td>';
          tb.appendChild(tr);
        }
        tb.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', async()=>{
          const id = Number(b.getAttribute('data-id'));
          const { error } = await sb.from('kiosk_users').delete().eq('id', id).eq('site_id', S.siteId);
          if (error) { toast(error.message); return; }
          toast('User deleted'); renderAdmin();
        }));
      }
      // Items
      const it = await sb.from('items').select('item_id, item_name, room').eq('site_id', S.siteId).order('item_name');
      const tbi = $('itemsTable').querySelector('tbody'); tbi.innerHTML = '';
      if (!it.error) {
        for (const r of (it.data||[])) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>'+r.item_id+'</td><td>'+r.item_name+'</td><td>'+r.room+'</td><td><button class="btn danger" data-del="'+r.item_id+'">Delete</button></td>';
          tbi.appendChild(tr);
        }
        tbi.querySelectorAll('button[data-del]').forEach(b => {
          b.addEventListener('click', async()=>{
            const id = b.getAttribute('data-del');
            const { error } = await sb.from('items').delete().eq('site_id', S.siteId).eq('item_id', id);
            if (error) { toast(error.message); return; }
            toast('Item deleted'); renderAdmin();
          });
        });
      }
      // Types
      const tt = await sb.from('check_types').select('id, name').eq('site_id', S.siteId).order('name');
      S.types = (tt.data||[]).map(r=>r.name);
      $('typesList').innerHTML = (tt.data||[]).map(r => '<li>'+r.name+'</li>').join('') || '<li class="muted">None yet</li>';
    }

    // Admin: add actions
    $('btnAddUser').addEventListener('click', async()=>{
      const full_name = $('newUserName').value.trim(); const pin = $('newUserPin').value.trim(); const role = $('newUserRole').value;
      if (!full_name || !pin || pin.length!==4) { $('adminMsg').textContent='Enter name and 4-digit PIN'; return; }
      const { error } = await sb.from('kiosk_users').insert({ site_id: S.siteId, full_name, pin, role });
      if (error) { $('adminMsg').textContent = error.message; return; }
      $('newUserName').value=''; $('newUserPin').value=''; $('newUserRole').value='staff';
      toast('User added'); renderAdmin();
    });
    $('btnAddItem').addEventListener('click', async()=>{
      const item_id = $('item_id').value.trim(); const item_name = $('item_name').value.trim(); const room = $('room').value.trim();
      if (!item_id || !item_name || !room) { $('adminMsg').textContent='Enter ID, name, room'; return; }
      const { error } = await sb.from('items').insert({ site_id: S.siteId, item_id, item_name, room });
      if (error) { $('adminMsg').textContent = error.message; return; }
      $('item_id').value=''; $('item_name').value=''; $('room').value='';
      toast('Item added'); renderAdmin();
    });
    $('btnAddType').addEventListener('click', async()=>{
      const name = $('newType').value.trim(); if (!name) return;
      const { error } = await sb.from('check_types').insert({ site_id: S.siteId, name });
      if (error) { $('adminMsg').textContent = error.message; return; }
      $('newType').value=''; toast('Type added'); renderAdmin();
    });

    init();
  </script>
</body>
</html>
