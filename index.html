<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC Admin â€” Sites, Rooms, Items, Staff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script>
  // Debugging console
  function logDebug(msg){
    const box = document.getElementById('debugBox');
    const time = new Date().toLocaleTimeString();
    const line = `[${time}] ${msg}`;
    if (box) box.textContent += (box.textContent ? "\n" : "") + line;
    // Persist full history to storage so it survives navigation/reload
    try{
      const KEY = 'cqc_debug_log';
      // Prefer localStorage; fall back to sessionStorage if needed
      const store = (function(){
        try{ const k='__t'; localStorage.setItem(k,'1'); localStorage.removeItem(k); return localStorage; }catch(_){}
        try{ const k='__t'; sessionStorage.setItem(k,'1'); sessionStorage.removeItem(k); return sessionStorage; }catch(_){}
        return null;
      })();
      if(store){
        const prev = store.getItem(KEY) || '';
        store.setItem(KEY, prev ? prev + '\n' + line : line);
      }
    }catch(_){ /* ignore storage errors */ }
  }
  // Global error handlers to surface hidden errors in debugBox
  window.addEventListener('error', (e)=>{ try{ logDebug('Window error: '+ (e?.message||e?.error?.toString()||'unknown')); }catch(_){} });
  window.addEventListener('unhandledrejection', (e)=>{ try{ logDebug('Unhandled promise rejection: ' + (e?.reason?.message||e?.reason||'unknown')); }catch(_){} });

  // Load persisted debug log into the box on startup
  function initDebugFromStorage(){
    try{
      const box = document.getElementById('debugBox');
      if(!box) return;
      const KEY = 'cqc_debug_log';
      let text = '';
      try{ text = localStorage.getItem(KEY) || ''; }catch(_){ }
      if(!text){ try{ text = sessionStorage.getItem(KEY) || ''; }catch(_){ }
      }
      if(text) box.textContent = text;
    }catch(_){ /* ignore */ }
  }

  // Copy button handler
  function setupCopyDebugButton(){
    const btn = document.getElementById('copyDebug');
    if(!btn) return;
    btn.addEventListener('click', async ()=>{
      try{
        const box = document.getElementById('debugBox');
        const text = (box && box.textContent) ? box.textContent : '';
        await navigator.clipboard.writeText(text);
        try{ if(typeof toast==='function') toast('Debug log copied'); }catch(_){ }
      }catch(err){
        alert('Copy failed: ' + (err?.message||err));
      }
    });
  }

  (function(){
    // Allow manual override with ?noipad in the URL
    if (new URLSearchParams(location.search).has('noipad')) return;

    // Detect iPad:
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIpadUA = /\biPad\b/i.test(ua);
    const isIpadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // If we're on an iPad and not already on the iPad page, redirect (preserve ? and #)
    if ((isIpadUA || isIpadOS) && !/indexipad\.html$/i.test(location.pathname)) {
      const suffix = location.search + location.hash;
      location.replace('indexipad.html' + suffix);
    }
  })();
  </script>
  <style>
    :root{
      --bg:#0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444;
      --card:#111317; --line:#272a30; --btn:#2a2f36; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--panel);border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;font-size:18px;margin-bottom:12px}
    .status{font-size:12px;color:var(--muted);margin-bottom:16px}
    .nav button{width:100%;text-align:left;background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;margin-bottom:8px;cursor:pointer}
    .nav button.active{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    .main{padding:18px 18px 80px}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#04130a;font-weight:700}
    .btn.warn{background:var(--warn);border-color:transparent;color:#111}
    .btn.danger{background:var(--danger);border-color:transparent}
    .btn.small{padding:6px 8px;border-radius:8px;font-size:12px}
    input, select, textarea{background:#0f1216;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    textarea{min-height:70px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);background:#121419;position:sticky;top:0}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:10px 0 14px 0;background:linear-gradient(to bottom, rgba(0,0,0,.3), transparent)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#1e232b;font-size:12px}
    .right{display:flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f1216;border:1px solid var(--line);padding:10px 14px;border-radius:10px}
    .danger-text{color:var(--danger)}
    .success-text{color:var(--accent)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .hr{border-top:1px solid var(--line);margin:12px 0}
    .table-wrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--card);max-height:60vh;overflow:auto}
    .chip{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b;cursor:pointer}
    .chip:hover{background:#222}
    .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi > div{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .big{font-size:24px;font-weight:800}
    .right input[type="text"]{width:220px}
    .danger-row{background:rgba(239,68,68,.08)}
    .ok-row{background:rgba(34,197,94,.08)}
    /* --- DASHBOARD --- */
    .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .dash-title{font-weight:800;letter-spacing:.2px}
    .stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;position:relative;overflow:hidden}
    .stat-card .label{color:var(--muted);font-size:12px}
    .stat-card .value{font-size:26px;font-weight:900}
    .stat-card.ok::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(34,197,94,.18), transparent)}
    .stat-card.warn::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(245,158,11,.18), transparent)}
    .stat-card.danger::after{content:"";position:absolute;inset:0;background:radial-gradient(600px 80px at -10% -40%, rgba(239,68,68,.18), transparent)}
    .ring{--p:0; width:64px;height:64px;border-radius:50%;background:
      conic-gradient(var(--accent) calc(var(--p)*1%), #222 0);
      display:grid;place-items:center;border:1px solid var(--line)}
    .ring .inner{width:46px;height:46px;border-radius:50%;background:#0f1216;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
    .ring.small{width:42px;height:42px}.ring.small .inner{width:30px;height:30px;font-size:11px}
    .status-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#1e232b}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--accent)}
    .dot.soon{background:var(--warn)}
    .dot.late{background:var(--danger)}
    .list-mini{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto}
    .mini{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--card)}
    .mini:hover{background:#111317}
    .mini .left{display:flex;flex-direction:column}
    .mini .title{font-weight:700}
    .mini .sub{color:var(--muted);font-size:12px}
    .mini .right{display:flex;align-items:center;gap:10px}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.85}50%{opacity:1}}
    .glow-red{box-shadow:0 0 0 0 rgba(239,68,68,.5);animation:glowRed 2s ease-in-out infinite}
    @keyframes glowRed{0%{box-shadow:0 0 0 0 rgba(239,68,68,.55)}70%{box-shadow:0 0 24px 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .glow-amber{box-shadow:0 0 0 0 rgba(245,158,11,.5);animation:glowAmber 2s ease-in-out infinite}
    @keyframes glowAmber{0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}70%{box-shadow:0 0 24px 12px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}

    /* Standard amendâ†’save affordances */
    .save-glow{box-shadow:0 0 0 0 rgba(34,197,94,.55);animation:glowGreen 2s ease-in-out infinite}
    @keyframes glowGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.55)}70%{box-shadow:0 0 24px 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .edit-pulse{border-color:var(--accent)!important;box-shadow:0 0 0 0 rgba(34,197,94,.45);animation:pulseGreen 1.8s ease-in-out infinite}
    @keyframes pulseGreen{0%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}70%{box-shadow:0 0 20px 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}

    /* Desktop-friendly dashboard grid + extras */
    .hero-grid{display:grid;grid-template-columns:2fr 3fr;gap:12px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}
    .ring.lg{width:120px;height:120px}
    .ring.lg .inner{width:92px;height:92px;font-size:18px}
    .empty{color:var(--muted);padding:6px 0}
    .fade-in{animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @media (max-width:1100px){
      .hero-grid{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:repeat(2,1fr)}
    }

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:960px;width:min(960px,90vw);max-height:85vh;overflow:auto;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-full{width:min(1400px,96vw);height:92vh;display:flex;flex-direction:column}
    .modal-body{flex:1;overflow:auto;padding:8px 2px}
    .modal-header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding-bottom:10px;z-index:2}
    .title-lg{font-size:22px;font-weight:800}
    .title-lg.green{color:#39ff14}
    .modal-header.center-title{justify-content:center;text-align:center}
    .modal-header.center-title .right{position:absolute;right:20px;top:20px}
    .code-chip{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#0f1216}
    .modal .grid.cols-2{grid-template-columns:1.2fr 1fr}
    .modal input,.modal select,.modal textarea{font-size:16px}
    .modal .table-wrap{max-height:48vh}
    .modal .tools .btn.small{font-size:12px;padding:6px 8px}

    /* Standalone login page */
    .login-page{display:grid;place-items:center;min-height:100vh;padding:24px}
    .login-card{width:min(420px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
    .login-brand{font-weight:800;margin-bottom:8px}
    .login-row{display:grid;gap:10px}
    /* Themed select + focus */
    .login-card input:focus, .login-card select:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.22); }
    .select-wrap{ position:relative; }
    .select-wrap select{ appearance:none; -webkit-appearance:none; -moz-appearance:none; padding-right:36px; }
    .select-wrap::after{ content:'â–¾'; position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--muted); font-size:14px; }

    /* Bottom action pills */
    .link-row{ display:flex; gap:8px; justify-content:space-between; align-items:center; }
    .link-pill{ background:transparent; border:1px solid var(--line); color:var(--muted); border-radius:999px; padding:8px 12px; cursor:pointer; }
    .link-pill:hover{ color:var(--text); border-color:#3a3f47; }
    /* Themed links (avoid default blue) */
    .login-card a{ color: var(--muted); text-decoration: none; }
    .login-card a:hover{ color: var(--text); text-decoration: underline; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- Debug box (dev only) -->
  <div id="debugWrap" style="position:fixed;right:8px;bottom:8px;width:360px;z-index:2000">
    <div id="debugTools" style="display:flex;justify-content:flex-end;margin-bottom:6px">
      <button id="copyDebug" class="btn small" style="background:#0f1216;border:1px solid #2a2f36;color:#e8eaed;border-radius:8px;padding:6px 10px;cursor:pointer">Copy log</button>
    </div>
    <div id="debugBox" style="max-height:40vh;overflow:auto;font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;background:#0b0d10;border:1px solid #2a2f36;color:#aab2bd;border-radius:8px;padding:8px;white-space:pre-wrap"></div>
  </div>

  <div id="loginPage" class="login-page">
    <div class="login-card">
      <div class="login-brand">CQC Admin</div>
      <h2 id="lpTitle" style="margin:6px 0 14px 0">Sign in</h2>
      <div id="lpRowCreds" class="login-row">
        <input id="lpEmail" type="email" placeholder="email@example.com" autocomplete="username" />
        <input id="lpPass" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div id="lpSignupExtra" class="login-row hidden" style="margin-top:10px">
        <div class="select-wrap"><select id="lpSiteSelect"></select></div>
      </div>
      <div id="lpPrimaryRow" class="login-row" style="margin-top:10px">
        <button class="btn primary" id="lpSignIn">Sign in</button>
      </div>
      <div id="lpSignupNameRow" class="login-row hidden" style="margin-top:10px">
        <input id="lpName" type="text" placeholder="Full name" />
        <button class="btn primary" id="lpSignIn2">Enter site</button>
      </div>
      <div id="lpMsg" class="muted" style="margin-top:8px"></div>
      <div class="link-row" style="margin-top:12px">
        <button class="link-pill" id="lpSignupLink">Create an account</button>
        <button class="link-pill" id="lpForgotLink">Forgot password?</button>
      </div>
    </div>
  </div>

  <div class="app hidden">
    <aside class="sidebar">
      <div class="brand">CQC Admin</div>
      <div class="status">
        <div id="who">Not signed in</div>
        <div id="site" class="muted">â€”</div>
      </div>
      <div class="nav">
        <button data-tab="tab-dashboard" class="active">Dashboard</button>
        <button data-tab="tab-rooms">Rooms</button>
        <button data-tab="tab-types">Check Types</button>
        <button data-tab="tab-items">Items</button>
        <button data-tab="tab-staff">Staff</button>
        <button data-tab="tab-teams">Teams</button>
        <button data-tab="tab-audits">Audit Log</button>
        <div class="hr"></div>
        <button id="btnLogout">Logout</button>
      </div>
    </aside>

    <main class="main">
      <div id="panel-app" class="hidden">
        <div class="topbar">
          <div class="pill">Admin</div>
          <div class="right">
            <input id="globalSearch" type="text" placeholder="Global searchâ€¦">
            <button class="btn" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="tab-dashboard">
          <div class="dash-header">
            <div class="dash-title">Overview</div>
          </div>

          <div class="hero-grid">
            <div class="card">
              <div class="row" style="gap:18px;align-items:center">
                <div class="ring lg" id="ringProgress"><div class="inner" id="ringInner">0%</div></div>
                <div>
                  <div class="muted">Scheduled checks</div>
                  <div class="dash-big" style="font-size:22px;font-weight:800;margin-top:4px" id="dashProgressText">â€”</div>
                  <div class="muted" style="font-size:12px;margin-top:6px">*of all scheduled items currently within their required window</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="stat-grid">
                <div class="stat-card ok fade-in">
                  <div class="label">OK</div>
                  <div class="value" id="statOk">â€”</div>
                </div>
                <div class="stat-card warn fade-in">
                  <div class="label">Due soon</div>
                  <div class="value" id="statSoon">â€”</div>
                </div>
                <div class="stat-card danger fade-in">
                  <div class="label">Overdue</div>
                  <div class="value" id="statLate">â€”</div>
                </div>
                <div class="stat-card fade-in">
                  <div class="label">Unscheduled</div>
                  <div class="value" id="statUnsch">â€”</div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div class="card">
              <div class="row" style="justify-content:space-between;align-items:center">
                <h3>Overdue</h3>
                <div class="status-badges" id="dashBadges"></div>
              </div>
              <div class="list-mini" id="dashOverdueBody"></div>
            </div>

            <div class="card">
              <h3>Due soon (next 7 days)</h3>
              <div class="list-mini" id="dashSoonBody"></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Due today</h3>
            <div class="list-mini" id="dashTodayBody"></div>
          </div>
        </section>

        <!-- ROOMS -->
        <section id="tab-rooms" class="hidden">
          <div class="card">
            <h3>Add room</h3>
            <div class="row">
              <input id="roomName" type="text" placeholder="Room name">
              <button class="btn primary" id="addRoom">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Rooms</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Owner</th><th>Actions</th></tr></thead>
                <tbody id="roomsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CHECK TYPES -->
        <section id="tab-types" class="hidden">
          <div class="card">
            <h3>Add check type</h3>
            <div class="grid cols-2">
              <input id="typeName" type="text" placeholder="Name (e.g., Date Check)">
              <button class="btn primary" id="addType">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Check types</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Team</th><th>Active</th><th>Actions</th></tr></thead>
                <tbody id="typesBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ITEMS CONFIGURATOR -->
        <section id="tab-items" class="hidden">
          <div class="card">
            <h3>Find & select an item</h3>
            <div class="row" style="margin-bottom:10px">
              <input id="itemSearch" type="text" placeholder="Search by code, name, roomâ€¦">
              <button class="btn" id="refreshItems">Refresh</button>
            </div>
            <div class="table-wrap" style="max-height:42vh">
              <table>
                <thead><tr><th style="width:140px">Code</th><th>Name</th><th>Room</th><th></th></tr></thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Configuration Modal -->
          <div id="cfgModal" class="modal-overlay hidden">
            <div class="modal modal-full" role="document">
              <div class="modal-header center-title">
                <div>
                  <div class="title-lg green" id="cfgName">â€”</div>
                </div>
                <div class="right">
                  <button class="btn" id="cfgClose">Close</button>
                </div>
              </div>
              <div class="modal-body">
                <div id="itemConfig">
                  <div class="card" style="margin:0 0 10px 0">
                    <h3>Details</h3>
                    <div class="grid cols-2">
                      <div>
                        <div class="muted">Item ID (code)</div>
                        <div class="row" style="gap:8px">
                          <input id="cfgCodeInput" type="text" readonly>
                          <button class="btn small" id="cfgEnableEditCode">Change</button>
                        </div>
                      </div>
                      <div>
                        <div class="muted">Room</div>
                        <select id="cfgRoom"></select>
                      </div>
                      <div>
                        <div class="muted">Owner (team)</div>
                        <select id="cfgOwnerRole"></select>
                      </div>
                    </div>
                    <div class="row" style="margin-top:10px;justify-content:flex-start">
                      <button class="btn primary" id="cfgSaveDetails">Save details</button>
                      <span class="muted">Owner will be stored until we add firstâ€‘class support.</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </section>

        <!-- TEAMS -->
        <section id="tab-teams" class="hidden">
          <div class="card">
            <h3>Add team</h3>
            <div class="row">
              <input id="teamName" type="text" placeholder="Team name (e.g., Nurses)">
              <button class="btn primary" id="addTeam">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Teams</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Name</th><th>Members</th><th>Add member</th><th>Actions</th></tr>
                </thead>
                <tbody id="teamsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- STAFF -->
        <section id="tab-staff" class="hidden">
          <div class="card">
            <h3>Add staff</h3>
            <div class="grid cols-3">
              <input id="staffName" type="text" placeholder="Full name">
              <select id="staffRole">
                <option value="staff">staff</option>
                <option value="admin">admin</option>
              </select>
              <button class="btn primary" id="addStaff">Add</button>
            </div>
          </div>
          <div class="card">
            <h3>Staff</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Role</th><th>Teams</th><th>PIN</th><th>Actions</th></tr></thead>
                <tbody id="staffBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AUDITS -->
        <section id="tab-audits" class="hidden">
          <div class="card">
            <h3>Audit log</h3>
            <div class="tools" style="margin-bottom:8px">
              <input id="auditSearch" type="text" placeholder="Search (name, item, code, type)">
              <button class="btn" id="refreshAudits">Refresh</button>
              <button class="btn" id="exportAudits">Export CSV</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>When</th><th>Staff</th><th>Code</th><th>Item</th><th>Room</th><th>Type</th><th>Value</th>
                  </tr>
                </thead>
                <tbody id="auditsBody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Room Items Modal -->
  <div id="roomItemsModal" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="title-lg" id="roomItemsTitle">Items in room</div>
        <div class="right"><button class="btn" id="roomItemsClose">Close</button></div>
      </div>
      <div class="modal-body">
        <div id="roomItemsList" class="list-mini"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";

    // Choose a safe storage (fallback if localStorage/sessionStorage is blocked)
    function getSafeStorage(){
      // Prefer localStorage everywhere if available (more reloadâ€‘friendly)
      try{
        const k='__sb_test__';
        window.localStorage.setItem(k,'1');
        window.localStorage.removeItem(k);
        return window.localStorage;
      }catch(_){}
      // Fallback to sessionStorage
      try{
        const k='__sb_test__';
        window.sessionStorage.setItem(k,'1');
        window.sessionStorage.removeItem(k);
        return window.sessionStorage;
      }catch(_){}
      // Last resort no-op storage (prevents crashes)
      return { getItem(){return null;}, setItem(){}, removeItem(){} };
    }

    // Compute the Supabase auth storage key (matches supabase-js v2)
    function getAuthStorageKey(){
      try{
        const host = new URL(SUPABASE_URL).host; // e.g., unveoqnlqnobufhublyw.supabase.co
        const projectRef = host.split('.')[0];
        return `sb-${projectRef}-auth-token`;
      }catch(_){
        return null;
      }
    }

    const SB_STORAGE = getSafeStorage();
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: SB_STORAGE
      }
    });
    logDebug('Auth persistence: ' + (SB_STORAGE === window.localStorage ? 'localStorage' :
                                     SB_STORAGE === window.sessionStorage ? 'sessionStorage' : 'custom'));

    // Connectivity test helper
    async function checkSupabaseConnectivity(){
      try{
        logDebug('Pinging Supabase /auth settingsâ€¦');
        const res = await fetch(`${SUPABASE_URL}/auth/v1/settings`, { headers: { apikey: SUPABASE_ANON_KEY } });
        logDebug('Ping status: ' + res.status + ' ' + res.statusText);
        return res.ok;
      }catch(err){
        logDebug('Ping failed: ' + (err?.message||err));
        return false;
      }
    }

    // Handle email-confirmation / magic-link redirects (tokens in the URL hash)
    async function handleAuthRedirect(){
      try{
        const hash = window.location.hash || '';
        const hasTokens = hash.includes('access_token') && hash.includes('refresh_token');

        if(hasTokens){
          const p = new URLSearchParams(hash.substring(1));
          const access_token  = p.get('access_token');
          const refresh_token = p.get('refresh_token');
          if(access_token && refresh_token){
            await sb.auth.setSession({ access_token, refresh_token });
          }
          // Clean URL so the hash doesn't linger
          history.replaceState({}, document.title, location.pathname + location.search);
          return;
        }

        // If this is a confirm-email visit without tokens (common on some clients),
        // just show the login page with a helpful message.
        const qs = new URLSearchParams(location.search);
        const isConfirm = hash.includes('type=signup') || qs.get('type') === 'signup' || hash.includes('confirmed=1') || qs.get('confirmed') === '1';
        if(isConfirm){
          document.querySelector('.app')?.classList.add('hidden');
          document.getElementById('loginPage')?.classList.remove('hidden');
          if(typeof setLpAuthMode==='function') setLpAuthMode('login');
          const msg = document.getElementById('lpMsg');
          if(msg) msg.textContent = 'Email confirmed â€” please sign in.';
          // Tidy URL
          history.replaceState({}, document.title, location.pathname);
        }
      }catch(_){ /* ignore */ }
    }

    // Keep UI in sync when auth state changes, but avoid forcing SIGNED_OUT on boot
    sb.auth.onAuthStateChange(async (event, session) => {
      logDebug('onAuthStateChange: ' + event + ' (hasSession=' + Boolean(session) + ')');
      if(event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED'){
        await init();
      }
      // Do not auto-hide on SIGNED_OUT here; init() decides.
    });

    // Give supabase-js time to hydrate session on full reload
    async function waitForHydration(maxMs = 1500){
      const started = performance.now();
      while (performance.now() - started < maxMs) {
        const { data: { session } } = await sb.auth.getSession();
        if (session) return session;
        await new Promise(r => setTimeout(r, 100));
      }
      return null;
    }

    // Rescue session from either storage if needed
    async function rescueSessionFromAnyStorage(){
      const key = getAuthStorageKey();
      if(!key) return false;
      const stores = [SB_STORAGE, window.localStorage, window.sessionStorage]
        .filter(Boolean)
        .filter((v,i,self)=> self.indexOf(v) === i);
      for (const store of stores){
        try{
          const raw = typeof store.getItem === 'function' ? store.getItem(key) : null;
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          const cur = parsed?.currentSession || parsed?.session || null;
          const access_token  = cur?.access_token  || cur?.accessToken  || null;
          const refresh_token = cur?.refresh_token || cur?.refreshToken || null;
          if(access_token && refresh_token){
            const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
            if(error){ logDebug('setSession failed while rescuing: ' + (error.message||error)); continue; }
            if(data?.session){
              logDebug('Rescued session from ' + (store === window.localStorage ? 'localStorage' :
                                                  store === window.sessionStorage ? 'sessionStorage' : 'custom'));
              return true;
            }
          }
        }catch(err){ logDebug('rescueSession error: ' + (err?.message||err)); }
      }
      return false;
    }

    function __boot(){
      initDebugFromStorage();
      setupCopyDebugButton();
      logDebug('Bootingâ€¦ protocol='+location.protocol+' href='+location.href);
      (async()=>{
        try{
          await handleAuthRedirect();
        }catch(_){ /* ignore */ }
        await init();
      })();
    }
    if(document.readyState === 'loading'){
      window.addEventListener('DOMContentLoaded', __boot);
    }else{
      __boot();
    }

    // ====== STATE ======
    const S = {
      user: null, profile: null, siteId: null,
      rooms: [], types: [], typesByCat: {}, items: [], staff: [], audits: [],
      dashStatus: [], dashSummary: [],
      teams: [], teamMembers: [], checkTypeTeams: [],
      typeTeamById: {}, typeTeamByName: {}
    };
    S.selectedItem = null;

    // ====== HELPERS ======
    function $(id){ return document.getElementById(id); }
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
    function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(_){ return s; } }
    function setActiveTab(id){
      document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $(id)?.classList.remove('hidden');
    }
    function updateKPIs(){
      const r=$('kpiRooms'); if(r) r.textContent = S.rooms.length;
      const t=$('kpiTypes'); if(t) t.textContent = S.types.length;
      const i=$('kpiItems'); if(i) i.textContent = S.items.length;
      const s=$('kpiStaff'); if(s) s.textContent = S.staff.length;
    }
    function buildTypesByCat(){
      S.typesByCat = {};
      for (const t of S.types.filter(x=>x.active !== false)){
        if (!S.typesByCat[t.category]) S.typesByCat[t.category] = [];
        S.typesByCat[t.category].push(t);
      }
      for(const k in S.typesByCat){ S.typesByCat[k].sort((a,b)=>a.name.localeCompare(b.name)); }
    }
    function fillItemPickers(){
      // Legacy form removed â€” safely bail if controls don't exist
      const rSel = $('itemRoom');
      const tSel = $('itemType');
      const catEl = $('itemCategory');
      if(!rSel || !tSel || !catEl) return;
      // Rooms
      rSel.innerHTML = '';
      const rOpt = (id, name)=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; rSel.appendChild(o); };
      const sortedRooms = [...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sortedRooms.length===0){ rOpt('', '(no rooms yet)'); } else { sortedRooms.forEach(r=>rOpt(r.id, r.name)); }
      // Types (by selected category)
      const cat = catEl.value || 'general';
      tSel.innerHTML = '';
      const types = S.typesByCat[cat] || S.typesByCat['general'] || [];
      if(types.length===0){
        const o=document.createElement('option'); o.value=''; o.textContent='(no types for '+cat+')'; tSel.appendChild(o);
      }else{
        for(const t of types){ const o=document.createElement('option'); o.value=t.name; o.textContent=t.name; tSel.appendChild(o); }
      }
    }
    function filterTextMatch(hay, needle){
      const n = (needle||'').trim().toLowerCase();
      if(!n) return true;
      return (hay||'').toString().toLowerCase().includes(n);
    }
    function download(filename, text){
      const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click();
    }

    function hideTeamsUI(){
      document.querySelector('.nav button[data-tab="tab-teams"]')?.classList.add('hidden');
      document.getElementById('tab-teams')?.classList.add('hidden');
    }

    function isPinSet(v){
      return typeof v === 'string' && v.trim() !== '' && v.trim().toUpperCase() !== 'EMPTY';
    }

    function openCfgModal(){ const m=$('cfgModal'); if(m) m.classList.remove('hidden'); }
    function closeCfgModal(){ const m=$('cfgModal'); if(m) m.classList.add('hidden'); }

    // Room items modal helpers
    function openRoomItemsModal(title, items){
      const m = $('roomItemsModal');
      const titleEl = $('roomItemsTitle');
      const list = $('roomItemsList');
      if(titleEl) titleEl.textContent = title || 'Items';
      if(list){
        if(!items || items.length===0){
          list.innerHTML = '<div class="empty">No items in this room</div>';
        }else{
          list.innerHTML = items.map(n => `<div class="mini"><div class="left"><div class="title">${n}</div></div></div>`).join('');
        }
      }
      if(m) m.classList.remove('hidden');
    }
    function closeRoomItemsModal(){ const m=$('roomItemsModal'); if(m) m.classList.add('hidden'); }

    // ====== INIT & AUTH ======
    async function init(){
      logDebug('init(): fetching sessionâ€¦');

      const appEl = document.querySelector('.app');
      const loginEl = document.getElementById('loginPage');

      // 0) Give supabase-js a moment to hydrate from storage
      let { data: { session } } = await sb.auth.getSession();
      if (!session) {
        const hydrated = await waitForHydration(1500);
        if (hydrated) session = hydrated;
        logDebug('After hydration wait: hasSession=' + Boolean(session));
      }
      // 1) if still missing, try to rescue from any storage and THEN update `session`
      if (!session) {
        const rescued = await rescueSessionFromAnyStorage();
        if (rescued) ({ data: { session } } = await sb.auth.getSession());
      }
      // 2) proceed based on the UPDATED `session`
      if (!session) {
        appEl?.classList.add('hidden');
        loginEl?.classList.remove('hidden');
        const btn = document.getElementById('lpSignIn'); if (btn) btn.disabled = false;
        populateSiteSelect();
        return;
      }

      // --- App boot after session present ---
      S.user = session.user;
      $('who').textContent = S.user.email || 'Signed in';

      // Get profile â†’ site, auto-create if missing using user_metadata
      const { data: prof, error } = await sb
        .from('profiles')
        .select('site_id, full_name, role')
        .eq('user_id', S.user.id)
        .limit(1);

      if(error){
        logDebug('profiles select error: ' + (error?.message||error));
        // Fallback to user metadata when RLS blocks profiles or table is missing
        const meta = (S.user && S.user.user_metadata) || {};
        const metaSite = Number(meta.site_id)||null;
        const metaName = meta.full_name || null;
        if(metaSite){
          logDebug('Using metadata fallback for site: ' + metaSite);
          S.profile = { site_id: metaSite, full_name: metaName, role: 'admin' };
          S.siteId = metaSite;
          $('site').textContent = `Site ${S.siteId}`;
          document.getElementById('loginPage')?.classList.add('hidden');
          document.querySelector('.app')?.classList.remove('hidden');
          $('panel-app')?.classList.remove('hidden');
          await refreshAll();
          toast('Using metadata profile (profiles locked by RLS)');
          return;
        }
        toast(error.message);
        return;
      }

      let profileRow = (prof && prof[0]) || null;
      if(!profileRow){
        logDebug('No profile found from select; attempting metadata/auto-create path');
        const meta = (S.user && S.user.user_metadata) || {};
        const metaSite = Number(meta.site_id)||null;
        const metaName = meta.full_name || null;
        if(metaSite){
          const { error: insErr } = await sb.from('profiles').insert({
            user_id: S.user.id,
            site_id: metaSite,
            full_name: metaName,
            role: 'admin'
          });
          if(!insErr){
            const { data: prof2 } = await sb
              .from('profiles')
              .select('site_id, full_name, role')
              .eq('user_id', S.user.id)
              .limit(1);
            profileRow = (prof2 && prof2[0]) || null;
          }
        }
      }
      if(!profileRow){ $('site').textContent='No profile/site'; toast('No profile found â€” ask admin to assign your site.'); return; }

      S.profile = profileRow; S.siteId = S.profile.site_id;
      $('site').textContent = `Site ${S.siteId}`;
      document.getElementById('loginPage')?.classList.add('hidden');
      document.querySelector('.app')?.classList.remove('hidden');
      $('panel-app')?.classList.remove('hidden');
      await refreshAll();
    }

    async function refreshAll(){
      await Promise.all([
        loadRooms(), loadTypes(), loadItems(), loadStaff(), loadAudits(),
        loadCheckStatus(), loadCheckSummary(),
        loadTeams(), loadTeamMembers(), loadCheckTypeTeams()
      ]);
      buildTypesByCat();
      buildTypeTeamMap();
      fillItemPickers();
      renderRooms(); renderTypes(); renderItems(); renderStaff(); renderTeams(); renderAudits(); renderDashboard();
      updateKPIs();
    }

    async function loadCheckStatus(){
      const { data, error } = await sb.from('v_item_check_status')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashStatus = data||[]; else toast(error.message);
    }
    async function loadCheckSummary(){
      const { data, error } = await sb.from('v_item_check_summary')
        .select('*').eq('site_id', S.siteId);
      if(!error) S.dashSummary = data||[]; else toast(error.message);
    }
    function relTime(toIso){
      const t = new Date(toIso).getTime();
      const now = Date.now();
      const diff = Math.round((t - now)/1000); // seconds
      const abs = Math.abs(diff);
      const d = Math.floor(abs/86400), h = Math.floor((abs%86400)/3600), m = Math.floor((abs%3600)/60);
      const base = d ? `${d}d ${h}h` : h ? `${h}h ${m}m` : `${m}m`;
      return diff >= 0 ? `in ${base}` : `${base} ago`;
    }
    function setRing(percent){
      const p = Math.max(0, Math.min(100, Math.round(percent)));
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      if(ring) ring.style.setProperty('--p', p);
      if(inner) inner.textContent = p + '%';
    }

    function animateNumber(el, to){
      if(!el) return;
      const from = parseInt(el.getAttribute('data-prev')||el.textContent||'0',10) || 0;
      const start = performance.now(), dur = 450;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const val = Math.round(from + (to-from)*t);
        el.textContent = val;
        if(t < 1) requestAnimationFrame(step); else el.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function setRingAnimated(percent){
      const ring = document.getElementById('ringProgress');
      const inner = document.getElementById('ringInner');
      const from = parseInt(inner?.getAttribute('data-prev')||'0',10) || 0;
      const to = Math.max(0, Math.min(100, Math.round(percent)));
      const start = performance.now(), dur = 650;
      function step(ts){
        const t = Math.min(1,(ts-start)/dur);
        const p = Math.round(from + (to-from)*t);
        if(ring) ring.style.setProperty('--p', p);
        if(inner) inner.textContent = p + '%';
        if(t < 1) requestAnimationFrame(step); else inner?.setAttribute('data-prev', String(to));
      }
      requestAnimationFrame(step);
    }
    function renderDashboard(){
      const byStatus = Object.fromEntries(S.dashSummary.map(r => [r.status, r.count]));
      const ok = byStatus.ok||0, soon = byStatus.due_soon||0, late = byStatus.overdue||0, uns = byStatus.unscheduled||0;
      const scheduled = ok + soon + late;
      const pct = scheduled ? Math.round((ok / scheduled) * 100) : 0;
      setRingAnimated(pct);
      const progText = document.getElementById('dashProgressText');
      if(progText) progText.textContent = `${ok}/${scheduled} within window`;

      const badgeWrap = document.getElementById('dashBadges');
      if(badgeWrap){
        badgeWrap.innerHTML = `
          <span class="badge"><span class="dot ok"></span> OK ${ok}</span>
          <span class="badge"><span class="dot soon"></span> Due soon ${soon}</span>
          <span class="badge"><span class="dot late"></span> Overdue ${late}</span>
          <span class="badge"><span class="dot"></span> Unscheduled ${uns}</span>`;
      }
      animateNumber($('statOk'), ok);
      animateNumber($('statSoon'), soon);
      animateNumber($('statLate'), late);
      animateNumber($('statUnsch'), uns);

      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);

      const overdue = S.dashStatus.filter(x => x.status === 'overdue')
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));
      const dueSoon = S.dashStatus.filter(x => x.status === 'due_soon' && new Date(x.next_due_at) > todayEnd)
        .sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at))
        .filter(x => (new Date(x.next_due_at) - todayEnd) <= 7*86400000);
      const dueToday = S.dashStatus.filter(x => {
        const d = new Date(x.next_due_at);
        return d >= todayStart && d <= todayEnd && (x.status === 'due_soon' || x.status === 'overdue');
      }).sort((a,b)=> new Date(a.next_due_at) - new Date(b.next_due_at));

      function rowHTML(x, cls){
        const due = new Date(x.next_due_at);
        const ownerTeam = S.typeTeamByName[x.check_type]?.name || '';
        const title = `${x.item_name} â€¢ ${x.check_type}`;
        const sub = `${x.room_name||''} â€¢ due ${due.toLocaleString()} â€¢ ${relTime(x.next_due_at)}`;
        return `<div class="mini ${cls}">
          <div class="left">
            <div class="title">${title}</div>
            <div class="sub">${sub}</div>
          </div>
          <div class="right">
            ${ownerTeam ? `<span class="tag" title="owner team">${ownerTeam}</span>` : ''}
            <div class="ring small" style="--p:0"><div class="inner" title="frequency">${x.frequency}</div></div>
            <button class="btn small" data-act="manageItem" data-code="${x.item_code}">Manage</button>
          </div>
        </div>`;
      }

      const od = $('dashOverdueBody'); if(od) od.innerHTML = overdue.map(x => rowHTML(x, 'glow-red')).join('') || '<div class="empty">Nothing overdue ðŸŽ‰</div>';
      const ds = $('dashSoonBody'); if(ds) ds.innerHTML = dueSoon.map(x => rowHTML(x, 'glow-amber')).join('') || '<div class="empty">Nothing due soon</div>';
      const td = $('dashTodayBody'); if(td) td.innerHTML = dueToday.map(x => rowHTML(x, 'pulse')).join('') || '<div class="empty">Nothing due today</div>';
    }

    // ====== LOADERS ======
    async function loadRooms(){
      const { data, error } = await sb.from('rooms').select('id,name,occupied_by').eq('site_id', S.siteId).order('name');
      if(!error) S.rooms = data||[]; else toast(error.message);
    }
    async function loadTypes(){
      const { data, error } = await sb.from('check_types').select('id,name,category,active').eq('site_id', S.siteId).order('name');
      if(!error) S.types = data||[]; else toast(error.message);
    }
    async function loadItems(){
      const { data, error } = await sb.from('v_items_admin')
        .select('id,site_id,item_id,item_name,category,active,room_id,room_name,default_check_type_id,default_check_type_name,comments')
        .eq('site_id', S.siteId).order('item_name');
      if(!error) S.items = data||[]; else toast(error.message);
    }
    async function loadStaff(){
      const { data, error } = await sb.from('kiosk_users').select('id,full_name,role,pin').eq('site_id', S.siteId).order('full_name');
      if(!error) S.staff = data||[]; else toast(error.message);
    }
    async function loadAudits(){
      const { data, error } = await sb.from('v_submission_detail')
        .select('*').eq('site_id', S.siteId).order('submitted_at', { ascending:false }).limit(200);
      if(!error) S.audits = data||[]; else toast(error.message);
    }

    async function loadTeams(){
      const { data, error } = await sb.from('teams')
        .select('id,name').eq('site_id', S.siteId).order('name');
      if(error){
        if((error.message||'').includes('Could not find the table')){
          S.teams = [];
          hideTeamsUI();
          return;
        }
        toast(error.message); return;
      }
      S.teams = data||[];
    }
    async function loadTeamMembers(){
      const { data, error } = await sb.from('team_members')
        .select('team_id,user_id').eq('site_id', S.siteId);
      if(error){
        if((error.message||'').includes('Could not find the table')){ S.teamMembers = []; return; }
        toast(error.message); return;
      }
      S.teamMembers = data||[];
    }
    async function loadCheckTypeTeams(){
      const { data, error } = await sb.from('check_type_teams')
        .select('check_type_id,team_id').eq('site_id', S.siteId);
      if(error){
        if((error.message||'').includes('Could not find the table')){
          S.checkTypeTeams = [];
          buildTypeTeamMap();
          return;
        }
        toast(error.message); return;
      }
      S.checkTypeTeams = data||[];
      buildTypeTeamMap();
    }

    function buildTypeTeamMap(){
      S.typeTeamById = {}; S.typeTeamByName = {};
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t]));
      for(const m of (S.checkTypeTeams||[])){
        const team = teamById[m.team_id];
        if(team) S.typeTeamById[m.check_type_id] = team;
      }
      for(const t of (S.types||[])){
        const team = S.typeTeamById[t.id];
        if(team) S.typeTeamByName[t.name] = team;
      }
    }

    // ====== RENDERERS ======
    function renderRooms(){
      const tb=$('roomsBody'); tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      const staffOptions = ['<option value="">(none)</option>']
        .concat((S.staff||[]).map(s=>`<option value="${s.id}">${s.full_name}</option>`))
        .join('');

      for(const r of S.rooms){
        const ownerName = r.occupied_by ? (staffById[r.occupied_by] || '') : '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td data-cell="owner">
            <span class="owner-text">${ownerName || ''}</span>
            <select class="owner-select hidden">${staffOptions}</select>
          </td>
          <td class="tools">
            <button class="btn small" data-act="viewItems" data-id="${r.id}" data-room-name="${r.name}">View items</button>
            <button class="btn small" data-act="editOwner" data-id="${r.id}" data-mode="edit">Edit owner</button>
            <button class="btn small hidden" data-act="cancelOwner" data-id="${r.id}">Cancel</button>
            <button class="btn small" data-act="rename" data-id="${r.id}">Rename</button>
            <button class="btn small danger" data-act="del" data-id="${r.id}">Delete</button>
          </td>`;
        const sel = tr.querySelector('select.owner-select');
        if(sel) sel.value = r.occupied_by || '';
        tb.appendChild(tr);
      }
    }

    function renderTypes(){
      const tb=$('typesBody'); tb.innerHTML='';
      const teamOpts = ['<option value="">(none)</option>']
        .concat((S.teams||[]).map(t=>`<option value="${t.id}">${t.name}</option>`))
        .join('');
      for(const t of S.types){
        const selectedTeam = S.typeTeamById[t.id]?.id || '';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>
            <select class="type-team-select" data-act="typeTeam" data-id="${t.id}">
              ${teamOpts}
            </select>
          </td>
          <td>${t.active===false?'<span class="danger-text">no</span>':'yes'}</td>
          <td class="tools">
            <button class="btn small" data-act="toggleType" data-id="${t.id}">${t.active===false?'Activate':'Deactivate'}</button>
            <button class="btn small" data-act="renameType" data-id="${t.id}">Rename</button>
            <button class="btn small danger" data-act="delType" data-id="${t.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
        const sel = tr.querySelector('select.type-team-select');
        if(sel) sel.value = selectedTeam;
      }
    }

    function renderTeams(){
      const tb=$('teamsBody'); if(!tb) return; tb.innerHTML='';
      const staffById = Object.fromEntries((S.staff||[]).map(s=>[s.id, s.full_name]));
      for(const team of (S.teams||[])){
        const members = (S.teamMembers||[]).filter(m=>m.team_id===team.id).map(m=>({ id:m.user_id, name:staffById[m.user_id]||'?' }));
        const memberChips = members.length
          ? members.map(m=>`<span class="chip" data-act="removeMember" data-team="${team.id}" data-user="${m.id}">${m.name} âœ•</span>`).join(' ')
          : '<span class="muted">(no members)</span>';
        const nonMembers = (S.staff||[]).filter(s=>!members.some(m=>m.id===s.id));
        const addOpts = ['<option value="">Select staffâ€¦</option>']
          .concat(nonMembers.map(s=>`<option value="${s.id}">${s.full_name}</option>`)).join('');
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${team.name}</td>
          <td>${memberChips}</td>
          <td class="row" style="gap:8px">
            <select class="team-add-member" data-team="${team.id}">${addOpts}</select>
            <button class="btn small" data-act="addMember" data-team="${team.id}">Add</button>
          </td>
          <td class="tools">
            <button class="btn small" data-act="renameTeam" data-id="${team.id}">Rename</button>
            <button class="btn small danger" data-act="delTeam" data-id="${team.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderItems(){
      const q = $('itemSearch')?.value || $('globalSearch')?.value || '';
      const tb=$('itemsBody'); if(!tb) return; tb.innerHTML='';
      const rows = S.items.filter(r =>
        filterTextMatch(r.item_id, q) || filterTextMatch(r.item_name, q) || filterTextMatch(r.room_name, q)
      );
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.item_id}</td>
          <td>${r.item_name}</td>
          <td>${r.room_name||'<span class="muted">(none)</span>'}</td>
          <td class="tools">
            <button class="btn small" data-act="cfg" data-code="${r.item_id}">Configure</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function fillOwnerRoles(){
      const sel=$('cfgOwnerRole'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); };
      mk('','(none)');
      const sortedTeams = [...(S.teams||[])].sort((a,b)=>a.name.localeCompare(b.name));
      sortedTeams.forEach(t=>mk(t.name, t.name));
    }
    function fillCfgRooms(){
      const sel=$('cfgRoom'); if(!sel) return; sel.innerHTML='';
      const mk=(v,l)=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); };
      const sorted=[...S.rooms].sort((a,b)=>a.name.localeCompare(b.name));
      if(sorted.length===0) mk('', '(no rooms yet)'); else sorted.forEach(r=>mk(r.id,r.name));
    }

    function renderStaff(){
      const tb=$('staffBody'); tb.innerHTML='';
      const teamById = Object.fromEntries((S.teams||[]).map(t=>[t.id, t.name]));
      const teamsForUser = (uid)=> (S.teamMembers||[]).filter(m=>m.user_id===uid).map(m=>teamById[m.team_id]).filter(Boolean);
      for(const s of S.staff){
        const tnames = teamsForUser(s.id);
        const teamHtml = tnames.length ? tnames.map(n=>`<span class=\"tag\">${n}</span>`).join(' ') : '<span class=\"muted\">(none)</span>';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${s.full_name}</td>
          <td>${s.role}</td>
          <td>${teamHtml}</td>
          <td>${isPinSet(s.pin) ? 'set' : '<span class=\"muted\">not set</span>'}</td>
          <td class=\"tools\">
            <button class=\"btn small\" data-act=\"setPin\" data-id=\"${s.id}\">Set PIN</button>
            <button class=\"btn small\" data-act=\"renameStaff\" data-id=\"${s.id}\">Rename</button>
            <button class=\"btn small\" data-act=\"roleStaff\" data-id=\"${s.id}\">Change role</button>
            <button class=\"btn small danger\" data-act=\"delStaff\" data-id=\"${s.id}\">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function renderAudits(){
      const q=$('auditSearch').value||'';
      const tb=$('auditsBody'); tb.innerHTML='';
      const rows = S.audits.filter(r =>
        filterTextMatch(r.staff_name,q) || filterTextMatch(r.item_name,q) || filterTextMatch(r.scanned_code,q) || filterTextMatch(r.check_type,q)
      );
      for(const a of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(a.submitted_at)}</td>
          <td>${a.staff_name}</td>
          <td class="mono">${a.scanned_code}</td>
          <td>${a.item_name||''}</td>
          <td>${a.room||''}</td>
          <td>${a.check_type||''}</td>
          <td>${a.check_value||''}</td>`;
        tb.appendChild(tr);
      }
    }

    // ====== ACTIONS ======
    // Login + Sign-up (standalone page)
    let lpAuthMode = 'login';
    let lpSignupStep = 1; // 1: email/pass/site, 2: full name

    async function populateSiteSelect(){
      const sel = $('lpSiteSelect'); if(!sel) return;
      sel.innerHTML = '<option value="">Loading sitesâ€¦</option>';
      sel.disabled = true;
      const { data, error } = await sb.from('sites').select('id,name').order('name');
      if(error){
        sel.innerHTML = '<option value="">(failed to load sites)</option>';
        sel.disabled = false;
        return;
      }
      const rows = data || [];
      if(rows.length === 0){
        sel.innerHTML = '<option value="">(no sites available â€” ask admin)</option>';
        sel.disabled = false;
        return;
      }
      sel.innerHTML = '<option value="">Select siteâ€¦</option>' + rows.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      sel.disabled = false;
    }

    function setSignupStep(step){
      lpSignupStep = step;
      const rowCreds = $('lpRowCreds');
      const rowSite  = $('lpSignupExtra');
      const rowName  = $('lpSignupNameRow');
      const btn1     = $('lpSignIn');
      const btn2     = $('lpSignIn2');
      if(step === 1){
        rowCreds?.classList.remove('hidden');
        rowSite?.classList.remove('hidden');
        rowName?.classList.add('hidden');
        btn1?.classList.remove('hidden');
        if(btn1) btn1.textContent = 'Create account';
        btn2?.classList.add('hidden');
        if($('lpTitle')) $('lpTitle').textContent = 'Create an account';
        populateSiteSelect();
      } else {
        rowCreds?.classList.add('hidden');
        rowSite?.classList.add('hidden');
        rowName?.classList.remove('hidden');
        btn1?.classList.add('hidden');
        if(btn2){ btn2.classList.remove('hidden'); btn2.textContent = 'Enter site'; }
        if($('lpTitle')) $('lpTitle').textContent = 'Create an account';
      }
      $('lpMsg').textContent = '';
    }

    function setLpAuthMode(mode){
      lpAuthMode = mode;
      const link  = document.getElementById('lpSignupLink');
      const title = document.getElementById('lpTitle');
      if(mode==='signup'){
        if(link)  link.textContent  = 'Have an account? Sign in';
        if(title) title.textContent = 'Create an account';
        setSignupStep(1);
      } else {
        if(link)  link.textContent  = 'Create an account';
        if(title) title.textContent = 'Sign in';
        const btn = $('lpSignIn'); if(btn) btn.textContent = 'Sign in';
        $('lpRowCreds')?.classList.remove('hidden');
        $('lpSignupExtra')?.classList.add('hidden');
        $('lpSignupNameRow')?.classList.add('hidden');
        $('lpSignIn')?.classList.remove('hidden');
        $('lpMsg').textContent = '';
      }
    }

    async function doLogin(){
      const email=$('lpEmail').value.trim(), password=$('lpPass').value;
      logDebug("== LOGIN PROCESS STARTED ==");
      logDebug("Email entered: " + email);
      if(!email || !password){
        $('lpMsg').textContent = 'Enter email and password.';
        logDebug("Missing email or password.");
        $('lpSignIn')?.removeAttribute('disabled');
        return;
      }

      const onFileProtocol = location.protocol === 'file:';
      if(onFileProtocol){
        logDebug('Warning: Page loaded via file:// â€” some browsers (e.g., Safari) restrict auth/storage for the null origin. Running from http://localhost is recommended.');
      }
      logDebug('Storage in use: ' + (SB_STORAGE === window.localStorage ? 'localStorage' : SB_STORAGE === window.sessionStorage ? 'sessionStorage' : 'custom') + ' â€¢ key=' + (getAuthStorageKey() || '(none)'));

      // If a session already exists, don't clear it â€” just initialise the app
      try{
        const { data: { session } } = await sb.auth.getSession();
        if(session){
          logDebug('Already signed in; running init() instead of sign-in.');
          await init();
          return;
        }
      }catch(_){ /* ignore */ }

      $('lpMsg').textContent = 'Signing inâ€¦';

      // Show progress ticks if network hangs
      let tick = 0; let tickTimer = setInterval(()=>{
        tick++; $('lpMsg').textContent = 'Signing in' + '.'.repeat((tick%3)+1);
        if(tick===4){ logDebug('Still waiting for Supabaseâ€¦ (network or CORS issue?)'); }
      }, 800);

      try {
        logDebug("Sending credentials to Supabase...");

        // Race with a soft timeout to surface hangs
        const timeout = new Promise((_,rej)=> setTimeout(()=> rej(new Error('Auth request timed out (15s)')),15000));
        const signInPromise = sb.auth.signInWithPassword({ email, password });

        const { data, error } = await Promise.race([signInPromise, timeout]);

        logDebug("Supabase responded.");
        if(error){
          logDebug("Supabase error: " + JSON.stringify(error));
          $('lpMsg').textContent = error.message || 'Login failed.';
          $('lpSignIn')?.removeAttribute('disabled');
          return;
        }
        logDebug('Session received: ' + (!!data?.session));
        // Poll for session (handles rare timing where getSession lags signIn)
        let tries = 0; let sessOk = false;
        while(tries < 8){
          const sNow = await sb.auth.getSession();
          if(sNow?.data?.session){ sessOk = true; break; }
          await new Promise(r=>setTimeout(r, 100));
          tries++;
        }
        logDebug('Post-login session available: ' + sessOk + ' after ' + tries + ' checks');
        $('lpMsg').textContent='';
        logDebug("Calling init()...");
        await init();
        logDebug("Init complete.");
      } catch (err) {
        logDebug("Unexpected error: " + (err?.message||err?.toString()||'unknown'));
        $('lpMsg').textContent = (err && err.message) ? err.message : 'Login failed (network).';
        $('lpSignIn')?.removeAttribute('disabled');
      } finally {
        $('lpSignIn')?.removeAttribute('disabled');
        clearInterval(tickTimer);
      }
    }

    async function doSignup(){
      const email=$('lpEmail').value.trim(), password=$('lpPass').value;
      const full_name=($('lpName').value||'').trim();
      const site_id = Number(($('lpSiteSelect')?.value) || 1);
      if(!email || !password){ $('lpMsg').textContent = 'Email and password required.'; return; }
      $('lpMsg').textContent = 'Creating accountâ€¦';
      const { data, error } = await sb.auth.signUp({
        email, password,
        options: {
          data: { site_id, full_name },
          emailRedirectTo: location.origin + location.pathname + '#confirmed=1'
        }
      });
      if(error){ $('lpMsg').textContent = error.message; return; }
      try{
        const userId = data?.user?.id;
        if(userId){
          await sb.from('profiles').insert({ user_id:userId, site_id, full_name, role:'admin' });
        }
      }catch(_){ /* ignore */ }
      if(data?.session){
        $('lpMsg').textContent = 'Account created!';
        await init();
      }else{
        setLpAuthMode('login');
        $('lpMsg').textContent = `We sent a confirmation link to ${email}. Once confirmed, return here and sign in.`;
        const btn = $('lpSignIn'); if(btn) btn.textContent = 'Sign in';
        $('lpPass').value = '';
      }
    }

    $('lpSignIn').addEventListener('click', async ()=>{
      const btn = $('lpSignIn'); if(btn) btn.disabled = true; setTimeout(()=>{ if(btn) btn.disabled = false; }, 18000);
      if(lpAuthMode==='signup'){
        const email=$('lpEmail').value.trim();
        const password=$('lpPass').value;
        const siteId = $('lpSiteSelect')?.value || '';
        if(!email || !password){ $('lpMsg').textContent='Enter email and password.'; if(btn) btn.disabled = false; return; }
        if(!siteId){ $('lpMsg').textContent='Please select a site.'; if(btn) btn.disabled = false; return; }
        setSignupStep(2);
        $('lpMsg').textContent = 'Almost there â€” add your full name.';
        $('lpName')?.focus();
      } else {
        await doLogin();
      }
    });
    $('lpSignIn2').addEventListener('click', async ()=>{
      if(lpAuthMode!=='signup' || lpSignupStep!==2) return;
      await doSignup();
    });
    $('lpPass').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        if(lpAuthMode==='signup' && lpSignupStep===2) $('lpSignIn2').click(); else $('lpSignIn').click();
      }
    });
    document.getElementById('lpSignupLink').addEventListener('click', (e)=>{
      e.preventDefault(); setLpAuthMode(lpAuthMode==='login' ? 'signup' : 'login');
    });
    document.getElementById('lpForgotLink').addEventListener('click', (e)=>{ e.preventDefault(); alert('Password reset coming soon.'); });

    $('btnLogout').addEventListener('click', async ()=>{
      try{
        const { error } = await sb.auth.signOut({ scope: 'global' });
        if(error){
          await sb.auth.signOut({ scope: 'local' });
        }
      }catch(_){
        try{ await sb.auth.signOut({ scope: 'local' }); }catch(__){}
      }finally{
        S.user = null; S.profile = null; S.siteId = null;
        document.querySelector('.app')?.classList.add('hidden');
        document.getElementById('loginPage')?.classList.remove('hidden');
        document.getElementById('who').textContent = 'Not signed in';
        document.getElementById('site').textContent = 'â€”';
      }
    });

    // Navigation & common
    document.querySelectorAll('.nav button[data-tab]').forEach(b=>b.addEventListener('click', ()=> setActiveTab(b.dataset.tab)));
    $('btnRefresh').addEventListener('click', refreshAll);
    $('globalSearch').addEventListener('input', ()=>{ renderItems(); renderAudits(); });

    // Dashboard manage buttons
    document.getElementById('tab-dashboard').addEventListener('click', (e)=>{
      const b=e.target.closest('button[data-act="manageItem"]'); if(!b) return;
      const code=b.dataset.code;
      const it=S.items.find(x=>x.item_id===code);
      if(!it){ toast('Item not found'); return; }
      setActiveTab('tab-items');
      S.selectedItem = it;
      openCfgModal();
      $('cfgCodeInput').value = it.item_id;
      $('cfgCodeInput').readOnly = true;
      $('cfgName').textContent = it.item_name || '';
      const _btnEC = $('cfgEnableEditCode');
      if(_btnEC){
        _btnEC.textContent = 'Change';
        _btnEC.classList.remove('save-glow');
        _btnEC.dataset.mode = 'change';
      }
      $('cfgCodeInput').classList.remove('edit-pulse');
      fillCfgRooms();
      fillOwnerRoles();
      if(it.room_name) $('cfgRoom').value = it.room_name;
      $('cfgOwnerRole').value = '';
      toast('Opened in configurator');
    });

    // Rooms tab actions
    $('addRoom').addEventListener('click', async ()=>{
      const name=$('roomName').value.trim(); if(!name) return;
      const { error } = await sb.from('rooms').insert({ site_id:S.siteId, name });
      if(error) return toast(error.message);
      $('roomName').value=''; await loadRooms(); renderRooms(); fillItemPickers(); updateKPIs(); toast('Room added');
    });
    $('roomsBody').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const id=Number(btn.dataset.id); const act=btn.dataset.act;
      const tr = btn.closest('tr');

      if(act==='viewItems'){
        const room = S.rooms.find(rr=>rr.id===id);
        const roomName = room?.name || btn.getAttribute('data-room-name') || 'Room';
        const items = (S.items||[])
          .filter(it => (it.room_id === id) || (it.room_name === roomName))
          .map(it => it.item_name);
        openRoomItemsModal(`Items in ${roomName}`, items);
        return;
      }

      if(act==='editOwner'){
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        const cancelBtn = tr.querySelector('button[data-act="cancelOwner"]');

        if(btn.dataset.mode !== 'save'){
          btn.dataset.mode = 'save';
          btn.textContent = 'Save';
          btn.classList.add('save-glow');
          sel.classList.remove('hidden');
          sel.classList.add('edit-pulse');
          text.classList.add('hidden');
          cancelBtn.classList.remove('hidden');
          sel.focus();
          return;
        }

        const newOwner = sel.value ? Number(sel.value) : null;
        const { error } = await sb.from('rooms').update({ occupied_by: newOwner }).eq('id', id).eq('site_id', S.siteId);
        if(error){ toast(error.message); return; }
        await loadRooms();
        renderRooms();
        toast('Owner updated');
        return;
      }

      if(act==='cancelOwner'){
        const editBtn = tr.querySelector('button[data-act="editOwner"]');
        const sel = tr.querySelector('select.owner-select');
        const text = tr.querySelector('.owner-text');
        editBtn.dataset.mode = 'edit';
        editBtn.textContent = 'Edit owner';
        editBtn.classList.remove('save-glow');
        sel.classList.add('hidden');
        sel.classList.remove('edit-pulse');
        text.classList.remove('hidden');
        btn.classList.add('hidden');
        return;
      }

      if(act==='rename'){
        const row=S.rooms.find(r=>r.id===id); const name=prompt('New room name', row?.name||''); if(!name) return;
        const { error } = await sb.from('rooms').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room renamed');
        return;
      }

      if(act==='del'){
        if(!confirm('Delete this room?')) return;
        const { error } = await sb.from('rooms').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadRooms(); renderRooms(); fillItemPickers(); toast('Room deleted');
        return;
      }
    });

    // Types tab
    $('addType').addEventListener('click', async ()=>{
      const name = $('typeName').value.trim();
      const catEl = $('typeCategory');
      const category = catEl ? catEl.value : 'general';
      if(!name) return;
      const { error } = await sb.from('check_types').insert({ site_id:S.siteId, name, category, active:true });
      if(error) return toast(error.message);
      $('typeName').value=''; await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); updateKPIs(); toast('Type added');
    });
    $('typesBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==='toggleType'){
        const t=S.types.find(x=>x.id===id); const active = !(t?.active===false);
        const { error } = await sb.from('check_types').update({ active: !active }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type toggled');
      }
      if(act==='renameType'){
        const t=S.types.find(x=>x.id===id); const name=prompt('New type name', t?.name||''); if(!name) return;
        const { error } = await sb.from('check_types').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type renamed');
      }
      if(act==='delType'){
        if(!confirm('Delete this check type?')) return;
        const { error } = await sb.from('check_types').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTypes(); buildTypesByCat(); renderTypes(); fillItemPickers(); toast('Type deleted');
      }
    });
    async function setTypeTeam(checkTypeId, teamId){
      const delRes = await sb.from('check_type_teams').delete()
        .eq('site_id', S.siteId).eq('check_type_id', checkTypeId);
      if(delRes.error){
        if((delRes.error.message||'').includes('Could not find the table')){
          toast('Team-owner feature is not enabled in your database (missing check_type_teams).');
          return;
        }
        toast(delRes.error.message); return;
      }
      if(teamId){
        const insRes = await sb.from('check_type_teams').insert({
          site_id:S.siteId, check_type_id: checkTypeId, team_id: Number(teamId)
        });
        if(insRes.error){
          if((insRes.error.message||'').includes('Could not find the table')){
            toast('Team-owner feature is not enabled in your database (missing check_type_teams).');
            return;
          }
          toast(insRes.error.message); return;
        }
      }
      await loadCheckTypeTeams(); buildTypeTeamMap(); renderTypes(); renderDashboard();
      toast('Team updated');
    }
    $('typesBody').addEventListener('change', async (e)=>{
      const sel = e.target.closest('select[data-act="typeTeam"]'); if(!sel) return;
      const id = Number(sel.getAttribute('data-id'));
      const teamId = sel.value || null;
      await setTypeTeam(id, teamId);
    });

    // Teams
    const _addTeam = $('addTeam'); if(_addTeam){ _addTeam.addEventListener('click', async ()=>{
      const name = ($('teamName').value||'').trim(); if(!name) return;
      const { error } = await sb.from('teams').insert({ site_id:S.siteId, name });
      if(error) return toast(error.message);
      $('teamName').value=''; await loadTeams(); renderTeams(); toast('Team added');
    }); }
    const _teamsBody = $('teamsBody'); if(_teamsBody){ _teamsBody.addEventListener('click', async (e)=>{
      const b = e.target.closest('button,span.chip'); if(!b) return;
      const act = b.getAttribute('data-act');
      if(act==='renameTeam'){
        const id = Number(b.getAttribute('data-id'));
        const row = (S.teams||[]).find(t=>t.id===id);
        const name = prompt('New team name', row?.name||''); if(!name) return;
        const { error } = await sb.from('teams').update({ name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadTeams(); renderTeams(); renderTypes(); buildTypeTeamMap(); toast('Renamed');
      }
      if(act==='delTeam'){
        const id = Number(b.getAttribute('data-id'));
        if(!confirm('Delete this team?')) return;
        await sb.from('team_members').delete().eq('team_id', id).eq('site_id', S.siteId);
        await sb.from('check_type_teams').delete().eq('team_id', id).eq('site_id', S.siteId);
        const { error } = await sb.from('teams').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await Promise.all([loadTeams(), loadTeamMembers(), loadCheckTypeTeams()]);
        buildTypeTeamMap(); renderTeams(); renderTypes(); renderDashboard(); toast('Team deleted');
      }
      if(act==='addMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const sel = b.parentElement.querySelector('select.team-add-member');
        const userId = Number(sel?.value||''); if(!userId) return;
        const { error } = await sb.from('team_members').insert({ site_id:S.siteId, team_id:teamId, user_id:userId });
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member added');
      }
      if(act==='removeMember'){
        const teamId = Number(b.getAttribute('data-team'));
        const userId = Number(b.getAttribute('data-user'));
        const { error } = await sb.from('team_members').delete().eq('site_id', S.siteId).eq('team_id', teamId).eq('user_id', userId);
        if(error) return toast(error.message);
        await loadTeamMembers(); renderTeams(); renderStaff(); toast('Member removed');
      }
    }); }

    // Items tab
    const _itemCategoryEl = $('itemCategory'); if(_itemCategoryEl){ _itemCategoryEl.addEventListener('change', fillItemPickers); }
    const _saveItemBtn = $('saveItem');
    if(_saveItemBtn){
      _saveItemBtn.addEventListener('click', async ()=>{
        const p = {
          p_site_id: S.siteId,
          p_item_id: $('itemCode').value.trim(),
          p_item_name: $('itemName').value.trim(),
          p_room_name: $('itemRoom').value,
          p_category: $('itemCategory').value,
          p_default_check_type_name: $('itemType').value,
          p_comments: $('itemComments').value.trim() || null
        };
        if(!p.p_item_id || !p.p_item_name){ return toast('Code & name required'); }
        const { data, error } = await sb.rpc('admin_upsert_item', p);
        if(error) return toast(error.message);
        await loadItems(); renderItems(); updateKPIs(); toast('Item saved');
      });
    }
    $('itemSearch').addEventListener('input', renderItems);
    $('refreshItems').addEventListener('click', async ()=>{ await loadItems(); renderItems(); });

    // Items configurator
    $('itemsBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const act=b.dataset.act;
      if(act==='cfg'){
        const code=b.dataset.code;
        const it=S.items.find(x=>x.item_id===code);
        if(!it) return;
        S.selectedItem = it;
        openCfgModal();
        $('cfgCodeInput').value = it.item_id;
        $('cfgCodeInput').readOnly = true;
        $('cfgName').textContent = it.item_name || '';
        const _btnEC = $('cfgEnableEditCode');
        if(_btnEC){
          _btnEC.textContent = 'Change';
          _btnEC.classList.remove('save-glow');
          _btnEC.dataset.mode = 'change';
        }
        $('cfgCodeInput').classList.remove('edit-pulse');
        fillCfgRooms(); fillOwnerRoles();
        if(it.room_name) $('cfgRoom').value = it.room_name;
        $('cfgOwnerRole').value = '';
      }
    });

    // Code edit toggle
    $('cfgEnableEditCode').addEventListener('click', ()=>{
      const btn = $('cfgEnableEditCode');
      const input = $('cfgCodeInput');
      if(btn.dataset.mode !== 'save'){
        btn.dataset.mode = 'save';
        btn.textContent = 'Save code';
        btn.classList.add('save-glow');
        input.readOnly = false;
        input.classList.add('edit-pulse');
        input.focus();
        input.select();
      }else{
        input.readOnly = true;
        btn.dataset.mode = 'change';
        btn.textContent = 'Change';
        btn.classList.remove('save-glow');
        input.classList.remove('edit-pulse');
        toast('Code staged (save details to persist).');
      }
    });

    // Save details (room + owner role)
    $('cfgSaveDetails').addEventListener('click', async ()=>{
      if(!S.selectedItem) return;
      const roomName = $('cfgRoom').value;
      const ownerRole = $('cfgOwnerRole').value;
      const itemId = $('cfgCodeInput').value.trim();
      const { error } = await sb.rpc('admin_upsert_item', {
        p_site_id: S.siteId,
        p_item_id: itemId,
        p_item_name: S.selectedItem.item_name,
        p_room_name: roomName,
        p_category: S.selectedItem.category,
        p_default_check_type_name: S.selectedItem.default_check_type_name || null,
        p_comments: (S.selectedItem.comments||'').replace(/owner:\s*.*$/i,'').trim() + (ownerRole?` owner: ${ownerRole}`:'')
      });
      if(error) return toast(error.message);
      await loadItems();
      S.selectedItem = S.items.find(x=>x.item_id===itemId);
      toast('Details saved');
    });
    $('cfgClose').addEventListener('click', closeCfgModal);

    // Staff tab
    $('addStaff').addEventListener('click', async ()=>{
      const full_name=$('staffName').value.trim(); const role=$('staffRole').value;
      if(!full_name) return;
      const { error } = await sb.from('kiosk_users').insert({ site_id:S.siteId, full_name, role });
      if(error) return toast(error.message);
      $('staffName').value='';
      await loadStaff(); renderStaff(); updateKPIs(); toast('Staff added');
    });
    $('staffBody').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id = Number(b.dataset.id); const act = b.dataset.act;
      if(act==='setPin'){
        const pin = prompt('Enter new PIN (4-6 digits)'); if(pin===null) return;
        if(!/^\d{4,6}$/.test(pin)){ toast('PIN must be 4â€“6 digits'); return; }
        const { error } = await sb.from('kiosk_users').update({ pin }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('PIN updated');
      }
      if(act==='renameStaff'){
        const row = S.staff.find(s=>s.id===id);
        const name = prompt('New name', row?.full_name||''); if(!name) return;
        const { error } = await sb.from('kiosk_users').update({ full_name:name }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Renamed');
      }
      if(act==='roleStaff'){
        const row = S.staff.find(s=>s.id===id);
        const role = prompt('Role ("staff" or "admin")', row?.role||'staff'); if(!role) return;
        if(!/^(staff|admin)$/i.test(role)){ toast('Role must be "staff" or "admin"'); return; }
        const { error } = await sb.from('kiosk_users').update({ role:role.toLowerCase() }).eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await loadStaff(); renderStaff(); toast('Role updated');
      }
      if(act==='delStaff'){
        if(!confirm('Delete this staff member?')) return;
        await sb.from('team_members').delete().eq('user_id', id).eq('site_id', S.siteId);
        const { error } = await sb.from('kiosk_users').delete().eq('id', id).eq('site_id', S.siteId);
        if(error) return toast(error.message);
        await Promise.all([loadStaff(), loadTeamMembers()]); renderStaff(); renderTeams(); toast('Staff deleted');
      }
    });

    // Audits tab
    $('auditSearch').addEventListener('input', renderAudits);
    $('refreshAudits').addEventListener('click', async ()=>{ await loadAudits(); renderAudits(); });
    $('exportAudits').addEventListener('click', ()=>{
      const rows = S.audits || [];
      if(rows.length === 0){ toast('Nothing to export'); return; }
      const header = ['When','Staff','Code','Item','Room','Type','Value'];
      const csvRows = [header.join(',')].concat(rows.map(a => [
        JSON.stringify(fmtDate(a.submitted_at)),
        JSON.stringify(a.staff_name||''),
        JSON.stringify(a.scanned_code||''),
        JSON.stringify(a.item_name||''),
        JSON.stringify(a.room||''),
        JSON.stringify(a.check_type||''),
        JSON.stringify(a.check_value||'')
      ].join(',')));
      download(`audits_site_${S.siteId}.csv`, csvRows.join('\n'));
      toast('Exported CSV');
    });

    // Modal and misc close handlers
    $('roomItemsClose').addEventListener('click', closeRoomItemsModal);

  </script>
</body>
</html>
