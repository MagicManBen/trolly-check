<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CQC – PIN Portal (DEBUG BUILD)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
h1,h2{margin:0 0 20px}

/* ---------- modern core look & feel ---------- */
body{
  margin:0;
  background:#141314;
  color:#fff;
  font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  text-align:center;
  padding:40px;
}
input,button,select,textarea{font-size:1rem;padding:10px;border:none;border-radius:6px}
input[type=password],input[type=text]{background:#111;color:#fff;letter-spacing:8px;width:160px;text-align:center}
button{
  cursor:pointer;
  background:#1e8c1e;
  color:#fff;
  border-radius:12px;
  box-shadow:0 8px 18px rgba(30,140,30,.25), inset 0 -2px 0 rgba(0,0,0,.25);
  transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;
}
button:hover{ box-shadow:0 10px 22px rgba(30,140,30,.35), inset 0 -2px 0 rgba(0,0,0,.25); }
button:active{ transform:translateY(1px) scale(.99); }
#status{margin-top:15px;font-weight:bold}
#welcome{
  margin-top:12px;
  font-size:1.35rem;
  color:#d3ffd3;
  background:rgba(30,140,30,.16);
  border:1px solid rgba(30,140,30,.55);
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
}
/* hide the welcome pill until there’s content to prevent the small green square */
#welcome:empty{display:none}

/* keypad */
#keypad{margin:25px auto 10px;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#keypad .key{
  background:#333;color:#fff;border-radius:10px;font-size:1.3rem;padding:16px 0;
  user-select:none;transition:transform .05s ease, background .05s ease;box-shadow:none;
}
#keypad .wide{grid-column:span 3}
#keypad .zero{grid-column:2}

/* pressed visual */
.key.pressed{background:#555;color:#fff;transform:scale(0.96)}
/* login success banner */

.login-success{display:none;color:#1e8c1e;font-weight:bold;margin-top:8px;font-size:1.1rem}

/* PIN loading overlay + keypad disabled state */
#pinLoading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
#pinLoading .panel{
  background:#1a1a1a;
  border:1px solid #333;
  border-radius:14px;
  padding:18px 22px;
  min-width:240px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.4);
}
#pinLoading .panel.ok{border-color:#1e8c1e;box-shadow:0 14px 34px rgba(30,140,30,.25), inset 0 0 24px rgba(30,140,30,.25)}
#pinLoading .pin-msg{font-size:1.05rem;color:#ddd}
#pinLoading .pin-error{ color:#ff6961; font-weight:700 }
#pinLoading .pin-welcome{font-size:1.25rem;color:#d3ffd3;font-weight:800}
#pinLoading .check{width:56px;height:56px;border-radius:50%;border:4px solid #1e8c1e;position:relative;display:none}
#pinLoading .check:after{content:"";position:absolute;left:14px;top:18px;width:14px;height:26px;border-right:4px solid #1e8c1e;border-bottom:4px solid #1e8c1e;transform:rotate(45deg)}
#pinLoading .panel.ok .spinner{display:none}
#pinLoading .panel.ok .check{display:block}
#pinLoading .spinner{ width:64px;height:64px;border-width:8px }
#keypad.disabled{ opacity:.5 }
#keypad.disabled .key{ pointer-events:none }
#pin[readonly]{ opacity:.8 }

/* hide scanner inputs but keep them usable */
.scanner{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
#visibleBulkInput{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}

/* debug panel (button removed) */
#debug{position:fixed;bottom:80px;left:20px;width:300px;max-height:50vh;overflow:auto;background:#111;padding:10px;border:1px solid #555;border-radius:8px;font-family:Consolas,monospace;font-size:.75rem;display:none}
#debug pre{margin:0;white-space:pre-wrap}

/* pages */
.page{display:none !important}
.active{display:block !important}

#qrCodeWrapper,#auditMsgWrapper,#doneScreen,#outputPage{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh}

/* upload page elements */
@keyframes glowEdge{from{box-shadow:0 0 6px #1e8c1e}to{box-shadow:0 0 20px #1e8c1e}}
.scanning{animation:glowEdge .5s ease-in-out infinite alternate;border:2px solid #1e8c1e!important}
#progressAnim{display:none;flex-direction:column;align-items:center;margin-top:20px}
.spinner{width:80px;height:80px;border:10px solid #1e8c1e;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#uploadText{margin-top:12px;font-size:1.2rem;color:#1e8c1e;font-weight:bold}

/* --- Page 4 (Upload) layout fixes --- */
.upload-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
  align-items:center;
  justify-items:center;
  margin-top:12px;
}
@media (min-width: 720px){
  .upload-grid{ grid-template-columns: 1fr 1fr; }
}
.scan-illustration{ /* keep image tidy and consistent with other pages */
  display:block;
  max-width:min(44vw,260px);
  height:auto;
}
#uploadQr{ /* match card-ish look used elsewhere */
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  min-width:240px; /* ensure QR has room even before JS writes it */
  min-height:240px;
}
#scanCount{ margin-top:10px; color:#ddd; }
/* Animated scan counter that replaces the QR after first scan */
.count-anim{ display:flex; flex-direction:column; align-items:center; justify-content:center; width:240px; height:240px }
.count-outer{ width:200px; height:200px; border-radius:50%; border:6px solid #1e8c1e; box-shadow:inset 0 0 30px rgba(30,140,30,.35), 0 0 18px rgba(30,140,30,.25); display:flex; align-items:center; justify-content:center; animation:pulseSoft 2s ease-in-out infinite }
.count-number{ font-size:56px; font-weight:900; line-height:1; letter-spacing:.5px }
.count-number.pop{ animation:pop .25s ease }
.count-label{ margin-top:8px; color:#d3ffd3; font-weight:700 }
@keyframes pop{ 0%{ transform:scale(1) } 50%{ transform:scale(1.12) } 100%{ transform:scale(1) } }
/* progress ring */
.progress-ring{position:relative;width:120px;height:120px}
.progress-ring svg{transform:rotate(-90deg)}
.progress-ring__bg{stroke:#333;stroke-width:10;fill:none}
.progress-ring__circle{stroke:#1e8c1e;stroke-width:10;fill:none;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.progress-ring__label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:bold}
#progressText{margin-top:14px;font-size:1.4rem;color:#fff;font-weight:bold}

/* review table (Page 5) */
.review-wrap{width:96%;max-width:980px;margin:0 auto}
.review-note{color:#bbb;margin:6px 0 14px;font-size:.95rem}
.table{width:100%;border-collapse:collapse;background:#fff;color:#000;border-radius:14px;overflow:hidden;table-layout:fixed;box-shadow:0 14px 30px rgba(0,0,0,.35)}
.table th,.table td{border:1px solid #ddd;padding:10px;vertical-align:middle;text-align:center}
.table th{background:#f3f3f3;font-weight:600;font-size:.95rem}
.table td.item-col,.table td.room-col{text-align:left}
.table td.item-col{width:30%}
.table td.room-col{width:14%}
.chk-cell{display:flex;align-items:center;justify-content:center;gap:6px}
.chk-cell input[type="checkbox"]{transform:scale(1.2)}
.actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
#submitChecksBtn{background:#1e8c1e;color:#fff;border-radius:12px;padding:12px 18px;font-size:1.05rem}
#submitChecksBtn[disabled]{opacity:.6;cursor:not-allowed}
.success-msg{color:#1e8c1e;font-weight:bold;margin-top:10px}
.error-msg{color:#ff6961;font-weight:bold;margin-top:10px}

/* temperature panel below table */
#tempSection{display:none;margin:12px 0 6px;padding:10px;background:#1a1a1a;border:1px solid #333;border-radius:12px;width:96%;max-width:980px}
#tempSection h3{margin:0 0 8px;font-size:1.05rem;color:#ddd}
.temp-row{display:grid;grid-template-columns:1.2fr .8fr auto;gap:10px;align-items:center;margin:6px 0}
.temp-row .label{color:#ddd;text-align:left}
.temp-input{width:56px;padding:6px 8px;border:1px solid #bbb;border-radius:8px;font-size:1rem;text-align:center}
.temp-hint{color:#aaa;font-size:.85rem;text-align:left}

/* session comment */
.comment-wrap{width:96%;max-width:980px;margin:12px auto 0}
#sessionComment{
  width:100%;
  min-height:64px;
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:10px 12px;
  font-size:1rem;
  resize:vertical;
}

/* + button & modal styles */
button.danger{background:#b30000}
#plusBtn{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 16px);right:calc(env(safe-area-inset-right,0px) + 16px);width:48px;height:48px;border-radius:50%;font-size:28px;padding:6px 0;z-index:10000}

/* admin button (bottom-left) */
#adminBtn{
  position:fixed;
  bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
  left:calc(env(safe-area-inset-left,0px) + 16px);
  width:48px;height:48px;border-radius:50%;font-size:22px;padding:6px 0;z-index:10000;
  background:#2d2d2d;
  box-shadow:none !important;
}
#adminBtn:hover{ box-shadow:none !important; }

/* check type manager */
#adminChecksForm{ display:none }
.checktype-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#2a2a2a;border:1px solid #3a3a3a;border-radius:10px;padding:8px 10px;margin:6px 0}
.checktype-name{flex:1;text-align:left}
.icon-btn{background:#333;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
.icon-btn.danger{background:#6b1a1a}
#checkTypeList{max-height:40vh;overflow:auto;margin-top:8px}
#newCheckTypeRow{display:flex;gap:8px;margin-top:10px}
#newCheckTypeInput{flex:1;letter-spacing:0;text-align:left}

/* admin modal */
#adminModal{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; justify-content:center; align-items:center; z-index:11000; }
#adminBox{ background:#222; padding:20px; border-radius:12px; width:90%; max-width:420px }
#adminBox h2{ margin-top:0 }
#adminBox .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
#adminMenu button{ width:100% }
#adminAddUserForm{ display:none }
#adminAddUserForm .hint{ color:#bbb; font-size:.9rem; margin-top:6px }

/* Admin form input overrides */
#adminUserName{
  width:100%;
  letter-spacing:0;
  text-align:left;
}
#adminUserPin{
  width:160px; /* keep compact, but not stretched like name */
  letter-spacing:8px; /* keep PIN look */
  text-align:center;
}
.admin-pin{
  width:160px;
  letter-spacing:8px;
  text-align:center;
}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center}
#box{background:#222;padding:20px;border-radius:12px;width:90%;max-width:380px}
#box select,#box input{width:100%;margin:6px 0}

/* Admin PIN modal (smaller keypad + dot display) */
#adminPinModal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:12000}
#adminPinBox{position:relative;background:#222;padding:16px 16px 18px;border-radius:12px;width:90%;max-width:340px;text-align:center}
/* hidden input kept for programmatic value only */
#adminPinBox input{width:100%;margin:6px 0}
/* close button */
#adminPinClose{
  position:absolute;top:8px;right:8px;background:#2a2a2a;border:none;border-radius:8px;width:32px;height:32px;
  color:#fff;font-size:20px;cursor:pointer
}
/* dot display */
.pin-dots{display:flex;justify-content:center;gap:10px;margin:8px 0 4px}
.pin-dot{width:12px;height:12px;border-radius:50%;border:2px solid #777}
.pin-dot.filled{background:#fff;border-color:#fff}
/* smaller keypad */
#adminPinKeypad{margin:10px auto;display:grid;grid-template-columns:repeat(3,60px);gap:8px;justify-content:center}
#adminPinKeypad .key{background:#333;color:#fff;border-radius:10px;font-size:1.1rem;padding:14px 0;user-select:none;transition:transform .05s ease, background .05s ease;box-shadow:none}
#adminPinKeypad .key.wide{grid-column:span 3}
/* shake animation for wrong PIN */
@keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.shake{animation:shakeX .45s ease}

/* modal keypad */
#modalKeypad{margin:10px auto;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#modalKeypad .key{
  background:#333;color:#fff;border-radius:10px;font-size:1.3rem;padding:16px 0;
  user-select:none;transition:transform .05s ease, background .05s ease;box-shadow:none;
}

/* user badge — bottom center */
.user-badge{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);color:#aaa;background:transparent;padding:0;border-radius:0;font-size:.95rem;opacity:1;z-index:9999;display:none}

/* page 2 spacing + bigger instruction */
#qrCodeWrapper{gap:28px}
#clickText{margin-top:28px}
#qrTitle{
  font-size:1.7rem;
  font-weight:800;
  letter-spacing:.3px;
  text-shadow:0 2px 10px rgba(0,0,0,.6);
  animation:glowText 1.4s ease-in-out infinite alternate;
}
@keyframes glowText{
  from{ text-shadow:0 0 6px rgba(255,255,255,.4), 0 0 0 #1e8c1e; }
  to{ text-shadow:0 0 14px rgba(255,255,255,.9), 0 0 18px rgba(30,140,30,.65); }
}

/* instructional images (responsive for vertical iPad) */
.instruction-img{display:block;margin:16px auto 0;max-width:80vw;height:auto}
#page1 .instruction-img{max-width:60vw;max-height:30vh;margin-top:12px}
#page2 .instruction-img{max-width:70vw;max-height:32vh}
#page3 .instruction-img{max-width:70vw;max-height:35vh;margin-top:16px}

/* cards */
  .card{
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px;
    backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    padding:16px;
  }
  .card.narrow{width:min(92vw,560px);margin:0 auto}

/* --- Page 3 (Audit) — redesigned full-screen hero --- */
.audit-hero{
  position:relative;
  min-height:100vh;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.audit-bg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  opacity:.8;
  filter:brightness(.75);
  z-index:0;
}
.audit-overlay{
  position:absolute;
  inset:0;
  background:
    radial-gradient(60% 60% at 50% 40%, rgba(0,0,0,.0) 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,.65) 100%),
    linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.65));
  z-index:1;
}
.audit-center{
  position:relative;
  z-index:2;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:18px;
  padding:32px 16px;
  text-align:center;
  max-width:780px;
  width:100%;
}
/* Big animated ring */
.audit-ring{
  position:relative;
  width:min(78vw,380px);
  height:min(78vw,380px);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.audit-ring:before,
.audit-ring:after{
  content:"";
  position:absolute; inset:0; border-radius:50%;
}
.audit-ring:before{
  border:6px solid #1e8c1e;
  box-shadow:inset 0 0 40px rgba(30,140,30,.35), 0 0 26px rgba(30,140,30,.25);
  animation:pulseExpand 1.6s ease-in-out infinite;
}
.audit-ring:after{
  content:"";
  position:absolute; inset:-10px; border-radius:50%;
  border:0;
  box-shadow:0 0 0 0 rgba(30,140,30,.5);
  animation:ripple 1.6s ease-out infinite;
}

/* auditor name pill */
.auditor-pill{
  margin-top:6px;
  padding:6px 12px;
  border-radius:999px;
  background:rgba(30,140,30,.16);
  border:1px solid rgba(30,140,30,.55);
  color:#d3ffd3;
  font-weight:700;
}
/* small orbiting dot to make the ring feel alive */
.audit-orbit{ display:none !important }
.audit-title{
  position:absolute;
  text-align:center;
  padding:0 24px;
}
.audit-title .big{
  font-size:clamp(1.6rem, 3.8vw, 2.2rem);
  font-weight:900;
  letter-spacing:.3px;
}
.audit-title .sub{
  margin-top:8px;
  font-size:clamp(1rem, 2.4vw, 1.15rem);
  color:#d3ffd3;
  line-height:1.35;
}
.audit-steps{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
  width:min(92vw,720px);
  margin-top:6px;
}
.audit-step{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:10px 12px;
  text-align:center;
}
.audit-step b{ color:#d3ffd3 }
.audit-bottom{
  position:relative;
  z-index:2;
  margin-top:8px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.audit-qr{ padding:10px; background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.12); border-radius:12px }
.audit-tip{ color:#cfe8cf; font-size:.95rem }
@keyframes pulseSoft{
  0%,100%{ box-shadow:inset 0 0 26px rgba(30,140,30,.35), 0 0 16px rgba(30,140,30,.2) }
  50%{ box-shadow:inset 0 0 46px rgba(30,140,30,.5), 0 0 24px rgba(30,140,30,.35) }
}
@keyframes pulseExpand{
  0%{ transform:scale(.95) }
  50%{ transform:scale(1.05) }
  100%{ transform:scale(.95) }
}
@keyframes ripple{
  0%{ box-shadow:0 0 0 0 rgba(30,140,30,.5); opacity:1 }
  100%{ box-shadow:0 0 0 24px rgba(30,140,30,0); opacity:0 }
}
.audit-orbit{ display:none !important }

#beginBtn{background:#fff!important;color:#000!important;border:2px solid #000;border-radius:12px;padding:14px 22px;font-size:1.15rem}

  /* done animation */
  .done-wrap{position:relative;width:160px;height:160px;border-radius:50%;background:#0e0e0e;border:3px solid #1e8c1e;display:flex;align-items:center;justify-content:center;animation:pulse 1.8s ease-in-out 2}
  .tick{width:60px;height:30px;border-left:6px solid #1e8c1e;border-bottom:6px solid #1e8c1e;transform:rotate(-45deg) translateY(-6px);opacity:0;animation:draw .6s .3s ease forwards}
  .burst{position:absolute;width:8px;height:8px;background:#1e8c1e;border-radius:50%;opacity:0}
  .b1{animation:burst 1.2s .4s ease-out forwards}
  .b2{animation:burst 1.2s .6s ease-out forwards}
  .b3{animation:burst 1.2s .8s ease-out forwards}
  @keyframes draw{to{opacity:1;transform:rotate(-45deg) translateY(-6px) scale(1.05)}}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(30,140,30,.5)}50%{box-shadow:0 0 30px 6px rgba(30,140,30,.45)}}
  @keyframes burst{0%{opacity:0;transform:translate(0,0) scale(.8)}50%{opacity:1}100%{opacity:0;transform:translate(var(--x,0),var(--y,0)) scale(1)}}
  .b1{--x:-60px;--y:-20px}
  .b2{--x:50px;--y:-10px}
  .b3{--x:0px;--y:60px}
  /* --- Page 7 (Final step: reset scanner) --- */
  #finalResetWrapper{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh}
  #finalResetCard{width:min(92vw,560px);margin:0 auto}
  #resetQr{
    display:flex;align-items:center;justify-content:center;
    padding:10px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;min-width:240px;min-height:240px
  }
  .final-title{font-size:1.5rem;font-weight:800;letter-spacing:.3px;margin:0 0 8px}
  .final-sub{color:#cfe8cf;margin:6px 0 14px}
  .final-actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
  #returnCountdown{color:#bbb;font-size:.95rem;margin-top:8px}
  #returnNowBtn{background:#2d2d2d}
</style>
</head>
<body>

<div id="page1" class="page active">
  <div class="card narrow">
    <h1>Enter 4 digit PIN</h1>
    <input id="pin" type="password" maxlength="4" placeholder="****" readonly>
    <div id="keypad">
      <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
      <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
      <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
      <button class="key zero" type="button">0</button>
      <button class="key wide" data-act="clear" type="button">Clear</button>
    </div>
    <img id="wristbandImg" class="instruction-img" src="WristBand.png" alt="Attach the wrist strap" />
  </div>
  <div id="pinLoading" role="alert" aria-live="polite">
    <div class="panel">
      <div class="spinner"></div>
      <div class="check"></div>
      <div id="pinMsg" class="pin-msg">Checking PIN…</div>
    </div>
  </div>
  <button id="plusBtn" type="button">+</button>
  <button id="adminBtn" type="button" aria-label="Admin menu">⚙️</button>
  <div id="status"></div><div id="welcome"></div>
  <div id="loginSuccess" class="login-success">Login successful</div>
</div>

<div id="page2" class="page">
  <div id="qrCodeWrapper">
    <div class="card" style="width:min(92vw,560px);margin:0 auto">
      <div id="qrTitle">Press button once and wait for two beeps</div>
      <img id="doubleBeepImg" class="instruction-img" src="DoubleDeep.png" alt="Wait for two beeps" />
      <div id="qrCode"></div>
      <div id="clickText">After 2 beeps, click the BEGIN button below</div>
      <button id="beginBtn" type="button" style="margin-top:8px">Begin</button>
    </div>
  </div>
</div>

<div id="page3" class="page">
  <div class="audit-hero">
    <div class="audit-center">
      <div class="audit-ring" aria-hidden="true">
        <div class="audit-orbit" aria-hidden="true"></div>
        <div class="audit-title">
          <div class="big">Audit in progress</div>
          <div class="sub">Scan the QR on each item as you check it.<br>When finished, return to this iPad.</div>
        </div>
      </div>

      <div id="auditorPill" class="auditor-pill" style="display:none;"></div>

      <img id="auditPhoto" class="instruction-img" src="ScanTrolly.png" alt="Scan items during your round" />

      <div id="qrCodeAudit" class="audit-qr"></div>
    </div>
  </div>
  <input id="hiddenScanner3" class="scanner" type="text" autocomplete="off">
</div>

<div id="page4" class="page">
  <div id="doneScreen">
    <div class="card" style="width:min(92vw,560px);margin:0 auto">
      <h2>Finished your audit? Scan this code to upload</h2>
      <div class="upload-grid">
        <img id="ipadScanImg" class="scan-illustration" src="IPADSCAN.png" alt="Scan the iPad screen">
        <div id="uploadQr"></div>
      </div>
      <input id="visibleBulkInput" autocomplete="off">
    </div>
  </div>
</div>

<div id="page5" class="page">
  <div id="outputPage" class="review-wrap card">
    <h2>Review checks before submitting</h2>
    <div class="review-note">Select the checks performed for each item.</div>
    <div id="reviewTable"></div>

    <div id="tempSection">
      <h3>Temperatures</h3>
      <div id="tempRows"></div>
      <div class="temp-hint">Enter a 1–2 digit value for each item you ticked as "Temperature".</div>
    </div>

    <div id="commentSection" class="comment-wrap">
      <textarea id="sessionComment" maxlength="280" placeholder="Optional comment for this submission…"></textarea>
    </div>

    <div class="actions">
      <button id="submitChecksBtn" type="button" disabled>Submit</button>
    </div>
    <div id="submitMsg" aria-live="polite"></div>
  </div>
</div>

<div id="page6" class="page">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh">
    <div class="done-wrap">
      <div class="tick"></div>
      <div class="burst b1"></div>
      <div class="burst b2"></div>
      <div class="burst b3"></div>
    </div>
    <h2 style="margin-top:18px">All set!</h2>
  </div>
</div>
<div id="page7" class="page">
  <div id="finalResetWrapper">
    <div id="finalResetCard" class="card">
      <h2 class="final-title">Final step: clear the handheld</h2>
      <div class="final-sub">Hold the scanner to this code to erase its stored scans, then return it to the dock.</div>
      <div id="resetQr"></div>
      <div id="returnCountdown" aria-live="polite"></div>
      <div class="final-actions">
        <button id="returnNowBtn" type="button">Back to start</button>
      </div>
    </div>
  </div>
</div>

<div id="modal">
  <div id="box">
    <h2>Create PIN</h2>
    <select id="userSel"></select>
    <input id="pin1" type="password" maxlength="4" placeholder="New PIN" readonly />
    <input id="pin2" type="password" maxlength="4" placeholder="Confirm PIN" readonly />
    <div id="modalKeypad">
      <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
      <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
      <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
      <button class="key wide" data-act="clear" type="button">C</button>
      <button class="key" type="button">0</button><button class="key wide" data-act="del" type="button">←</button>
    </div>
    <button id="save" type="button">Save PIN</button>
    <button class="danger" id="cancel" type="button">Cancel</button>
    <div id="modalMsg"></div>
  </div>
</div>

<div id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div id="adminBox">
    <h2 id="adminTitle">Admin</h2>

    <div id="adminMenu">
      <button id="openAddUser" type="button">Add User</button>
      <button id="openManageChecks" type="button">Manage Check Types</button>
    </div>

    <div id="adminAddUserForm">
      <label for="adminUserName" style="display:block;text-align:left">Name</label>
      <input id="adminUserName" type="text" placeholder="Full name" autocomplete="off" />
      <label for="adminUserPin" style="display:block;text-align:left;margin-top:8px">PIN (optional, 4 digits)</label>
      <input id="adminUserPin" type="password" maxlength="4" inputmode="numeric" pattern="\\d{4}" placeholder="****" />
      <div class="hint">Leave PIN blank to create the user without a PIN.</div>

      <div class="actions">
        <button id="adminSubmit" type="button">Submit</button>
      </div>
    </div>

    <div id="adminChecksForm">
      <h3 style="margin:0 0 10px;text-align:left">Check Types</h3>
      <div id="checkTypeList"></div>
      <div id="newCheckTypeRow">
        <input id="newCheckTypeInput" type="text" placeholder="Add a new check type…" autocomplete="off" />
        <button id="addCheckTypeBtn" type="button" class="icon-btn">+</button>
      </div>
      <div class="hint" style="text-align:left;margin-top:8px">These appear as columns on the Review table. Rename or delete with the icons.</div>
      <div class="actions">
        <button id="saveCheckTypesBtn" type="button">Save</button>
      </div>
    </div>

    <div id="adminMsg" style="margin-top:10px;min-height:1.2em"></div>
    <div class="actions">
      <button id="adminClose" type="button" class="danger">Close</button>
    </div>
  </div>
</div>

<div id="adminPinModal" role="dialog" aria-modal="true" aria-labelledby="adminPinTitle" style="display:none">
  <div id="adminPinBox">
    <button id="adminPinClose" type="button" aria-label="Close">×</button>
    <h2 id="adminPinTitle">Enter Admin PIN</h2>
    <input id="adminPinInput" class="admin-pin" type="password" maxlength="4" placeholder="****" readonly style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" />
    <div id="adminPinDots" class="pin-dots" aria-hidden="true">
      <span class="pin-dot"></span><span class="pin-dot"></span><span class="pin-dot"></span><span class="pin-dot"></span>
    </div>
    <div id="adminPinKeypad">
      <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
      <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
      <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
      <button class="key wide" data-act="clear" type="button">C</button>
      <button class="key wide" type="button">0</button>
    </div>
    <div id="adminPinMsg" style="margin-top:8px;min-height:1.2em"></div>
  </div>
</div>

<div id="userBadge" class="user-badge"></div>

<div id="debug"><pre id="debugLog"></pre></div>

<script>
const FLOW_VALIDATE = "https://prod-89.westeurope.logic.azure.com:443/workflows/f1639be7e1a441a4a97130cb087ebe28/triggers/manual/paths/invoke?api-version=2016-06-01&sp=/triggers/manual/run&sv=1.0&sig=LX2eGuTosv-wKZinDs7z4TkpNTZ3POLUvMiiXftISOE";
const FLOW_BASE = FLOW_VALIDATE;
const FLOW = FLOW_VALIDATE;

const $=id=>document.getElementById(id);
const ADMIN_PIN = "1992";
function getAdminPin(){ return ADMIN_PIN; }
(() => {
  const pinEl = $("pin");
  if (!pinEl) return;
  pinEl.setAttribute("readonly", "");
  const prevent = (e) => { e.preventDefault(); };
  pinEl.addEventListener("keydown", prevent, { passive: false });
  pinEl.addEventListener("beforeinput", prevent);
  pinEl.addEventListener("input", prevent);
  pinEl.addEventListener("paste", prevent);
  pinEl.addEventListener("click", prevent);
  pinEl.addEventListener("focus", () => pinEl.blur()); // avoid showing software keyboard on iPad
})();

function setKeypadDisabled(disabled){
  const kp = $("keypad");
  const pinInput = $("pin");
  if(!kp || !pinInput) return;
  if(disabled){
    kp.classList.add("disabled");
    pinInput.setAttribute("readonly","");
    $("pinLoading").style.display = "flex";
  }else{
    kp.classList.remove("disabled");
    pinInput.removeAttribute("readonly");
    $("pinLoading").style.display = "none";
  }
}

let audioCtx=null;
function playBeep(freq=600, duration=120, volume=0.2){
  try{
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ try{osc.stop();}catch{} }, duration);
  }catch{}
}

let capturedScans=new Set();
let itemsData=[];
let loggedInUser="";
let uploadTimer=null;
let hasUploadInput=false;
let isUploading=false;
let resolvedItems=[]; // items returned by resolveScans

function dbg(...m){const log=$("debugLog");log.textContent+=m.join(" ")+"\n";log.parentElement.scrollTop=log.parentElement.scrollHeight;}

const CHECK_TYPES_KEY = 'check_types_v1';
function loadCheckTypes(){
  let a = [];
  try{ a = JSON.parse(localStorage.getItem(CHECK_TYPES_KEY)||'[]'); }catch{}
  if(!Array.isArray(a) || !a.length){
    a = ["Date Check","Temperature"]; // defaults
    localStorage.setItem(CHECK_TYPES_KEY, JSON.stringify(a));
  }
  return a;
}
function saveCheckTypes(arr){ localStorage.setItem(CHECK_TYPES_KEY, JSON.stringify(arr)); }
function getCheckTypes(){ return loadCheckTypes(); }

function callFlow(mode,payload={}) {
  return fetch(`${FLOW_BASE}&mode=${mode}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({mode,...payload})
  }).then(r=>r.json());
}
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>{
    p.classList.remove("active");
    p.setAttribute("hidden", "");           // hide everything
  });
  const target = $(id);
  if (target){
    target.classList.add("active");
    target.removeAttribute("hidden");       // only show the active page
  }
  // Show logged-in user badge on pages 2+ only
  if (id !== "page1" && loggedInUser) {
    $("userBadge").textContent = "User: " + loggedInUser;
    $("userBadge").style.display = "block";
  } else {
    $("userBadge").style.display = "none";
  }
  if (id === "page3") { setAuditorPill(); }
}

function setAuditorPill(){
  const pill = document.getElementById("auditorPill");
  if(!pill) return;
  if (loggedInUser){
    pill.textContent = "Auditing: " + loggedInUser;
    pill.style.display = "inline-flex";
  } else {
    pill.style.display = "none";
  }
}

function bindKeypad(selector, onpress){
  const downEvt = window.PointerEvent ? 'pointerdown' : 'mousedown';
  const upEvt = window.PointerEvent ? 'pointerup' : 'mouseup';
  const leaveEvt = window.PointerEvent ? 'pointerleave' : 'mouseleave';
  document.querySelectorAll(selector).forEach(btn=>{
    const downHandler=(e)=>{ e.preventDefault(); btn.classList.add('pressed'); playBeep(); onpress(btn); };
    const upHandler=()=>{ btn.classList.remove('pressed'); };
    const leaveHandler=()=>{ btn.classList.remove('pressed'); };
    btn.addEventListener(downEvt, downHandler, { passive:false });
    btn.addEventListener(upEvt, upHandler);
    btn.addEventListener(leaveEvt, leaveHandler);
  });
}

let pinSubmitting=false;
async function validatePin(pin){
  if(pinSubmitting) return;
  pinSubmitting = true;
  setKeypadDisabled(true);
  $("status").textContent="Checking…";
  const panel = document.querySelector("#pinLoading .panel");
  const pinMsg = document.getElementById("pinMsg");
  if(pinMsg){ pinMsg.textContent = "Checking PIN…"; }
  if(panel){ panel.classList.remove("ok"); }
  if(panel){ panel.dataset.hold = "1"; }
  try{
    const d=await fetch(FLOW_VALIDATE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"validatePin",pin:pin})}).then(r=>r.json());
    if(d.status==="success"){
      loggedInUser = d.user?.Name || "";
      $("status").textContent = "";
      $("welcome").textContent = ""; // no bottom pill for success – use overlay
      if (loggedInUser) { $("userBadge").textContent = "User: " + loggedInUser; }
      if(panel){ panel.classList.add("ok"); }
      if(pinMsg){
        pinMsg.innerHTML = '<div class="pin-welcome">Success</div><div>Welcome, ' + loggedInUser + '</div>';
      }
      // show success state in the same Checking PIN box briefly before navigating
      setTimeout(()=>{
        showPage("page2");
        $("qrCode").innerHTML = "";
        // clear the hold so the overlay can close now
        if(panel){ delete panel.dataset.hold; }
        setKeypadDisabled(false);
      }, 1500);
    } else {
      if(panel){ panel.classList.remove("ok"); }
      if(pinMsg){ 
        pinMsg.textContent = "Invalid PIN";
        pinMsg.classList.add("pin-error");
      }
      $("pin").value="";
      // keep the overlay visible for a moment to display the error, then re-enable keypad
      setTimeout(()=>{
        if(panel){ delete panel.dataset.hold; }
        setKeypadDisabled(false);
        if(pinMsg){ pinMsg.classList.remove("pin-error"); }
      }, 900);
    }
  }catch{
    $("status").textContent="❌ Network error";
  } finally {
    pinSubmitting=false;
    // Only re-enable keypad if we're still on page 1 and not intentionally holding the panel open
    const panelNow = document.querySelector("#pinLoading .panel");
    if(document.querySelector("#page1.active") && !(panelNow && panelNow.dataset.hold)){
      setKeypadDisabled(false);
    }
  }
}

bindKeypad('#keypad .key', (btn)=>{
  if(pinSubmitting) return; // ignore presses while PIN is being checked
  const act=btn.dataset.act;
  if(act==="clear"){ $("pin").value=""; return; }
  if(/^\d$/.test(btn.textContent)){
    if($("pin").value.length<4){
      $("pin").value += btn.textContent;
      if($("pin").value.length===4){ validatePin($("pin").value.trim()); }
    }
  }
});

$("beginBtn").addEventListener("click", ()=>{
  // Instant navigation to page 3
  showPage("page3");
  $("qrCodeAudit").innerHTML="";

  // Fetch items in the background
  callFlow("listItems")
    .then(items=>{ itemsData = Array.isArray(items)? items : []; dbg("Fetched items:", itemsData.length); })
    .catch(err=>{ dbg("Error fetching items:", err); });

  setTimeout(()=>{ showUploadPage(); }, 10000); // 10 seconds
});

$("hiddenScanner3").addEventListener("keydown", e=>{
  if(e.key==="Enter" && e.target.value.trim().toUpperCase()==="DONE"){
    e.target.value="";
    showUploadPage();
  }
});

function showUploadPage(){
  showPage("page4");
  $("uploadQr").style.display = ""; // reset visible until first scan
  $("uploadQr").innerHTML="";
  new QRCode("uploadQr",{text:"^&032&^",width:240,height:240});
  $("visibleBulkInput").value="";
  $("visibleBulkInput").focus();
  capturedScans.clear();
  hasUploadInput=false;
  if(uploadTimer){clearTimeout(uploadTimer); uploadTimer=null;}
}


function switchToCountAnim(){
  const host = $("uploadQr");
  if(!host) return;
  if(!host.querySelector('.count-anim')){
    host.innerHTML = `
      <div class="count-anim">
        <div class="count-outer">
          <div id="countNumber" class="count-number">0</div>
        </div>
        <div id="countLabel" class="count-label">Items captured</div>
      </div>`;
  }
  host.style.display = "";
  updateCountAnim(capturedScans.size);
}
function updateCountAnim(n){
  const el = $("countNumber");
  if(!el) return;
  el.textContent = n;
  el.classList.remove('pop');
  void el.offsetWidth; // restart animation
  el.classList.add('pop');
}

$("visibleBulkInput").addEventListener("input", e=>{
  const val = e.target.value;
  if(/\d{10}/.test(val) || e.data?.includes("\n") || e.inputType==="insertLineBreak"){
    addMany(val);
    e.target.value = ""; // clear for more scans
  }
});
$("visibleBulkInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addMany(e.target.value);
    e.target.value="";
  }
});

function addMany(text){
  const before=capturedScans.size;
  (text.match(/\d{10}/g)||[]).forEach(c=>capturedScans.add(c));
  if(capturedScans.size>before){
    hasUploadInput=true;
    scheduleAutoUpload();
    // Swap QR for animated counter
    switchToCountAnim();
  }
}
function scheduleAutoUpload(){
  if(!hasUploadInput) return;
  if(uploadTimer) clearTimeout(uploadTimer);
  uploadTimer=setTimeout(()=>{ doUpload(); },2000); // keep 2s no-input debounce
}

let _progressTimer=null, _progressStart=0, _progressCircumference=0;
function startProgress(host, durationMs=2000){
  const container = host || $("uploadQr");
  const circle = container?.querySelector('.progress-ring__circle');
  const percentLabel = container?.querySelector('#progressPercent');
  if(!circle || !percentLabel) return;
  const radius = circle.r.baseVal.value;
  _progressCircumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = `${_progressCircumference} ${_progressCircumference}`;
  circle.style.strokeDashoffset = `${_progressCircumference}`;
  _progressStart = performance.now();
  cancelAnimationFrame(_progressTimer);
  const tick = (now)=>{
    const elapsed = now - _progressStart;
    const p = Math.min(1, elapsed / durationMs);
    const offset = _progressCircumference * (1 - p);
    circle.style.strokeDashoffset = `${offset}`;
    percentLabel.textContent = `${Math.round(p*100)}%`;
    if(p < 1){ _progressTimer = requestAnimationFrame(tick); }
  };
  _progressTimer = requestAnimationFrame(tick);
}
function stopProgress(host){
  cancelAnimationFrame(_progressTimer);
  const container = host || $("uploadQr");
  const circle = container?.querySelector('.progress-ring__circle');
  const percentLabel = container?.querySelector('#progressPercent');
  if(circle){ circle.style.strokeDashoffset = 0; }
  if(percentLabel){ percentLabel.textContent = '100%'; }
}
function switchToUploadAnim(message="Uploading…"){
  const host = $("uploadQr");
  if(!host) return;
  host.innerHTML = `
    <div class="count-anim">
      <div class="progress-ring">
        <svg width="120" height="120">
          <circle class="progress-ring__bg" cx="60" cy="60" r="52"></circle>
          <circle class="progress-ring__circle" cx="60" cy="60" r="52"></circle>
        </svg>
        <div class="progress-ring__label" id="progressPercent">0%</div>
      </div>
      <div id="progressText">${message}</div>
    </div>`;
}

async function doUpload(){
  if (isUploading || !capturedScans.size) return;
  isUploading=true;
  switchToUploadAnim("Preparing items…");
  startProgress($("uploadQr"), 2000);

  const payload = {
    SessionID: "SESSION-" + Date.now(),
    ScannedItemIDs: [...capturedScans]
  };

  try{
    const res = await callFlow("resolveScans", payload);
    // Expecting an array of items with: ItemID, ItemName, Room, Checks[{Name,RequiresValue}]
    resolvedItems = Array.isArray(res?.items) ? res.items : [];
  }catch(err){
    dbg("resolveScans error", err);
    alert("Couldn't resolve items from scans.");
    resolvedItems = [];
  }finally{
    stopProgress($("uploadQr"));
    isUploading=false;
  }

  // Move to review page either way
  renderReviewTable();
  showPage("page5");
}

function renderReviewTable(){
  const container = $("reviewTable");
  if(!container) return;

  if(!resolvedItems.length){
    container.innerHTML = '<div class="error-msg">No known items were resolved from the scans.</div>';
    $("submitChecksBtn").disabled = true;
    return;
  }

  // Columns come from Admin-managed check types
  const columns = getCheckTypes();

  // Build table header
  let html = '<table class="table"><thead><tr>'+
    '<th class="item-col">Item</th>'+
    '<th class="room-col">Room</th>'+
    columns.map(n => `<th>${n}</th>`).join("")+
    '</tr></thead><tbody>';

  // Build each row
  resolvedItems.forEach((item, i)=>{
    const checks = Array.isArray(item.Checks) ? item.Checks : [];
    const hasByName = Object.fromEntries(checks.map(c => [String(c.Name || ""), c]));

    html += `<tr>`+
      `<td class="item-col">${item.ItemName || item.ItemID}</td>`+
      `<td class="room-col">${item.Room || ""}</td>`;

    columns.forEach(name=>{
      html += `<td><div class="chk-cell">
        <input type="checkbox" class="rev-chk" data-i="${i}" data-name="${name}">
      </div></td>`;
    });


    html += `</tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // --- Temperature panel logic ---
  function updateTempSection(){
    const tempRows = [];
    container.querySelectorAll('.rev-chk').forEach(chk=>{
      if(chk.checked && String(chk.dataset.name||"").toLowerCase()==="temperature"){
        const idx = Number(chk.dataset.i);
        const it = resolvedItems[idx] || {};
        tempRows.push({i: idx, item: it});
      }
    });
    const wrap = $("tempSection");
    const rowsHost = $("tempRows");
    if(!wrap || !rowsHost) return;
    if(!tempRows.length){ wrap.style.display = "none"; rowsHost.innerHTML = ""; return; }
    wrap.style.display = "block";
    rowsHost.innerHTML = tempRows.map(r => `
      <div class="temp-row" data-i="${r.i}">
        <div class="label">${r.item.ItemName || r.item.ItemID}</div>
        <div class="label">${r.item.Room || ""}</div>
        <input class="temp-input" type="text" maxlength="2" inputmode="numeric" pattern="\\d{1,2}" placeholder=".." data-i="${r.i}">
      </div>
    `).join("");
    validateSubmit();
  }

  function validateSubmit(){
    const totalRows = resolvedItems.length;
    const rowHasChoice = new Array(totalRows).fill(false);
    let tempsOk = true;

    // mark rows that have at least one selection
    container.querySelectorAll('.rev-chk').forEach(chk=>{
      if(chk.checked){
        const idx = Number(chk.dataset.i);
        if(!isNaN(idx)) rowHasChoice[idx] = true;
      }
    });

    // validate any temperature inputs present (only appear when ticked)
    const tempInputsHost = $("tempRows");
    if(tempInputsHost){
      tempInputsHost.querySelectorAll('.temp-input').forEach(inp=>{
        const v = (inp.value||'').trim();
        if(!/^[0-9]{1,2}$/.test(v)) tempsOk = false;
      });
    }

    const allRowsSatisfied = rowHasChoice.every(Boolean);
    $("submitChecksBtn").disabled = !(allRowsSatisfied && tempsOk);
  }

  container.querySelectorAll('.rev-chk').forEach(el=>{
    el.addEventListener('change', ()=>{
      if(String(el.dataset.name||"").toLowerCase()==="temperature"){ updateTempSection(); }
      validateSubmit();
    });
  });
  const tempHost = $("tempRows");
  if(tempHost){
    tempHost.addEventListener('input', (e)=>{
      if(e.target && e.target.classList.contains('temp-input')) validateSubmit();
    });
  }
  // Initial state
  $("tempSection").style.display = "none";
  $("tempRows").innerHTML = "";
  $("submitChecksBtn").disabled = true;
}

function buildSubmission(){
  const rows = [];
  const sessionComment = ($("sessionComment")?.value || "").trim();
  const table = $("reviewTable");
  if(!table) return rows;

  // For every checked box, create a row (Temperature value comes from panel)
  table.querySelectorAll('.rev-chk:checked').forEach(chk=>{
    const i = Number(chk.dataset.i);
    const name = String(chk.dataset.name || "");
    const item = resolvedItems[i] || {};

    let value = "Done";
    if(name.toLowerCase()==="temperature"){
      const valEl = $("tempRows") ? $("tempRows").querySelector(`.temp-input[data-i="${i}"]`) : null;
      value = (valEl?.value || "").trim();
    }

    rows.push({
      ItemID: String(item.ItemID || ""),
      ItemName: item.ItemName || "",
      Room: item.Room || "",
      CheckType: name,
      CheckValue: value || "Done",
      Comment: sessionComment
    });
  });

  return rows;
}

let _returnTimer = null;
function goHomeReset(){
  // clear temperature panel and comment
  const ts = $("tempSection"); if(ts){ ts.style.display="none"; }
  const tr = $("tempRows"); if(tr){ tr.innerHTML=""; }
  const sc = $("sessionComment"); if(sc){ sc.value = ""; }
  // clear review + state
  $("reviewTable").innerHTML = "";
  $("submitMsg").innerHTML = "";
  $("submitChecksBtn").disabled = true;
  capturedScans.clear();
  itemsData = [];
  resolvedItems = [];
  // reset login visuals on page 1
  $("pin").value = "";
  $("status").textContent = "";
  $("welcome").textContent = "";
  $("userBadge").style.display = "none";
  loggedInUser = ""; // re-set on next successful PIN
  // cancel any timers
  if(_returnTimer){ clearInterval(_returnTimer); _returnTimer=null; }
  showPage("page1");
}
function showFinalResetPage(){
  showPage("page7");
  // build QR only once per visit
  const host = $("resetQr");
  if(host){ host.innerHTML=""; new QRCode("resetQr",{text:"^&030&^",width:240,height:240}); }
  // start a gentle countdown, user can also return immediately
  const countdownEl = $("returnCountdown");
  let secs = 20;
  if(countdownEl){ countdownEl.textContent = `Returning to start in ${secs}s…`; }
  if(_returnTimer){ clearInterval(_returnTimer); }
  _returnTimer = setInterval(()=>{
    secs -= 1;
    if(secs <= 0){
      clearInterval(_returnTimer); _returnTimer=null;
      goHomeReset();
    }else{
      if(countdownEl){ countdownEl.textContent = `Returning to start in ${secs}s…`; }
    }
  },1000);
  // button handler
  $("returnNowBtn")?.addEventListener("click", ()=>{ goHomeReset(); }, { once:true });
}

$("submitChecksBtn").addEventListener("click", async ()=>{
  const rows = buildSubmission();
  if(!rows.length){ return; }
  $("submitChecksBtn").disabled = true;
  $("submitMsg").textContent = "Submitting…";
  try{
    const payload = {
      SessionID: "SESSION-" + Date.now(),
      StaffName: loggedInUser || 'PIN User',
      SubmittedAt: new Date().toISOString(),
      Rows: rows
    };
    const res = await callFlow('submitChecks', payload);
    if(res && res.status === 'success'){
      // Show the "All set" animation briefly, then move to the final reset step (Page 7)
      showPage("page6");
      setTimeout(()=>{ showFinalResetPage(); }, 1400);
    }else{
      $("submitMsg").innerHTML = `<div class="error-msg">Submission failed.</div>`;
      $("submitChecksBtn").disabled = false;
    }
  }catch(e){
    $("submitMsg").innerHTML = `<div class="error-msg">Submission error.</div>`;
    $("submitChecksBtn").disabled = false;
  }
});

setInterval(()=>{
  ["hiddenScanner3","visibleBulkInput"].forEach(id=>{
    $(id)?.focus();
  });
},500);

const admin = {
  open(){
    $("adminMsg").textContent="";
    $("adminUserName").value="";
    $("adminUserPin").value="";
    $("adminMenu").style.display="block";
    $("adminAddUserForm").style.display="none";
    $("adminChecksForm").style.display="none";
    $("adminModal").style.display="flex";
  },
  close(){ $("adminModal").style.display="none"; },
  showAddUser(){
    $("adminMenu").style.display="none";
    $("adminAddUserForm").style.display="block";
    $("adminUserName").focus();
  }
};

$("adminBtn")?.addEventListener("click", ()=> openAdminPinModal());
$("adminClose")?.addEventListener("click", ()=> admin.close());
$("openAddUser")?.addEventListener("click", ()=> admin.showAddUser());
$("openManageChecks")?.addEventListener("click", ()=> showChecksManager());

$("adminSubmit")?.addEventListener("click", async ()=>{
  const name = ($("adminUserName").value || "").trim();
  const pin  = ($("adminUserPin").value || "").trim();

  if(!name){
    $("adminMsg").textContent = "Please enter a name.";
    return;
  }
  if(pin && (!/^[0-9]{4}$/.test(pin))){
    $("adminMsg").textContent = "PIN must be 4 digits (or leave blank).";
    return;
  }

  $("adminMsg").textContent = "Saving…";

  try{
    const res = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "addUser", Name: name, Pin: pin })
    });
    const data = await res.json();

    if(data && data.status === "success"){
      // Close admin modal first so overlay is visible (overlay has lower z-index)
      admin.close();

      // Show the same success overlay as PIN login
      const overlay = $("pinLoading");
      const panel   = overlay?.querySelector(".panel");
      const msgEl   = $("pinMsg");
      if(panel){ panel.classList.add("ok"); panel.dataset.hold = "1"; }
      if(msgEl){
        msgEl.classList.remove("pin-error");
        msgEl.innerHTML = '<div class="pin-welcome">Success</div><div>User added</div>';
      }
      overlay.style.display = "flex";

      setTimeout(()=>{
        if(panel){ panel.classList.remove("ok"); delete panel.dataset.hold; }
        overlay.style.display = "none";
        $("adminMsg").textContent = "";
      }, 1500);
    }else if(data && data.message){
      $("adminMsg").textContent = "❌ " + data.message;
    }else{
      $("adminMsg").textContent = "❌ Error adding user";
    }
  }catch(e){
    $("adminMsg").textContent = "Network error";
  }
});

$("plusBtn").onclick = async () => {
  $("modalMsg").textContent = "";
  $("pin1").value = $("pin2").value = "";
  $("userSel").innerHTML = "<option>Loading…</option>";
  $("modal").style.display = "flex";

  window._modalActive = "pin1";
  $("pin1").focus();

  try {
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "getUsersWithoutPins" })
    });
    const d = await r.json();
    $("userSel").innerHTML = d.status === "success"
      ? d.users.map(u => `<option>${u.Name}</option>`).join("")
      : "<option>❌ Couldn't load users</option>";
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};

$("cancel").onclick = () => $("modal").style.display = "none";

["pin1","pin2"].forEach(id=>{
  $(id).addEventListener("keydown", e=> e.preventDefault());
  $(id).addEventListener("input", e=> e.preventDefault());
  $(id).addEventListener("click", ()=> window._modalActive = id);
});
bindKeypad('#modalKeypad .key', (btn)=>{
  const targetId = window._modalActive || 'pin1';
  const el = $(targetId);
  const act = btn.dataset.act;
  if (!el) return;
  if (act === 'clear') { el.value = ''; return; }
  if (act === 'del') { el.value = el.value.slice(0,-1); return; }
  if (el.value.length < 4 && /^\d$/.test(btn.textContent)) {
    el.value += btn.textContent;
  }
});

$("save").onclick = async () => {
  const name = $("userSel").value;
  const p1 = $("pin1").value.trim(), p2 = $("pin2").value.trim();
  if (p1 !== p2 || p1.length !== 4 || isNaN(p1)) {
    $("modalMsg").textContent = "Pins must match & be 4 digits";
    return;
  }
  $("modalMsg").textContent = "Checking…";
  try {
    const chk = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "validatePin", pin: p1 })
    });
    const chkData = await chk.json();
    if (chkData && chkData.status === "success") {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
      return;
    }
    $("modalMsg").textContent = "Saving…";
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "addPin", name, pin: p1 })
    });
    const d = await r.json();
    const taken =
      (d && d.error === "PinAlreadyExists") ||
      (d && d.message && /already\s*(taken|exists)/i.test(String(d.message)));
    if (d && d.status === "success") {
      $("modalMsg").textContent = "✅ Saved";
      setTimeout(() => { $("modal").style.display = "none"; }, 1000);
    } else if (taken || r.status === 409) {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
    } else {
      $("modalMsg").textContent = "❌ Error";
    }
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};
</script>

<script>

// --- Admin: Check Types sync with Flow ---
async function fetchCheckTypesFromFlow(){
  try{
    const msgEl = $("adminMsg");
    if(msgEl) msgEl.textContent = "Loading…";
    const res = await callFlow("getCheckTypes", {});
    let types = [];
    if(Array.isArray(res))                types = res;                     // bare array
    else if(Array.isArray(res?.CheckTypes)) types = res.CheckTypes;       // { CheckTypes: [...] }
    else if(Array.isArray(res?.checkTypes)) types = res.checkTypes;       // { checkTypes: [...] }
    else if(Array.isArray(res?.result))     types = res.result;            // { result: [...] }
    types = (types||[]).map(x=>String(x).trim()).filter(Boolean);
    if(types.length){ saveCheckTypes(types); }
    renderCheckTypeList();
    if(msgEl) msgEl.textContent = "";
  }catch(e){
    const msgEl = $("adminMsg");
    if(msgEl) msgEl.textContent = "Couldn't load from server. Showing local list.";
    renderCheckTypeList();
  }
}

function renderAdminDots(len){
  const dots = document.querySelectorAll('#adminPinDots .pin-dot');
  dots.forEach((d,i)=> d.classList.toggle('filled', i < len));
}
function openAdminPinModal(){
  const msg = $("adminPinMsg");
  if(msg) msg.textContent = "";
  const input = $("adminPinInput");
  if(input) input.value = "";
  renderAdminDots(0);
  $("adminPinModal").style.display = "flex";
}
function closeAdminPinModal(){
  $("adminPinModal").style.display = "none";
}
$("adminPinClose")?.addEventListener("click", ()=> closeAdminPinModal());
(()=>{
  const el = $("adminPinInput");
  if(!el) return;
  const prevent = (e)=>e.preventDefault();
  el.addEventListener("keydown", prevent, {passive:false});
  el.addEventListener("beforeinput", prevent);
  el.addEventListener("input", prevent);
  el.addEventListener("paste", prevent);
  el.addEventListener("click", prevent);
})();

function wrongPinFeedback(){
  const box = $("adminPinBox");
  if(!box) return;
  box.classList.remove("shake");
  // force reflow to restart animation
  void box.offsetWidth;
  box.classList.add("shake");
  const msg = $("adminPinMsg");
  if(msg) msg.textContent = "❌ Incorrect PIN";
}

bindKeypad('#adminPinKeypad .key', (btn)=>{
  const el = $("adminPinInput"); if(!el) return;
  const act = btn.dataset.act;
  if (act === 'clear'){ el.value = ''; renderAdminDots(0); return; }
  if (act === 'del'){ el.value = el.value.slice(0,-1); renderAdminDots(el.value.length); return; }
  if (/^\d$/.test(btn.textContent) && el.value.length < 4){
    el.value += btn.textContent;
    renderAdminDots(el.value.length);
    if (el.value.length === 4){
      if (el.value === getAdminPin()){
        closeAdminPinModal();
        admin.open();
      }else{
        // wrong PIN: shake + clear after a short delay
        wrongPinFeedback();
        setTimeout(()=>{ el.value=''; renderAdminDots(0); }, 350);
      }
    }
  }
});

// Async version: fetches from Flow, then shows UI
async function showChecksManager(){
  $("adminMsg").textContent = "Loading…";
  $("adminMenu").style.display = "none";
  $("adminAddUserForm").style.display = "none";
  $("adminChecksForm").style.display = "block";
  await fetchCheckTypesFromFlow(); // pulls from Flow, updates local cache, renders list
  $("adminMsg").textContent = "";
}
function renderCheckTypeList(){
  const host = $("checkTypeList"); if(!host) return;
  const types = getCheckTypes();
  host.innerHTML = types.map((t,idx)=>
    `<div class="checktype-row" data-i="${idx}">
      <div class="checktype-name">${t}</div>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" data-act="edit" aria-label="Edit">✏️</button>
        <button class="icon-btn danger" data-act="del" aria-label="Delete">✖️</button>
      </div>
    </div>`
  ).join("");
}
$("addCheckTypeBtn")?.addEventListener("click", ()=>{
  const inp = $("newCheckTypeInput"); if(!inp) return;
  const name = (inp.value||"").trim();
  if(!name) return;
  const types = getCheckTypes();
  if(types.some(x=> x.toLowerCase()===name.toLowerCase())){ $("adminMsg").textContent = "That check type already exists."; return; }
  types.push(name);
  saveCheckTypes(types);
  inp.value = "";
  renderCheckTypeList();
  if(document.querySelector('#page5.active')){ renderReviewTable(); }
});
$("checkTypeList")?.addEventListener("click", (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const row = e.target.closest('.checktype-row'); if(!row) return;
  const idx = Number(row.dataset.i);
  const types = getCheckTypes();
  if(btn.dataset.act === 'del'){
    const name = types[idx];
    if(confirm(`Delete "${name}"?`)){
      types.splice(idx,1);
      saveCheckTypes(types);
      renderCheckTypeList();
      if(document.querySelector('#page5.active')){ renderReviewTable(); }
    }
  }else if(btn.dataset.act === 'edit'){
    const current = types[idx];
    const next = prompt('Rename check type:', current);
    if(next && next.trim()){
      const clean = next.trim();
      if(types.some((x,i)=> i!==idx && x.toLowerCase()===clean.toLowerCase())){
        $("adminMsg").textContent = "Name already exists.";
        return;
      }
      types[idx] = clean;
      saveCheckTypes(types);
      renderCheckTypeList();
      if(document.querySelector('#page5.active')){ renderReviewTable(); }
    }
  }
});

// Save Check Types to Flow
$("saveCheckTypesBtn")?.addEventListener("click", async ()=>{
  const types = getCheckTypes();
  $("adminMsg").textContent = "Saving…";
  try{
    const res = await callFlow("saveCheckTypes", { CheckTypes: types });
    if(res && (res.status === "success" || res.ok === true)){
      $("adminMsg").textContent = "✅ Saved";
    }else{
      $("adminMsg").textContent = "❌ Save failed";
    }
  }catch(e){
    $("adminMsg").textContent = "Network error";
  }
});
</script>

</body>
</html>