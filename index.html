<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC - PIN Portal (Supabase, fixed-login-persistence)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root { --bg:#0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed; --accent:#22c55e; --danger:#ef4444; --card:#111317; --line:#272a30; --btn:#2a2f36; }
    * { box-sizing:border-box; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .panel { width:min(520px,95vw); background:var(--panel); border-radius:20px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1,h2,h3 { margin:0 0 12px; }
    .muted { color:var(--muted); font-size:14px; }
    .center { text-align:center; }
    .hidden { display:none !important; }
    .btn { display:inline-flex; justify-content:center; align-items:center; padding:12px 16px; border-radius:12px; background:var(--btn); border:1px solid var(--line); color:var(--text); cursor:pointer; }
    .btn:active { transform:translateY(1px); }
    .btn.primary { background:var(--accent); border-color:transparent; color:#04130a; font-weight:600; }
    .btn.danger { background:var(--danger); border-color:transparent; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; width:min(360px,92%); margin:8px auto 0; }
    .pad { margin-top:14px; }
    .key { height:64px; padding:0; border-radius:12px; background:#2f3339; text-align:center; font-weight:700; font-size:26px; border:1px solid #3a3f46; box-shadow: inset 0 2px 0 rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; }
    .key:active { transform:scale(.98); }
    .pin-dots { display:flex; gap:8px; justify-content:center; margin:10px 0 6px; }
    .dot { width:14px; height:14px; border-radius:50%; background:#30363f; }
    .dot.filled { background:var(--accent); box-shadow:0 0 8px var(--accent), 0 0 16px rgba(34,197,94,.6); }
    .row { display:flex; gap:10px; }
    input[type=text], input[type=password] { background:#0f1216; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px; width:100%; }
    .topbar { position:fixed; left:0; right:0; top:0; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(to bottom, rgba(0,0,0,.5), transparent); }
    .pill { padding:6px 10px; background:#1e232b; border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:#0f1216; border:1px solid var(--line); padding:10px 14px; border-radius:10px; color:#fff; }
    .footer { position:fixed; bottom:10px; left:0; right:0; text-align:center; color:var(--muted); }
    /* simple debug console */
    #debugBox { position:fixed; right:8px; bottom:8px; width:min(420px, 42vw); height:140px; background:#0b0d10; color:#cbd5e1; border:1px solid #263041; border-radius:10px; padding:8px; overflow:auto; font:12px ui-monospace,SFMono-Regular,Menlo,monospace; white-space:pre-wrap; }
    #debugBox h4{ margin:4px 0 8px; font:600 12px/1.2 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="pill" id="status">Not signed in</div>
    <div class="row">
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap" id="screen-login">
    <div class="panel center">
      <h1>Staff Portal</h1>
      <p class="muted">Sign in (one-time) with your email & password. Then staff use a 4‑digit PIN.</p>
      <div class="pad"><input id="loginEmail" type="text" placeholder="email@example.com" autocomplete="username"></div>
      <div class="pad"><input id="loginPass" type="password" placeholder="Password" autocomplete="current-password"></div>
      <div class="pad"><button class="btn primary" id="doLogin">Sign in</button></div>
      <p id="loginMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-pin">
    <div class="panel center">
      <h2>Enter 4 digit PIN</h2>
      <div class="pin-dots"><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div></div>
      <div class="grid pad" id="pad">
        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
        <div class="key" style="grid-column:2">0</div>
      </div>
      <div class="pad"><button class="btn" id="btnClearPin">Clear</button></div>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div class="wrap hidden" id="screen-begin">
    <div class="panel center">
      <h2>Press the circle button on the scanner once and wait for 2 beeps</h2>
      <p class="muted">After 2 beeps, click the BEGIN button below</p>
      <div class="pad"><button class="btn primary" id="btnBegin">Begin</button></div>
    </div>
  </div>

  <div class="wrap hidden" id="screen-review">
    <div class="panel center">
      <h2>Review & Submit</h2>
      <div class="pad"><button class="btn primary" id="btnSubmit">Submit</button></div>
      <p id="submitMsg" class="muted"></p>
    </div>
  </div>

  <div class="footer">User: <span id="footerWho">—</span></div>
  <div id="toast" class="toast hidden"></div>

  <div id="debugBox"><h4>Debug</h4></div>

  <script>
    // ---- Debug helpers ----
    function dbg(msg){
      const b = document.getElementById('debugBox');
      const t = new Date().toLocaleTimeString();
      if(b){ b.innerHTML += "\\n[" + t + "] " + msg; b.scrollTop = b.scrollHeight; }
      console.log(msg);
    }
    window.addEventListener('error', e=> dbg('Window error: ' + (e?.message||e?.error||'unknown')));
    window.addEventListener('unhandledrejection', e=> dbg('Unhandled promise: ' + (e?.reason?.message||e?.reason||'unknown')));

    // ---- Supabase client (explicit localStorage persistence) ----
    const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage
      }
    });
    dbg('Storage in use: ' + (sb?.auth?.storage === window.localStorage ? 'localStorage' : 'custom'));

    // ---- State ----
    const S = { siteId: null, user: null, staff: null, scans: [] };

    // ---- UI helpers ----
    const $ = (id)=> document.getElementById(id);
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1600); }
    function show(id){
      ['screen-login','screen-pin','screen-begin','screen-review'].forEach(x=> $(x).classList.add('hidden'));
      $(id).classList.remove('hidden');
    }
    function pinDots(n){ for(let i=1;i<=4;i++){ const d=$('d'+i); if(!d) continue; d.classList.toggle('filled', i<=n); } }

    // ---- Auth state listener (extra safety) ----
    sb.auth.onAuthStateChange((event, session)=>{
      dbg('Auth event: ' + event);
      if(event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED'){ init(); }
      if(event === 'SIGNED_OUT'){ $('status').textContent = 'Not signed in'; show('screen-login'); }
    });

    // ---- Boot ----
    async function init(){
      const { data:{ session } } = await sb.auth.getSession();
      dbg('init(): session present? ' + !!session);
      if(!session){ $('status').textContent = 'Not signed in'; show('screen-login'); return; }
      S.user = session.user;
      $('status').textContent = session.user.email;
      // Try to fetch profile for site_id; if it fails, continue with a default site 1 (old code worked like this)
      try{
        const { data: prof, error } = await sb.from('profiles').select('site_id, full_name, role').eq('user_id', session.user.id).limit(1);
        if(error){ dbg('profiles error: ' + error.message); }
        S.siteId = prof?.[0]?.site_id ?? 1;
      }catch(e){ dbg('profiles fetch threw: ' + (e?.message||e)); S.siteId = 1; }
      $('footerWho').textContent = session.user.email + ' • Site ' + S.siteId;
      show('screen-pin');
    }

    // ---- Login button ----
    $('doLogin').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      const password = $('loginPass').value;
      if(!email || !password){ $('loginMsg').textContent = 'Enter email and password'; return; }
      $('loginMsg').textContent = 'Signing in…';
      dbg('signInWithPassword()');
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ $('loginMsg').textContent = error.message; dbg('signIn error: ' + error.message); return; }
      $('loginMsg').textContent = '';
      await init();
    });

    // ---- Logout / Exit ----
    $('btnLogout').addEventListener('click', async ()=>{
      if(confirm('Sign out?')){
        await sb.auth.signOut(); // no pre-login local sign-out
        S.user = null; S.staff = null; S.scans = [];
        $('footerWho').textContent = '—';
        show('screen-login');
      }
    });

    // ---- PIN keypad (minimal) ----
    let pin = '';
    $('pad').addEventListener('click', async (e)=>{
      const k = e.target.closest('.key'); if(!k) return;
      const v = k.textContent.trim();
      if(/^\d$/.test(v)){ if(pin.length<4) pin+=v; pinDots(pin.length); }
      if(pin.length===4){ await tryPin(pin); }
    });
    $('btnClearPin').addEventListener('click', ()=>{ pin=''; pinDots(0); });

    async function tryPin(p){
      $('pinMsg').textContent = 'Checking…';
      try{
        const { data, error } = await sb.from('kiosk_users').select('id, full_name, role').eq('site_id', S.siteId).eq('pin', p).limit(1);
        if(error){ $('pinMsg').textContent = error.message; pin=''; pinDots(0); return; }
        if(!data || !data.length){ $('pinMsg').textContent = 'Invalid PIN'; pin=''; pinDots(0); return; }
        S.staff = { name:data[0].full_name, role:data[0].role||'staff' };
        $('pinMsg').textContent=''; pin=''; pinDots(0);
        show('screen-begin');
      }catch(e){ $('pinMsg').textContent = e?.message||String(e); pin=''; pinDots(0); }
    }

    // ---- Begin / Submit (placeholder) ----
    $('btnBegin').addEventListener('click', ()=> show('screen-review'));
    $('btnSubmit').addEventListener('click', ()=>{ $('submitMsg').textContent = 'Submitted!'; toast('Submission uploaded'); });

    // First run
    init();
  </script>
</body>
</html>
