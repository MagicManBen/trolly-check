<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CQC – PIN Portal (DEBUG BUILD)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* ---------- core look & feel ---------- */
body{margin:0;background:#141314;color:#fff;font-family:Arial,sans-serif;text-align:center;padding:40px}
h1,h2{margin:0 0 20px}
input,button,select,textarea{font-size:1rem;padding:10px;border:none;border-radius:6px}
input[type=password],input[type=text]{background:#111;color:#fff;letter-spacing:8px;width:160px;text-align:center}
button{cursor:pointer;background:#1e8c1e;color:#fff}
#status{margin-top:15px;font-weight:bold}
#welcome{margin-top:10px;font-size:1.2rem;color:#1e8c1e}

/* keypad */
#keypad{margin:25px auto 10px;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#keypad .key{background:#333;color:#fff;border-radius:8px;font-size:1.3rem;padding:16px 0;user-select:none;transition:transform .05s ease, background .05s ease}
#keypad .wide{grid-column:span 3}
#keypad .zero{grid-column:2}

/* pressed visual */
.key.pressed{background:#1e8c1e;color:#fff;transform:scale(0.96)}

/* hide scanner inputs but keep them usable */
.scanner{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
#visibleBulkInput{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}

/* debug panel (button removed) */
#debug{position:fixed;bottom:80px;left:20px;width:300px;max-height:50vh;overflow:auto;background:#111;padding:10px;border:1px solid #555;border-radius:8px;font-family:Consolas,monospace;font-size:.75rem;display:none}
#debug pre{margin:0;white-space:pre-wrap}

/* pages */
.page{display:none}
.active{display:block}

#qrCodeWrapper,#auditMsgWrapper,#doneScreen,#outputPage{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh}

/* upload page elements */
@keyframes glowEdge{from{box-shadow:0 0 6px #1e8c1e}to{box-shadow:0 0 20px #1e8c1e}}
.scanning{animation:glowEdge .5s ease-in-out infinite alternate;border:2px solid #1e8c1e!important}
#progressAnim{display:none;flex-direction:column;align-items:center;margin-top:20px}
.spinner{width:80px;height:80px;border:10px solid #1e8c1e;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#uploadText{margin-top:12px;font-size:1.2rem;color:#1e8c1e;font-weight:bold}
/* progress ring */
.progress-ring{position:relative;width:120px;height:120px}
.progress-ring svg{transform:rotate(-90deg)}
.progress-ring__bg{stroke:#333;stroke-width:10;fill:none}
.progress-ring__circle{stroke:#1e8c1e;stroke-width:10;fill:none;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.progress-ring__label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:bold}
#progressText{margin-top:14px;font-size:1.4rem;color:#fff;font-weight:bold}

/* results table */
#resultTable{width:90%;max-width:600px;color:#000;background:#fff;border-radius:6px;overflow:auto;font-family:Arial,sans-serif;font-size:.9rem;padding:10px}

/* + button & modal styles */
button.danger{background:#b30000}
#plusBtn{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;font-size:28px;padding:6px 0}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center}
#box{background:#222;padding:20px;border-radius:8px;width:90%;max-width:380px}
#box select,#box input{width:100%;margin:6px 0}

/* modal keypad */
#modalKeypad{margin:10px auto;display:grid;grid-template-columns:repeat(3,80px);gap:10px;justify-content:center}
#modalKeypad .key{background:#333;color:#fff;border-radius:8px;font-size:1.3rem;padding:16px 0;user-select:none;transition:transform .05s ease, background .05s ease}

/* user badge — bottom center */
.user-badge{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);color:#aaa;background:transparent;padding:0;border-radius:0;font-size:.95rem;opacity:1;z-index:9999;display:none}

/* page 2 spacing */
#qrCodeWrapper{gap:28px}
#clickText{margin-top:28px}
#qrImage{width:360px;max-width:90vw;height:auto;border-radius:6px}
#wristImage{width:360px;max-width:90vw;height:auto;border-radius:6px;margin-top:12px}
#scanTrollyImage{width:320px;max-width:90vw;height:auto;border-radius:6px;margin:10px 0 14px}
</style>
</head>
<body>

<!-- Page 1 – PIN -->
<div id="page1" class="page active">
  <h1>Enter 4-Digit PIN</h1>
  <input id="pin" type="password" maxlength="4" placeholder="****">
  <div id="keypad">
    <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
    <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
    <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
    <button class="key zero" type="button">0</button>
    <button class="key wide" data-act="clear" type="button">Clear</button>
  </div>
  <div id="status"></div><div id="welcome"></div>
</div>

<!-- Page 2 – BEGIN -->
<div id="page2" class="page">
  <div id="qrCodeWrapper">
    <div id="qrTitle">Press the button on scanner once</div>
    <img id="qrImage" src="DoubleDeep.png" alt="Press the button on scanner once" />
    <img id="wristImage" src="WristBand.png" alt="Wrist band instructions" />
    <div id="clickText">After 2 beeps, click here to begin</div>
    <button id="beginBtn" type="button" style="margin-top:8px">Begin</button>
  </div>
</div>

<!-- Page 3 – Audit -->
<div id="page3" class="page">
  <div id="auditMsgWrapper">
    <h2 id="auditMsg">Audit in progress</h2>
    <img id="scanTrollyImage" src="ScanTrolly.png" alt="Scan trolly" />
    <div id="auditVisual" class="spinner" style="border-top-color:#0000"></div>
    <div id="qrCodeAudit" style="margin-top:20px;"></div>
  </div>
  <input id="hiddenScanner3" class="scanner" type="text" autocomplete="off">
</div>

<!-- Page 4 – Upload -->
<div id="page4" class="page">
  <div id="doneScreen">
    <h2>Scan here to upload:</h2>
    <div id="uploadQr"></div>
    <input id="visibleBulkInput" autocomplete="off">
    <div id="scanCount">No scans captured yet.</div>
    <div id="progressAnim">
      <div class="progress-ring">
        <svg width="120" height="120">
          <circle class="progress-ring__bg" cx="60" cy="60" r="52"></circle>
          <circle class="progress-ring__circle" cx="60" cy="60" r="52"></circle>
        </svg>
        <div class="progress-ring__label" id="progressPercent">0%</div>
      </div>
      <div id="progressText">Uploading…</div>
    </div>
  </div>
</div>

<!-- Page 5 – Results -->
<div id="page5" class="page">
  <div id="outputPage">
    <h2>Scanned Items</h2>
    <div id="resultTable"></div>
  </div>
</div>

<!-- + button & modal -->
<button id="plusBtn" type="button">+</button>
<div id="modal">
  <div id="box">
    <h2>Create PIN</h2>
    <select id="userSel"></select>
    <input id="pin1" type="password" maxlength="4" placeholder="New PIN" readonly />
    <input id="pin2" type="password" maxlength="4" placeholder="Confirm PIN" readonly />
    <div id="modalKeypad">
      <button class="key" type="button">1</button><button class="key" type="button">2</button><button class="key" type="button">3</button>
      <button class="key" type="button">4</button><button class="key" type="button">5</button><button class="key" type="button">6</button>
      <button class="key" type="button">7</button><button class="key" type="button">8</button><button class="key" type="button">9</button>
      <button class="key wide" data-act="clear" type="button">C</button>
      <button class="key" type="button">0</button><button class="key wide" data-act="del" type="button">←</button>
    </div>
    <button id="save" type="button">Save PIN</button>
    <button class="danger" id="cancel" type="button">Cancel</button>
    <div id="modalMsg"></div>
  </div>
</div>

<!-- User badge -->
<div id="userBadge" class="user-badge"></div>

<!-- Debug -->
<div id="debug"><pre id="debugLog"></pre></div>

<script>
/* ---------- constants ---------- */
const FLOW_VALIDATE = "https://prod-89.westeurope.logic.azure.com:443/workflows/f1639be7e1a441a4a97130cb087ebe28/triggers/manual/paths/invoke?api-version=2016-06-01&sp=/triggers/manual/run&sv=1.0&sig=LX2eGuTosv-wKZinDs7z4TkpNTZ3POLUvMiiXftISOE";
const FLOW_BASE = FLOW_VALIDATE;
const FLOW = FLOW_VALIDATE;

const $=id=>document.getElementById(id);

// --- audio helpers ---
let audioCtx=null;
function playBeep(freq=600, duration=120, volume=0.2){
  try{
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ try{osc.stop();}catch{} }, duration);
  }catch{}
}
function playDoubleBeep(){
  playBeep(800,120,0.25);
  setTimeout(()=>playBeep(1000,120,0.25), 220);
}

/* ---------- state ---------- */
let capturedScans=new Set();
let itemsData=[];
let loggedInUser="";
let uploadTimer=null;
let hasUploadInput=false;
let isUploading=false;

/* ---------- debug ---------- */
function dbg(...m){const log=$("debugLog");log.textContent+=m.join(" ")+"\n";log.parentElement.scrollTop=log.parentElement.scrollHeight;}

/* ---------- helpers ---------- */
function callFlow(mode,payload={}) {
  return fetch(`${FLOW_BASE}&mode=${mode}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({mode,...payload})
  }).then(r=>r.json());
}
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  $(id).classList.add("active");
  // Show logged-in user badge on pages 2+ only
  if (id !== "page1" && loggedInUser) {
    $("userBadge").textContent = "User: " + loggedInUser;
    $("userBadge").style.display = "block";
  } else {
    $("userBadge").style.display = "none";
  }
  // Show green + button only on Page 1
  const plus = $("plusBtn");
  if(plus){ plus.style.display = (id === "page1") ? "inline-block" : "none"; }
}

// ----- Keypad binder -----
function bindKeypad(selector, onpress){
  const downEvt = window.PointerEvent ? 'pointerdown' : 'mousedown';
  const upEvt = window.PointerEvent ? 'pointerup' : 'mouseup';
  const leaveEvt = window.PointerEvent ? 'pointerleave' : 'mouseleave';
  document.querySelectorAll(selector).forEach(btn=>{
    const downHandler=(e)=>{ e.preventDefault(); btn.classList.add('pressed'); playBeep(); onpress(btn); };
    const upHandler=()=>{ btn.classList.remove('pressed'); };
    const leaveHandler=()=>{ btn.classList.remove('pressed'); };
    btn.addEventListener(downEvt, downHandler, { passive:false });
    btn.addEventListener(upEvt, upHandler);
    btn.addEventListener(leaveEvt, leaveHandler);
  });
}

let pinSubmitting=false;
async function validatePin(pin){
  if(pinSubmitting) return; pinSubmitting=true;
  $("status").textContent="Checking…";
  try{
    const d=await fetch(FLOW_VALIDATE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"validatePin",pin:pin})}).then(r=>r.json());
    if(d.status==="success"){
      loggedInUser = d.user?.Name || "";
      $("status").textContent="✅";
      $("welcome").textContent= loggedInUser ? "Welcome, "+loggedInUser : "";
      if (loggedInUser) { $("userBadge").textContent = "User: " + loggedInUser; }
      setTimeout(()=>{
        showPage("page2");
        playDoubleBeep(); // two beeps before begin
        // QR code generation removed for Page 2
      },600);
    } else {
      $("status").textContent="❌ Invalid";
      $("pin").value="";
    }
  }catch{
    $("status").textContent="❌ Network error";
  } finally { pinSubmitting=false; }
}

bindKeypad('#keypad .key', (btn)=>{
  const act=btn.dataset.act;
  if(act==="clear"){ $("pin").value=""; return; }
  if(/^\d$/.test(btn.textContent)){
    if($("pin").value.length<4){
      $("pin").value += btn.textContent;
      if($("pin").value.length===4){ validatePin($("pin").value.trim()); }
    }
  }
});

/* ---------- Page 2: Begin (instant) ---------- */
$("beginBtn").addEventListener("click", ()=>{
  playBeep(900,140,0.25);

  // Instant navigation to page 3
  showPage("page3");
  $("auditMsg").textContent = "Audit in progress — you can now begin scanning items for the audit.";
  $("auditVisual").style.display = "block";
  $("qrCodeAudit").innerHTML="";

  // Fetch items in the background
  callFlow("listItems")
    .then(items=>{ itemsData = Array.isArray(items)? items : []; dbg("Fetched items:", itemsData.length); })
    .catch(err=>{ dbg("Error fetching items:", err); });

  // Keep existing 30s transition to upload page
  setTimeout(()=>{ showUploadPage(); },30000);
});

/* ---------- Page 3: DONE (still supported if scanner sends DONE) ---------- */
$("hiddenScanner3").addEventListener("keydown", e=>{
  if(e.key==="Enter" && e.target.value.trim().toUpperCase()==="DONE"){
    e.target.value="";
    showUploadPage();
  }
});

/* ---------- Page 4: Upload ---------- */
function showUploadPage(){
  showPage("page4");
  $("uploadQr").innerHTML="";
  new QRCode("uploadQr",{text:"^&032&^",width:240,height:240});
  $("visibleBulkInput").value="";
  capturedScans.clear();
  hasUploadInput=false;
  if(uploadTimer){clearTimeout(uploadTimer); uploadTimer=null;}
  renderScanCount();
}

function renderScanCount(){
  $("scanCount").textContent = capturedScans.size
    ? `${capturedScans.size} scan${capturedScans.size===1?"":"s"} captured`
    : "No scans captured yet.";
}

/* capture scans offline & debounce upload */
$("visibleBulkInput").addEventListener("input", e=>{
  if(e.data?.includes("\n") || e.inputType==="insertLineBreak"){
    addMany(e.target.value);
    e.target.value="";
  }
});
$("visibleBulkInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addMany(e.target.value);
    e.target.value="";
  }
});

function addMany(text){
  const before=capturedScans.size;
  (text.match(/\d{10}/g)||[]).forEach(c=>capturedScans.add(c));
  renderScanCount();
  if(capturedScans.size>before){
    hasUploadInput=true;
    scheduleAutoUpload();
  }
}
function scheduleAutoUpload(){
  if(!hasUploadInput) return;
  if(uploadTimer) clearTimeout(uploadTimer);
  uploadTimer=setTimeout(()=>{ doUpload(); },2000); // keep 2s no-input debounce
}

/* --- 0–100% progress ring helpers (7s) --- */
let _progressTimer=null, _progressStart=0, _progressCircumference=0;
function startProgress(durationMs=7000){
  const circle = document.querySelector('.progress-ring__circle');
  const percentLabel = $("progressPercent");
  if(!circle || !percentLabel) return;
  const radius = circle.r.baseVal.value;
  _progressCircumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = `${_progressCircumference} ${_progressCircumference}`;
  circle.style.strokeDashoffset = `${_progressCircumference}`;
  _progressStart = performance.now();
  $("progressAnim").style.display = "flex";
  cancelAnimationFrame(_progressTimer);
  const tick = (now)=>{
    const elapsed = now - _progressStart;
    const p = Math.min(1, elapsed / durationMs);
    const offset = _progressCircumference * (1 - p);
    circle.style.strokeDashoffset = `${offset}`;
    percentLabel.textContent = `${Math.round(p*100)}%`;
    if(p < 1){ _progressTimer = requestAnimationFrame(tick); }
  };
  _progressTimer = requestAnimationFrame(tick);
}
function stopProgress(){
  cancelAnimationFrame(_progressTimer);
  const circle = document.querySelector('.progress-ring__circle');
  const percentLabel = $("progressPercent");
  if(circle){ circle.style.strokeDashoffset = 0; }
  if(percentLabel){ percentLabel.textContent = '100%'; }
}

/* auto-upload */
async function doUpload(){
  if (isUploading || !capturedScans.size) return;
  isUploading=true;

  // start 7s visual progress (purely visual; server timing can vary)
  startProgress(7000);
  $("progressText").textContent = "Uploading…";
  $("progressAnim").style.display = "flex";

  const checksPayload = [...capturedScans].map(scanId => {
    const match = itemsData.find(item => String(item.ItemID) === scanId) || {};
    return {
      ScanID: "SCAN-" + scanId,
      ItemID: scanId,
      ItemName: match.ItemName || "Unknown",
      Room: match.Room || "Unknown",
      CheckType: "Audit",
      CheckValue: "Checked"
    };
  });

  const payload = {
    SessionID: "SESSION-" + Date.now(),
    StaffName: "PIN User",
    SubmittedAt: new Date().toISOString(),
    Comment: "Scans submitted via portal",
    Checks: checksPayload
  };

  try {
    const res = await callFlow("submitScan", payload);
    if (res?.status === "success") {
      renderResultTable();
      showPage("page5");
    } else {
      dbg("Upload error:", res);
      alert("Error submitting scans.");
    }
  } catch (err) {
    dbg("Upload exception:", err);
    alert("Upload failed.");
  } finally {
    stopProgress();
    $("progressAnim").style.display = "none";
    isUploading=false;
  }
}

function renderResultTable(){
  const rows = [...capturedScans].map(id=>{
    const item = itemsData.find(x=>String(x.ItemID)===id) || {};
    return `<tr><td>${id}</td><td>${item.Room||''}</td></tr>`;
  }).join("");
  const table = `
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr><th style="border:1px solid #444;padding:8px;background:#eee;color:#000">Item ID</th>
            <th style="border:1px solid #444;padding:8px;background:#eee;color:#000">Room</th></tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>`;
  $("resultTable").innerHTML = table;
}

/* ---------- keep focus on inputs ---------- */
setInterval(()=>{
  ["hiddenScanner3","visibleBulkInput"].forEach(id=>{
    $(id)?.focus();
  });
},500);

/* + modal logic */
$("plusBtn").onclick = async () => {
  $("modalMsg").textContent = "";
  $("pin1").value = $("pin2").value = "";
  $("userSel").innerHTML = "<option>Loading…</option>";
  $("modal").style.display = "flex";

  window._modalActive = "pin1";
  $("pin1").focus();

  try {
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "getUsersWithoutPins" })
    });
    const d = await r.json();
    $("userSel").innerHTML = d.status === "success"
      ? d.users.map(u => `<option>${u.Name}</option>`).join("")
      : "<option>❌ Couldn't load users</option>";
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};

$("cancel").onclick = () => $("modal").style.display = "none";

/* Modal keypad-only entry */
["pin1","pin2"].forEach(id=>{
  $(id).addEventListener("keydown", e=> e.preventDefault());
  $(id).addEventListener("input",  e=> e.preventDefault());
  $(id).addEventListener("click",  ()=> window._modalActive = id);
});
bindKeypad('#modalKeypad .key', (btn)=>{
  const targetId = window._modalActive || 'pin1';
  const el = $(targetId);
  const act = btn.dataset.act;
  if (!el) return;
  if (act === 'clear') { el.value = ''; return; }
  if (act === 'del')   { el.value = el.value.slice(0,-1); return; }
  if (el.value.length < 4 && /^\d$/.test(btn.textContent)) {
    el.value += btn.textContent;
  }
});

/* Save with pre-check */
$("save").onclick = async () => {
  playBeep();
  const name = $("userSel").value;
  const p1 = $("pin1").value.trim(), p2 = $("pin2").value.trim();
  if (p1 !== p2 || p1.length !== 4 || isNaN(p1)) {
    $("modalMsg").textContent = "Pins must match & be 4 digits";
    return;
  }
  $("modalMsg").textContent = "Checking…";
  try {
    const chk = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "validatePin", pin: p1 })
    });
    const chkData = await chk.json();
    if (chkData && chkData.status === "success") {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
      return;
    }
    $("modalMsg").textContent = "Saving…";
    const r = await fetch(FLOW, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "addPin", name, pin: p1 })
    });
    const d = await r.json();
    const taken =
      (d && d.error === "PinAlreadyExists") ||
      (d && d.message && /already\\s*(taken|exists)/i.test(String(d.message)));
    if (d && d.status === "success") {
      $("modalMsg").textContent = "✅ Saved";
      setTimeout(() => { $("modal").style.display = "none"; }, 1000);
    } else if (taken || r.status === 409) {
      $("modalMsg").textContent = "❌ That PIN is already taken.";
    } else {
      $("modalMsg").textContent = "❌ Error";
    }
  } catch (e) {
    $("modalMsg").textContent = "Network error";
  }
};

/* generic button sounds */
["plusBtn","save","cancel"].forEach(id=>{
  const el=$(id);
  if(el){ el.addEventListener('pointerdown', ()=>playBeep()); }
});
</script>

</body>
</html>
