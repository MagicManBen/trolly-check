<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CQC – Debug Uploader (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      --bg:#0e0f11; --panel:#181a1e; --muted:#9aa0a6; --text:#e8eaed;
      --line:#272a30; --accent:#22c55e; --danger:#ef4444; --ok:#22c55e;
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ padding:18px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; }
    .panel{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .left{ width:min(360px, 95vw) }
    .right{ flex:1; min-width:min(520px, 95vw) }
    h1,h2,h3{ margin:0 0 10px }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{ border:1px solid var(--line); background:#2a2f36; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--accent); color:#04130a; border-color:transparent; font-weight:600 }
    input, textarea, select{ background:#0f1216; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:8px 10px; }
    textarea{ width:100%; min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre-wrap; }
    .codebox{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#0f1216; max-height:280px; overflow:auto }
    .hr{ border-top:1px solid var(--line); margin:14px 0 }
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:14px }
    .pill{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:#1e232b; padding:6px 10px; border-radius:999px; font-size:12px }
    .ok{ color:var(--ok) } .err{ color:var(--danger) }
    .kbd{ background:#111317; padding:2px 6px; border-radius:6px; border:1px solid var(--line); font-family:ui-monospace,Menlo,monospace; font-size:12px }
  </style>

  <!-- Supabase v2 UMD (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<div class="wrap">
  <!-- Left column: QR + controls -->
  <div class="panel left">
    <h2>Upload from Scanner</h2>
    <p class="muted">On the handheld, scan this QR to upload stored scans, then point it at this iPad and press the trigger once.</p>
    <div id="qr" style="display:flex; justify-content:center; margin:8px 0 10px"></div>

    <div class="row" style="margin-top:8px">
      <label for="siteId" class="muted">Site ID</label>
      <input id="siteId" type="number" value="1" style="width:90px">
      <button class="btn" id="btnFocus">Focus input</button>
      <button class="btn" id="btnClear">Clear captures</button>
      <label class="pill"><input id="autoLookup" type="checkbox" checked style="accent-color:#22c55e"> auto-lookup</label>
    </div>

    <div class="hr"></div>
    <div class="row"><span class="pill">Captured: <strong id="capCount">0</strong></span><span class="pill">Unique IDs: <strong id="uniqCount">0</strong></span></div>
    <p class="muted" style="margin:8px 0 0">Scanner tips: it types digits then sends <span class="kbd">Enter</span>. This page listens to a hidden input.</p>

    <!-- Hidden input to capture keyboard-wedge scans -->
    <input id="hid" autocomplete="off" autocapitalize="off" spellcheck="false"
           style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
  </div>

  <!-- Right column: debug output -->
  <div class="panel right">
    <h2>Debug Output</h2>

    <div class="row" style="margin:6px 0 10px">
      <span class="pill">Supabase: <span id="sbStatus" class="ok">not tested</span></span>
      <span class="pill">Last lookup: <span id="lastMs">–</span> ms</span>
      <button class="btn primary" id="btnLookup">Run lookup now</button>
    </div>

    <div class="hr"></div>

    <h3>Client State</h3>
    <div id="stateBox" class="codebox mono"></div>

    <div class="hr"></div>

    <h3>Supabase Request (what we send)</h3>
    <div id="reqBox" class="codebox mono"></div>

    <div class="hr"></div>

    <h3>Supabase Response (raw)</h3>
    <div id="resBox" class="codebox mono"></div>

    <div class="hr"></div>

    <h3>Match Results</h3>
    <table>
      <thead><tr><th>Scanned ID</th><th>Status</th><th>Name</th><th>Room</th></tr></thead>
      <tbody id="matchBody"></tbody>
    </table>

    <div class="hr"></div>

    <h3>Copy Everything</h3>
    <div class="row" style="margin:6px 0 10px">
      <button class="btn" id="btnRefreshBundle">Refresh</button>
      <button class="btn primary" id="btnCopyBundle">Copy all debug</button>
    </div>
    <textarea id="bundleBox" class="mono" style="width:100%; min-height:220px; background:#0f1216; border:1px solid var(--line); border-radius:10px; padding:10px;"></textarea>
  </div>
</div>

<script>
  // --- Supabase client (v2 UMD) ---
  const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // CDN global per docs. 
  // (Docs: createClient via CDN; filters like .eq() / .in()).

  // --- State ---
  const S = {
    scansRaw: [],         // every line captured (including noise)
    codes: new Set(),     // only valid 10-digit IDs
    lastReq: null,
    lastRes: null,
    lastMs: null,
  };

  // --- Helpers ---
  const $ = (id)=>document.getElementById(id);
  const pretty = (o)=>{ try { return JSON.stringify(o, null, 2); } catch(e){ return String(o); } };
  const updateCounts = ()=>{
    $('capCount').textContent = String(S.scansRaw.length);
    $('uniqCount').textContent = String(S.codes.size);
  };
  const renderState = ()=>{
    $('stateBox').textContent = pretty({
      time: new Date().toISOString(),
      siteId: Number($('siteId').value || 1),
      scansRaw: S.scansRaw.slice(-20),   // show last 20 lines
      uniqueCodes: Array.from(S.codes),
      autoLookup: $('autoLookup').checked
    });
  };
  const renderReq = ()=>{ $('reqBox').textContent = pretty(S.lastReq || '(no request yet)'); };
  const renderRes = ()=>{ $('resBox').textContent = pretty(S.lastRes || '(no response yet)'); };

  function renderMatches(rows){
    const tb = $('matchBody');
    tb.innerHTML = '';
    const byId = new Map((rows || []).map(r => [String(r.item_id).trim(), r]));
    for(const code of S.codes){
      const it = byId.get(code);
      const tr = document.createElement('tr');
      const st = it ? '✅ Found' : '❌ Missing';
      tr.innerHTML = `<td class="mono">${code}</td>
                      <td>${st}</td>
                      <td>${it ? it.item_name : ''}</td>
                      <td>${it ? it.room : ''}</td>`;
      tb.appendChild(tr);
    }
  }

  function buildMatchesArray(){
    const rows = (S.lastRes && S.lastRes.rows) ? S.lastRes.rows : [];
    const byId = new Map((rows || []).map(r => [String(r.item_id).trim(), r]));
    return Array.from(S.codes).map(code => {
      const it = byId.get(code) || null;
      return {
        code,
        found: !!it,
        name: it ? it.item_name : null,
        room: it ? it.room : null,
      };
    });
  }

  function buildBundle(){
    const siteId = Number($('siteId').value || 1);
    const uniqueCodes = Array.from(S.codes);
    const invalidLast20 = S.scansRaw.slice(-20).filter(v => !/^\d{10}$/.test(v));
    return {
      meta: {
        time: new Date().toISOString(),
        location: window.location.href,
        userAgent: navigator.userAgent,
      },
      supabase: {
        url: SUPABASE_URL,
        anonKeyPresent: !!SUPABASE_ANON_KEY,
        siteId,
        qrUploadValue: '^&032&^',
      },
      state: {
        capturedCount: S.scansRaw.length,
        uniqueCount: S.codes.size,
        scansRawLast20: S.scansRaw.slice(-20),
        uniqueCodes,
        invalidLast20,
      },
      request: S.lastReq,
      response: S.lastRes,
      timing: { lastMs: S.lastMs },
      matches: buildMatchesArray(),
    };
  }

  function updateBundle(){
    const box = $('bundleBox'); if(!box) return;
    try { box.value = JSON.stringify(buildBundle(), null, 2); }
    catch(e){ box.value = String(e); }
  }

  // --- QR code: ^&032&^ (upload) ---
  function renderQRUpload(){
    const el = $('qr');
    el.innerHTML = '';
    // QRCode.js API per project docs
    new QRCode(el, { text: '^&032&^', width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
  }

  // --- Lookup (the exact query you use on Review) ---
  async function runLookup(){
    const siteId = Number($('siteId').value || 1);
    const codes = Array.from(S.codes).map(c => String(c).trim()); // ensure strings
    const postgrestIn = '(' + codes.join(',') + ')'; // mirrors working curl style
    const sbStatus = $('sbStatus');

    // Build request object for display
    S.lastReq = {
      table: 'items',
      select: ['item_id','item_name','room'],
      filters: { site_id: siteId, item_id_in: codes, postgrest_in: postgrestIn }
    };
    renderReq();

    if (!codes.length){
      S.lastRes = { ok:false, error:'No codes to lookup' };
      renderRes();
      renderMatches([]);
      updateBundle();
      return;
    }

    const t0 = performance.now();
    let data = null, error = null;
    try{
      const resp = await sb
        .from('items')
        .select('item_id, item_name, room')
        .eq('site_id', siteId)
        .in('item_id', codes); // use typed strings directly
      data = resp.data; error = resp.error || null;
    }catch(e){
      error = e;
    }
    const t1 = performance.now();
    S.lastMs = Math.round(t1 - t0);
    $('lastMs').textContent = String(S.lastMs);

    if (error){
      sbStatus.textContent = 'error';
      sbStatus.classList.remove('ok'); sbStatus.classList.add('err');
      S.lastRes = { ok:false, error };
      renderRes();
      renderMatches([]);
      updateBundle();
      return;
    }

    // If the client call returned 0 rows, try a raw fetch that exactly mirrors the working curl
    let altFetch = null;
    if (!data || !data.length){
      const rawUrl = `${SUPABASE_URL}/rest/v1/items?select=item_id,item_name,room&site_id=eq.${siteId}&item_id=in.(${codes.join(',')})`;
      try {
        const res = await fetch(rawUrl, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        const altRows = await res.json();
        altFetch = { url: rawUrl, status: res.status, returned: Array.isArray(altRows) ? altRows.length : null, rows: altRows };
        if (Array.isArray(altRows) && altRows.length) {
          data = altRows; // display alt result if it worked
        }
      } catch (e2) {
        altFetch = { url: rawUrl, error: String(e2) };
      }
    }

    sbStatus.textContent = 'ok';
    sbStatus.classList.add('ok'); sbStatus.classList.remove('err');
    S.lastRes = { ok:true, returned: data?.length ?? 0, rows: data || [], altFetch };
    renderRes();
    renderMatches(data || []);
    updateBundle();
  }

  // --- Capture scans from hidden input ---
  function focusInput(){ const el = $('hid'); el.value=''; el.focus(); }

  $('hid').addEventListener('keydown', (e)=>{
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const raw = e.target.value.trim();
    e.target.value = '';

    S.scansRaw.push(raw);
    // Accept exactly 10 digits as a valid code
    const m = raw.match(/^\d{10}$/);
    if (m) S.codes.add(m[0]);

    updateCounts();
    renderState();
    updateBundle();

    // Auto-lookup (debounced by a small timeout to batch quick bursts)
    if ($('autoLookup').checked){
      clearTimeout(runLookup._t); runLookup._t = setTimeout(runLookup, 150);
    }
  });

  // --- Buttons ---
  $('btnFocus').addEventListener('click', focusInput);
  $('btnLookup').addEventListener('click', runLookup);
  $('btnClear').addEventListener('click', ()=>{
    S.scansRaw = []; S.codes.clear();
    updateCounts(); renderState(); S.lastReq = null; S.lastRes = null; renderReq(); renderRes(); renderMatches([]);
    updateBundle();
    focusInput();
  });

  $('btnRefreshBundle').addEventListener('click', updateBundle);
  $('btnCopyBundle').addEventListener('click', async ()=>{
    const box = $('bundleBox'); if(!box) return;
    try {
      await navigator.clipboard.writeText(box.value);
      alert('Copied debug bundle to clipboard');
    } catch(err){
      box.select();
      document.execCommand('copy');
      alert('Copied (fallback)');
    }
  });

  // --- Init ---
  renderQRUpload();
  focusInput();
  updateCounts();
  renderState();
  renderReq();
  renderRes();
  updateBundle();
</script>
</body>
</html>